<form editionMode="dialog" entity-schema="nms:delivery" entitySchema="xtk:form" img="xtk:form.png"
      label="配信" maxLabelWidth="50" md5="290C05052D4A9F448160DCA73E351308" name="delivery"
      namespace="nms" readOnlyExpr="[/tmp/@readOnly]" xpathsToLoad="@mapping-id,desc,@folder-id,@folderProcess-id,@internalName,@state,         @isModel,content/*,targets/*,targets/fileFormat/*,         targets/deliveryFile/*,targets/proofFile/*,forecast/*,         advancedParameters/*,scheduling/*,scenario/*,execution/*,output/*,         tracking/*,properties/@deliveryState,properties/@toDeliver,         properties/@midRemoteId,properties/@midAccountUsedName,         properties/@midAccountUsedCs,properties/@FCPid,properties/@FCPLastNum,         @deliveryProvider-id,typology,typology/@id,typology/@IPAffinity,         @typology-id,fcpParameters/*,FCPSeed/*,variables/*,folder,folder/@id,         folderProcess,folderProcess/@id,mapping/*,deliveryProvider,         deliveryProvider/@id,deliveryProvider/@messageType,         deliveryProvider/@deliveryMode,deliveryProvider/@account,         deliveryProvider/@mobileConnector,deliveryProvider/@active,         deliveryProvider/@label,deliveryProvider/@connectorUrl,mailParameters/*,ruleFilter/*,typologyFilter/*,         output/*,output/extraction/source/select/*,@deliveryCode,@mirrorURL,         @priority,@contentModTime,@useDce,@useAEM,@contentEditingMode"
      xpathsToLoadOpt="@coupon-id,coupon,coupon/@id,coupon/@code,coupon/@type,         measure/*,validation/*,@maxPropositionCount,@offerThemes,offerCategory,         offerCategory/@id,@offerCategory-id,offerAnonymousCategory,offerAnonymousCategory/@id,@offerAnonymousCategory-id,@useTargetOffers,@offerSpace-id,         offerSpace,offerSpace/@id,offerSpace/@disablePropositionStorage,offerSpace/env/@id,offerSpace/@anonymousFallback,         offerSpace/env/@propositionSchema,offerSpace/representationFields/*,         offerSpace/rendering/@useHtmlFunction,offerSpace/rendering/@useTextFunction,         deliveryOutline/@label,         deliveryOutline/dlvOutlineItem/*,operation/@id,         operation/@linkedOperation-id,         operation/parameter/@useLinkedDeliveryValidation,operation/@owner-id,         @operation-id,operation/parameter/@useMeasure,hypothesis/*,         operation/parameter/@useBudget,operation/parameter/@useLandingPage,operation/parameter/@useValidation,         supplier/@deliveryModel-id,@targetAssignee-id,targetAssignee,         @contentAssignee-id,contentAssignee,@budgetAssignee-id,budgetAssignee,         @extractionAssignee-id,extractionAssignee,budgetParameters/*,         seedMember/*,output/seedList/*,publishing,outlineRuleFilter/*,         outlineTypologyFilter/*,volume/*,volume/rule/*,@targetStatus,         @contentStatus,@budgetStatus,@extractionStatus,@sandboxStatus,         smsParameters/*,@workflow-id,@linkedDelivery-id,linkedDelivery/*,         @landingPage-id,landingPage/*,document/*,linkedDelivery/mapping/*,triggerMessage/*,         @webAnalyticsAccount-id,webAnalyticsAccount/*,webAnalytics/*,@cmsAccount-id,cmsAccount/*,remoteContent/*,         @currentOrderId,deliveryProvider/lineService/@id,@acsSourceId,@recurringDelivery-id"
      xtkschema="xtk:form">

    <!--[of]:    Enter-->
  <enter>
    <if expr="HasPackage('nms:campaign')">
      <if expr="[@operation-id]!=0 and ([operation/parameter/@useBudget]=='' and [operation/parameter/@useValidation]=='')">
        <set value="nms:operation" xpath="/ignored/queryDefInit/@schema"/>
        <set value="get" xpath="/ignored/queryDefInit/@operation"/>
        <set value="[parameter/@useBudget]" xpath="/ignored/queryDefInit/select/node[1]/@expr"/>
        <set value="[parameter/@useValidation]" xpath="/ignored/queryDefInit/select/node[2]/@expr"/>
        <set expr="'@id='+[@operation-id]" xpath="/ignored/queryDefInit/where/condition/@expr"/>
        <soapCall name="ExecuteQuery" service="xtk:queryDef">
          <param exprIn="[/ignored/queryDefInit]" type="DOMDocument"/>
          <param type="DOMDocument" xpathOut="/ignored/tmp/operationQuery"/>
        </soapCall>
        <set expr="[/ignored/tmp/operationQuery/parameter/@useBudget]" xpath="/ignored/tmp/parameter/@useBudget"/>
        <set expr="[/ignored/tmp/operationQuery/parameter/@useValidation]" xpath="/ignored/tmp/parameter/@useValidation"/>
      </if>
    </if>

    <if expr="[/delivery/mapping/@id]=0 AND [@mapping-id]!=0 AND [@mapping-id]!=''">
      <set value="nms:deliveryMapping" xpath="/ignored/queryDefMapping/@schema"/>
      <set value="get" xpath="/ignored/queryDefMapping/@operation"/>
      <set value="[@id]" xpath="/ignored/queryDefMapping/select/node[1]/@expr"/>
      <set value="@name" xpath="/ignored/queryDefMapping/select/node[2]/@expr"/>
      <set value="@label" xpath="/ignored/queryDefMapping/select/node[3]/@expr"/>
      <set value="@schema" xpath="/ignored/queryDefMapping/select/node[4]/@expr"/>
      <set value="@email" xpath="/ignored/queryDefMapping/select/node[5]/@expr"/>
      <set value="@fax" xpath="/ignored/queryDefMapping/select/node[6]/@expr"/>
      <set value="@sms" xpath="/ignored/queryDefMapping/select/node[7]/@expr"/>
      <set value="@paper" xpath="/ignored/queryDefMapping/select/node[8]/@expr"/>
      <set value="@phone" xpath="/ignored/queryDefMapping/select/node[9]/@expr"/>
      <set value="@agency" xpath="/ignored/queryDefMapping/select/node[10]/@expr"/>
      <set value="@format" xpath="/ignored/queryDefMapping/select/node[11]/@expr"/>
      <set value="@blackListEmail" xpath="/ignored/queryDefMapping/select/node[12]/@expr"/>
      <set value="@blackListSms" xpath="/ignored/queryDefMapping/select/node[13]/@expr"/>
      <set value="@blackListPhone" xpath="/ignored/queryDefMapping/select/node[14]/@expr"/>
      <set value="@blackListFax" xpath="/ignored/queryDefMapping/select/node[15]/@expr"/>
      <set value="@blackListPaper" xpath="/ignored/queryDefMapping/select/node[16]/@expr"/>
      <set value="@blackListAgency" xpath="/ignored/queryDefMapping/select/node[17]/@expr"/>
      <set value="@externalId" xpath="/ignored/queryDefMapping/select/node[18]/@expr"/>
      <set value="@recipientLink" xpath="/ignored/queryDefMapping/select/node[19]/@expr"/>
      <set value="@targetSchema" xpath="/ignored/queryDefMapping/select/node[20]/@expr"/>
      <set value="@countryCode" xpath="/ignored/queryDefMapping/select/node[21]/@expr"/>
      <set value="[storage/@broadLogSchema]" xpath="/ignored/queryDefMapping/select/node[22]/@expr"/>
      <set value="[storage/@exclusionType]" xpath="/ignored/queryDefMapping/select/node[23]/@expr"/>
      <set value="[storage/@broadLogExclSchema]" xpath="/ignored/queryDefMapping/select/node[24]/@expr"/>
      <set value="[storage/@trackingLogSchema]" xpath="/ignored/queryDefMapping/select/node[25]/@expr"/>
      <set value="[storage/extraField/@dstXPath]" xpath="/ignored/queryDefMapping/select/node[26]/@expr"/>
      <set value="[storage/extraField/@srcExpr]" xpath="/ignored/queryDefMapping/select/node[27]/@expr"/>
      <set value="[.]" xpath="/ignored/queryDefMapping/select/node[28]/@expr"/>
      <set value="@_cs" xpath="/ignored/queryDefMapping/select/node[28]/@alias"/>
      <if expr="HasPackage('nms:lineV2')">
        <set value="@line" xpath="/ignored/queryDefMapping/select/node[29]/@expr"/>
        <set value="@blackListLine" xpath="/ignored/queryDefMapping/select/node[30]/@expr"/>
      </if>
      <set expr="'@id=' + [@mapping-id]" xpath="/ignored/queryDefMapping/where/condition/@expr"/>
      <soapCall name="ExecuteQuery" service="xtk:queryDef">
        <param exprIn="[/ignored/queryDefMapping]" type="DOMDocument"/>
        <param type="DOMDocument" xpathOut="mapping"/>
      </soapCall>
    </if>
    <set value="false" xpath="/ignored/@limitEdition"/>
    <set value="delivery-id" xpath="/tmp/@seedListKey"/>
    <set value="nms:delivery" xpath="/ignored/@schema"/>
    <set expr="[scheduling/@extraction]" xpath="/ignored/@extraction"/>
    <set value="0" xpath="/ignored/@hasParentDelivery"/>
      <!-- /ignored/@operationId may be inherited from its parent, except if no parent -->
    <if expr="[/ignored/@operationId]=''">
      <set value="0" xpath="/ignored/@operationId"/>
    </if>
    <if expr="HasPackage('nms:campaign')">
      <set expr="[@workflow-id]" xpath="/ignored/@workflow-id"/>
      <set expr="[@budget-id]" xpath="/ignored/@budgetId"/>
      <set expr="[budgetParameters/@estimatedCost]" xpath="/ignored/@estimatedCost"/>
      <set expr="[budgetParameters/@realCost]" xpath="/ignored/@realCost"/>
      <set expr="[budgetParameters/@commitmentLevel]" xpath="/ignored/@commitmentLevel"/>
      <set value="false" xpath="/ignored/@calculateBudget"/>
      <set expr="[/ignored/tmp/parameter/@useValidation] or [operation/parameter/@useValidation]"
           xpath="/ignored/@useValidation"/>
      <set expr="iif ([/ignored/tmp/@linkedOperation-id] != '', [/ignored/tmp/@linkedOperation-id], [operation/@linkedOperation-id])"
           xpath="/ignored/@linkedOperation-id"/>
      <set expr="@isModel" xpath="/ignored/@isModel"/> <!-- use only to share condition with delivery/task -->
      <set expr="Iif([@linkedDelivery-id]!=0, 1, 0)" xpath="/ignored/@hasParentDelivery"/>
      <set value="0" xpath="/ignored/@addFilterRule"/>
      <set value="0" xpath="/ignored/@addReminder"/>

        <!-- use to show/hide linklist -->
      <set value="1" xpath="/ignored/@nbRemaCalculationLines"/>

      <if expr="HasPackage('nms:response')">
        <set expr="[/ignored/tmp/parameter/@useMeasure] or [operation/parameter/@useMeasure]"
             xpath="/ignored/@useMeasure"/>
        <set expr="[budgetParameters/@totalMargin]" xpath="/ignored/@totalMargin"/>
        <set expr="[budgetParameters/@totalRealized]" xpath="/ignored/@totalRealized"/>
      </if>

      <if expr="[validation/@assignEdition] and HasNamedRight('admin')=false">
          <!-- check if operator is a designer (for limitation interface access) -->
        <soapCall name="CheckValidationAccess" service="nms:operation">
          <param exprIn="validation" type="DOMElement"/>
          <param exprIn="[operation/@owner-id]" type="int"/>
          <param exprIn="6" type="byte"/> <!-- validation type available -->
          <param type="boolean" xpathOut="/ignored/@limitEdition"/>
        </soapCall>
      </if>
    </if>
    <if expr="HasPackage('nms:coreInteraction')">
      <set expr="AddOfferViewToBLogSchema([offerSpace/env/@propositionSchema], 'nms:offerView')"
           xpath="/ignored/@offerViewSchema"/>
      <copyElement xpathDst="/ignored/offerSpace" xpathSrc="/delivery/offerSpace"/>
    </if>
    <if expr="HasPackage('ncm:content')">
      <set expr="[@publishing-name]!='' and [@publishing-namespace]!=''" xpath="/ignored/@hasContent"/>
    </if>

    <if expr="[smsParameters/smsContent]!=''">
      <set expr="[smsParameters/smsContent]" xpath="content/sms/source"/>
      <set value="" xpath="smsParameters/smsContent"/>
    </if>

      <!-- build email target summary -->
    <set translatedExpr="'アップストリームターゲティングによる母集団'" xpath="/ignored/@strPopFromWkf"/>
    <set translatedExpr="'ファイルから設定'" xpath="/ignored/@strPopFromFile"/>
    <set translatedExpr="'母集団が未定義です'" xpath="/ignored/@strPopEmpty"/>

    <set translatedExpr="'分析中に計算済み...'" xpath="/ignored/@strSimulation"/>
    <set translatedExpr="'暫定分析'" xpath="/ignored/@strForecast"/>
    <set translatedExpr="'配達確認を送信'" xpath="/ignored/@strFCP"/>
    <set translatedExpr="'メインターゲットに送信'" xpath="/ignored/@strSend"/>

      <!-- For customize buttons with fixed schemas -->
    <set value="nms:delivery" xpath="/tmp/schema/@delivery"/>
    <set value="nms:extAccount" xpath="/tmp/schema/@provider"/>
    <set value="nms:coupon" xpath="/tmp/schema/@coupon"/>

    <set expr="Iif([@mapping-id]==0, 'nms:broadLogMid', [mapping/storage/@broadLogSchema])"
         xpath="/ignored/@dynamicLinkListSchema"/>
    <set expr="Iif([mapping/@name]='mapEventHisto', 'nms:eventHisto', [mapping/@targetSchema])"
         xpath="/ignored/@dynamicLinkListObjectSchema"/>
    <set expr="Iif([mapping/@name]='mapEventHisto', 'nms:eventHistoPreview', Iif([mapping/@name]='mapRtEvent', 'nms:rtEventPreview', Iif([mapping/@name]='mapBatchEvent', 'nms:batchEventPreview', '')))"
         xpath="/ignored/@dynamicLinkListObjectForm"/>
      <!-- use to force to refresh automotically label of document -->
    <set value="true" xpath="/ignored/@fileNameEraseLabel"/>
    <if expr="[/ignored/tmp/@targetExtension]!=''">
      <set expr="[/ignored/tmp/@targetExtension]" xpath="@_targetExtensionSchema"/>
    </if>

      <!-- Define delivery from message center -->
    <if expr="HasPackage('nms:messageCenter')">
      <set expr="iif (EV([triggerMessage/@publicationStatus], 'notApplicable')=false, 1, 0)"
           xpath="/ignored/@triggerMessage"/>
      <set expr="iif ([/ignored/@triggerMessage]=0 or NodeCount(FCPSeed)&gt;1, 1, 0)"
           xpath="/ignored/@showAllSeedMembers"/>
      <if expr="[/ignored/@triggerMessage]">
        <set expr="@messageType" xpath="/ignored/@messageType"/><!-- for seed -->
          <!-- Add the default seed if it does not exist (should have been created by newDelivery though) -->
        <if expr="NodeCount(FCPSeed)=0">
          <set translatedExpr="'新規'" xpath="FCPSeed/@label"/>
          <set expr="GetOption('XtkInstancePrefix')+'SDM'+CounterValue('nmsSeedMember')"
               xpath="FCPSeed/@internalName"/>
          <set value=" " xpath="FCPSeed/custom_nms_rtEvent/ctx"/>
          <set expr="@id" xpath="FCPSeed/@proof-id"/>
        </if>
      </if>
    </if>
    <if expr="HasPackage('nms:social')">
      <set expr="iif (EV(@messageType, 'facebook', 'twitter'), 1, 0)" xpath="/ignored/@socialMessage"/>
      <set expr="iif (EV(@messageType, 'facebook'), 1, 0)" xpath="/ignored/@facebookMessage"/>
    </if>
    <if expr="HasPackage('nms:mobileApp')">
      <set expr="iif(EV(@messageType, 'ios', 'android'), 1, 0)" xpath="/ignored/@pushMessage"/>
    </if>
    <if expr="HasPackage('nms:line') OR HasPackage('nms:lineV2')">
      <set expr="iif (EV(@messageType, 'line'), 1, 0)" xpath="/ignored/@lineMessage"/>
    </if>

    <set expr="[targets/deliveryTarget/@serialization]" xpath="/ignored/deliveryTargetSerialization"/>
    <set expr="[targets/proofTarget/@serialization]" xpath="/ignored/proofTargetSerialization"/>
      <!-- display or hide tracking -->
    <set value="true" xpath="/ignored/@showTracking"/>
    <if expr="HasPackage('nms:webAnalytics')">
      <if expr="[@webAnalyticsAccount-id]!=0">
        <set value="false" xpath="/ignored/@showTracking"/>
      </if>
    </if>
    <if expr="[scheduling/@contactDate]=''">
      <set expr="''" xpath="scheduling/@contactDate"/>
    </if>

    <if expr="HasPackage('nms:campaign')">
      <set expr="iif ([targets/@deliveryLimitExpr]!='', true, false)" xpath="/tmp/@hasDeliveryLimitExpr"/>
      <set expr="iif ([scheduling/@contactDateExpr] != '' or [scheduling/@extractionExpr] != '', true, false)"
           xpath="/tmp/@hasDateExpr"/>
    </if>
    <if expr="HasPackage('nms:campaign')">
      <set expr="[@operation-id]!=0 AND  NodeCount([deliveryOutline/dlvOutlineItem/offer])&gt;0"
           xpath="/ignored/@hasDlvOutlineOffers"/>
    </if>

    <if expr="HasPackage('nms:mobileApp')">
      <reset xpath="/tmp/notificationCustomFields"/>
      <reset xpath="/tmp/notificationSounds"/>
      <set expr="EndWith([deliveryProvider/@connectorUrl],'iosHTTP2.jsp')" xpath="/ignored/@isIOSHTTP2"/>
      <if expr="NodeExists([content/iosCustomFields/source]) OR NodeExists([content/androidCustomFields/source])">
          <!-- Init with values from previous configuration (key/value pairs) -->
        <copyElement exprSrc="'content/' + Iif(@messageType=41, 'ios', 'android') + 'CustomFields/source'"
                     xpathDst="/tmp/notificationCustomFields"/>
      </if>

      <if expr="NodeExists([content/iosAvailableSounds/source]) OR NodeExists([content/androidAvailableSounds/source])">
          <!-- Init with values from previous configuration (key/value pairs) -->
        <copyElement exprSrc="'content/' + Iif(@messageType=41, 'ios', 'android') + 'AvailableSounds/source'"
                     xpathDst="/tmp/notificationSounds"/>
      </if>
    </if>

      <!--added for Line multi-message-->
    <if expr="HasPackage('nms:lineV2')">
      <reset xpath="/tmp/lineCustomFields"/>
      <if expr="NodeExists([/delivery/content/lineCustomFields/source])">
          <!-- Init with values from previous configuration (key/value pairs) -->
        <copyElement exprSrc="'/delivery/content/lineCustomFields/source'" xpathDst="/tmp/lineCustomFields"/>
      </if>
    </if>
      <!--Line multi-message ends here-->

      <!-- Duplicate @contentEditingMode expression from schema for duplication -->
    <set expr="Iif(@useDce, 1, Iif(HasPackage('nms:aemIntegration') and @useAEM, 2, 0))"
         xpath="/delivery/@contentEditingMode"/>
    <set expr="'false'" xpath="/ignored/@isAEMContent"/>
    <set expr="'false'" xpath="/ignored/@isLinkedToContent"/>
    <if expr="HasPackage('nms:aemIntegration')">
      <set expr="Iif([/delivery/@contentEditingMode]=2, 'true', 'false')" xpath="/ignored/@isAEMContent"/>
      <set expr="Iif([/delivery/@contentEditingMode]=2 and [remoteContent/@remotePath] != '', 'true', 'false')"
           xpath="/ignored/@isLinkedToContent"/>
    </if>
    <if expr="HasPackage('nms:acsProvisioning')">
      <set expr="Iif([/delivery/@acsSourceId]!=0, true, false)" xpath="/ignored/@isACSConnector"/>
    </if>

  </enter>
    <!--[cf]-->
<!--[of]:MenuBuilder-->
  <container name="menuBuilder">
  <!-- the menu builder must be set only once for all customize buttons (set as a controller resource) -->
    <container menuId="deliveryMenuBuilder" name="deliveryMenuBuilder" type="deliveryMenuBuilder">
      <form label="ターゲットのフィールドの選択" name="selectTargetDlg" nothingToSave="true">
        <enter>
          <set expr="[/delivery/mapping/@schema]" xpath="/tmp/customSelect/@schema"/>
        </enter>
        <container showCollections="true" type="customizeSelect" xpath="/tmp/customSelect/@schema"
                   xpathName="@label" xpathOut="@cmd"/>
        <container type="visibleGroup" visibleIf="![/tmp/@isIncludeView]">
          <container ref="nms:delivery:lib/editTargetQuery"/>
        </container>
      </form>
      <form label="受信者のフィールドを選択" name="selectRecipientDlg" nothingToSave="true">
        <container showCollections="true" type="customizeSelect" xpath="/tmp/schema/@recipient"
                   xpathName="@label" xpathOut="@cmd"/>
        <container type="visibleGroup" visibleIf="![/tmp/@isIncludeView]">
        <!-- flag defined in includeView form -->
          <container ref="nms:delivery:lib/editRecipientQuery"/>
        </container>
      </form>
      <form label="配信のプロパティの選択" name="selectDeliveryDlg" nothingToSave="true">
        <container schema="nms:delivery" type="customizeSelect" xpathOut="@cmd"/>
      </form>
      <form label="ルーティングアカウントのプロパティを選択" name="selectProviderDlg" nothingToSave="true">
        <container objectName="provider" schema="nms:extAccount" type="customizeSelect"
                   xpathOut="@cmd"/>
      </form>
      <form colcount="2" label="バーコードを挿入" name="insertBarcode" nothingToSave="true"
            xpath="/tmp/barcode/">
        <enter>
          <set value="QRCode" xpath="/tmp/barcode/@type"/>
          <set value="1" xpath="/tmp/barcode/@scale"/>
          <set value="100" xpath="/tmp/barcode/@height"/>
          <set value="100" xpath="/tmp/barcode/@width"/>
          <set value="H" xpath="/tmp/barcode/@errCorr"/>
          <set value="23" xpath="/tmp/barcode/@errPercent"/>
          <set value="30" xpath="/tmp/barcode/@margin"/>
        </enter>
        <input colspan="2" enum="nms:common:barcodeType" label="タイプ" type="sysenum"
               xpath="@type"/>
        <input colspan="2" label="値" menuId="deliveryMenuBuilder" type="scriptEdit"
               xpath="@valueExpr"/>
        <container colcount="2" colspan="2" type="visibleGroup" visibleIf="@type!='QRCode' AND @type!='AZTEC'">
          <input enum="nms:common:barcodeScale" label="規模" type="sysenum" xpath="@scale"/>
          <input label="高さ" type="number" xpath="@height"/>
        </container>
        <container colcount="2" colspan="2" type="visibleGroup" visibleIf="@type='QRCode'">
          <input colspan="2" enum="nms:common:qrcodeErrCorr" label="エラーの修正" type="sysenum"
                 xpath="@errCorr"/>
          <input label="幅" type="number" xpath="@height"/>
          <input label="高さ" type="number" xpath="@width"/>
        </container>
        <container colcount="2" colspan="2" type="visibleGroup" visibleIf="@type='AZTEC'">
          <input desc="エラーの修正率" label="エラー修正 (%)" maxValue="95" minValue="5" type="number"
                 xpath="@errPercent"/>
          <input label="幅" minValue="0" type="number" xpath="@height"/>
          <input digitCount="2" label="規模" minValue="0" type="number" xpath="@scale"/>
          <input checkedValue="Binary" label="バイナリフォーマット" type="checkbox" unCheckedValue="UTF-8"
                 xpath="@encoding"/>
        </container>
      </form>
      <form colcount="1" label="Adobe Target が提供する画像を挿入" name="insertTargetImage"
            nothingToSave="true" xpath="/tmp/targetImage/">
        <input label="デフォルトの画像" required="true" type="string" xpath="@defaultUrl"/>
        <input applicableIf="HasPackage('nms:aemIntegration') OR (HasPackage('nms:macIntegration') and IsIMSLoggedIn())"
               img="xtk:upload.png" label="共有アセットを選択 " prebuildSubForm="false" type="subFormLink"
               visibleIf="@useAEM=1 OR HasPackage('nms:macIntegration')" xpath=".">
          <form disableExplicitSave="true" label="共有アセットを選択 " xpath=".">
            <input sessionToken="true" type="aemPicker" xpath="@defaultUrl"/>
          </form>
        </input>
        <input label="ターゲットの場所 (rawbox)" required="true" type="string" xpath="@rawMboxName"/>
        <input label="ランディングページ" required="false" type="string" xpath="@landingPage"/>
        <input label="ターゲットプロパティ" required="false" type="string" xpath="@targetProperty"/>
        <input label="追加の決定パラメーター" type="list" xpath="additionalparameters">
          <input label="名前" xpath="@label"/>
          <input label="選択" type="subFormLink" xpath="@value">
            <form name="selectTargetRecipient" nothingToSave="true">
              <container schema="nms:recipient" showCollections="true" type="customizeSelect"
                         xpathOut="."/>
            </form>
          </input>
        </input>
        <leave>
          <check expr="@defaultUrl!=''">
            <error>デフォルトの画像が指定されていません</error>
          </check>
          <check expr="@rawMboxName!=''">
            <error>ターゲットの場所 (rawbox) が指定されていません</error>
          </check>
        </leave>
      </form>
      <form applicableIf="HasPackage('nms:purl')" label="マイクロサイト (pURL) にリンクを挿入"
            name="insertPurl" nothingToSave="true" xpath="/tmp/purl">
        <enter>
          <reset xpath="/tmp/purl"/>
          <set value="0" xpath="/tmp/purl/@type"/>
        </enter>

        <static img="nms:circle-one.png" label="マイクロサイトへのリンクを選択してください"/>
        <container defaultColumns="webApp,[.],@name" exprOut1="@name" exprOut2="@url"
                   schema="nms:purl" setOnClick="true" sharedUserConfig="true" type="navTreeEntityList"
                   xpath="." xpathOut1="@name" xpathOut2="@url">
          <sysFilter>
            <condition enabledIf="$(/delivery/scheduling/@contactDate)!=''" expr="[webApp/@startDate]='' OR [webApp/@startDate] &lt;= #$noescaping(/delivery/scheduling/@contactDate)#"/>
            <condition enabledIf="$(/delivery/scheduling/@contactDate)!=''" expr="[webApp/@endDate]='' OR [webApp/@endDate] &gt;= #$noescaping(/delivery/scheduling/@contactDate)#"/>
            <condition expr="@isModel=0"/>
            <condition expr="[webApp/@appState]=10"/>
          </sysFilter>
        </container>

        <static img="nms:circle-two.png" label="配信のリンクフォーマットを指定"/>

        <input checkedValue="0" label="リンクのラベルを入力" type="radioButton" xpath="/tmp/purl/@type"/>
        <input checkedValue="1" label="URL をリンクラベルとして使用" type="radioButton" xpath="/tmp/purl/@type"/>
        <input checkedValue="2" label="有効化せずにリンクを挿入" type="radioButton" xpath="/tmp/purl/@type"/>

        <container type="visibleGroup" visibleIf="[/tmp/purl/@type]=0">
          <input label="リンクラベル" required="true" xpath="@urlLabel"/>
        </container>
        <container type="visibleGroup" visibleIf="[/tmp/purl/@type]=1">
          <static type="warning">このオプションによってメッセージの配信品質が変わる可能性があります : メッセージのコンテンツが不正であると見なされる場合があります。</static>
        </container>

        <leave>
          <if expr="[/tmp/purl/@type]=0">
            <check expr="@urlLabel!=''">
              <error>リンクのラベルを入力してください。</error>
            </check>
          </if>

          <if expr="[/tmp/purl/@type]=1">
            <!-- Force URL as label -->
            <set expr="[/tmp/purl/@url]" xpath="/tmp/purl/@urlLabel"/>
          </if>

          <if expr="[/tmp/purl/@type]=2">
          <!-- Blank label -->
            <set value="" xpath="/tmp/purl/@urlLabel"/>
          </if>

          <check expr="[/tmp/purl/@name]!=''">
            <error>マイクロサイトを選択してください。</error>
          </check>
        </leave>
      </form>
      <form label="パーソナライゼーションブロックを選択" name="selectIncDlg" nothingToSave="true">
        <container defaultColumns="@label,@name" exprOut1="@name" exprOut2="@label"
                   nodeModel="nmsIncludeView" schema="nms:includeView" sharedUserConfig="true"
                   type="navTreeEntityList" xpath="." xpathOut1="@name" xpathOut2="@label">
          <sysFilter>
            <condition expr="@visible=1 and @contentType IN (0,1)"/>
          </sysFilter>
        </container>
        <input label="ブロックの HTML ソースコードを含める" type="checkBox" xpath="/ignored/customizeBtnOut/subForm/@inlineMode"/>
      </form>
      <form label="オプションの選択" name="selectOptDlg" nothingToSave="true">
        <container defaultColumns="@name,@dataType,desc" exprOut1="@name" schema="xtk:option"
                   sharedUserConfig="true" type="navTreeEntityList" xpath="." xpathOut1="@name"/>
      </form>
    </container>
  </container>
<!--[cf]-->
<!--[of]:Toolbar-->
  <container name="toolbar" type="visibleGroup" visibleIf="false">
  <!--[of]planning:  Planning-->
    <input img="nl:smallcalendar.png" insertAfter="" label="スケジュール設定" name="planning"
           prebuildSubForm="false" type="flatSubFormButton" visibleIf="[/ignored/@dlvNotReady]='' and [/delivery/@FCP]=0 and [/ignored/@hasParentDelivery]!=1 and [/ignored/@limitEdition]=false and EV([/delivery/@deliveryMode], 'external')=false and [/ignored/@triggerMessage]!=1 and EV([/delivery/@deliveryMode], 'descriptive')=false">
      <form label="スケジュール設定" maxLabelWidth="50" readOnlyExpr="[/tmp/@readOnly]">
        <enter>
          <set expr="([scheduling/@contactDate]!=## or [/ignored/@contactDateExpr]!='') AND [scheduling/@delayed]=0"
               xpath="/ignored/@activeForecast"/>
          <set expr="[scheduling/@contactDate]" xpath="/ignored/@contactDate"/>
          <set expr="iif ([scheduling/@validationMode]='manual', true, false)" xpath="/tmp/@validationMode"/>

          <switch>
            <case expr="[/ignored/@activeForecast]">
              <set value="2" xpath="/tmp/@planningType"/>
            </case>
            <case expr="[scheduling/@delayed]">
              <set value="1" xpath="/tmp/@planningType"/>
            </case>
            <default>
              <set value="0" xpath="/tmp/@planningType"/>
            </default>
          </switch>
        </enter>

        <input checkedValue="0" label="スケジュール設定しない (コンタクト日なし)" nolabel="true" type="radioButton"
               xpath="/tmp/@planningType"/>
        <input checkedValue="2" label="予約配信 (自動実行なし)" nolabel="true" type="radioButton"
               xpath="/tmp/@planningType"/>
        <container type="visibleGroup" visibleIf="EV(@deliveryMode, 'descriptive')=false">
          <input checkedValue="1" label="予約配信 (予約された日になると自動実行)" nolabel="true" type="radioButton"
                 xpath="/tmp/@planningType"/>
        </container>

        <container type="visibleGroup" visibleIf="[/tmp/@planningType]=1">
          <container img="nms:calendar-large.png" label="配信を延期" type="frame">
            <container colspan="2" ref="nms:delivery:lib/dateSchedulingDef"/>
            <container type="visibleGroup" visibleIf="EV(@deliveryMode, 'descriptive')=false and EV(@deliveryMode, 'external')=false">
              <input label="送信前に配信を確定する" type="checkbox" xpath="/tmp/@validationMode"/>
            </container>
          </container>
        </container>

        <container type="visibleGroup" visibleIf="[/tmp/@planningType]=2">
          <container img="nms:calendar-large.png" label="暫定分析" type="frame">
            <container colspan="2" ref="nms:delivery:lib/dateSchedulingDef"/>
          </container>
        </container>

        <leave>
          <if expr="HasPackage('nms:campaign')">
            <check expr="[scheduling/@extraction] != '' or ([/tmp/@hasDateExpr] and [/ignored/@extractionExpr] != '') or [scheduling/@delayExtraction]=0">
              <error>抽出待機期間を適用するには抽出日が必要です。</error>
            </check>
          </if>

          <if expr="EV(@deliveryMode, 'descriptive')=false and [/tmp/@planningType]=2 AND [/ignored/@operationId]=0 AND EV(@state, 'targetPrepPending', 'targetReady', 'preparationError')=false">
        <!-- change state to process delivery in the forecast workflow -->
            <set expr="EVal(@state, 'targetPrepPending')" xpath="@state"/>
          </if>

          <if expr="EV(@deliveryMode, 'descriptive')=false and [/tmp/@planningType]=1">
        <!-- change validation mode : confirm or not the delivery -->
            <if expr="[/tmp/@validationMode]=true">
              <set value="manual" xpath="scheduling/@validationMode"/>
            </if>
            <if expr="[/tmp/@validationMode]=false">
              <set value="auto" xpath="scheduling/@validationMode"/>
            </if>
          </if>

          <if expr="[/tmp/@planningType]=0">
            <set value="" xpath="scheduling/@contactDate"/>
            <set value="0" xpath="scheduling/@delayed"/>
          </if>

          <if expr="[/tmp/@planningType]=1">
            <set value="1" xpath="scheduling/@delayed"/>
            <check expr="@isModel or ([/tmp/@hasDateExpr] and [/ignored/@contactDateExpr] != '') or ([scheduling/@contactDate] != '' and ([scheduling/@delayed]=false or [/ignored/@contactDate]==[scheduling/@contactDate] or [scheduling/@contactDate]&gt;=GetDate()))">
              <error>開始日は現在の日付より後にしてください。</error>
            </check>
          </if>

          <if expr="[/tmp/@planningType]=2">
            <if expr="EV(@deliveryMode, 'descriptive')=false">
              <set value="0" xpath="scheduling/@delayed"/>
            </if>
            <check expr="@isModel or ([/tmp/@hasDateExpr] and [/ignored/@contactDateExpr] != '') or ([scheduling/@contactDate] != '' and ([/ignored/@contactDate]==[scheduling/@contactDate] or [scheduling/@contactDate]&gt;=GetDate()))">
              <error>コンタクト日は今日の日付よりも後にする必要があります。</error>
            </check>
          </if>

          <if expr="[scenario/@setDirectDates]=0 and [scheduling/@contactDate]!=''">
            <set expr="DateAdd([scheduling/@contactDate], [scenario/@validityDuration])"
                 xpath="scheduling/@validityDate"/>
          </if>
        </leave>
      </form>
    </input>
    <input img="nms:bat.png" insertAfter="" label="受信ボックスレンダリング" name="Send" prebuildSubForm="false"
           type="flatSubFormButton" visibleIf="![/tmp/@readOnly] and [/delivery/@FCP]=0 and [/delivery/@isModel]==false and [/ignored/@dlvNotReady]='' and [/ignored/@dlvNotInDatabase]!='1' and [/delivery/@deliveryMode]!=2 and EV([/delivery/@deleteStatus], 'recycled') = false and HasPackage('nms:inboxRendering')">
      <form label="受信ボックスレンダリング" nothingToEdit="true" nothingToSave="true">
        <enter>
      <!-- Force Proof -->
          <set value="3" xpath="@launchFCP"/>
          <set value="false" xpath="@outOfProcess"/>
          <set value="prepareda" xpath="@module"/>
          <set value="false" xpath="/ignored/@showMappingChoice"/>
          <set value="false" xpath="/ignored/@start"/>
          <set value="false" xpath="/ignored/@enableStart"/>
          <set value="false" xpath="/ignored/@analyzed"/>
          <set expr="EV([targets/@targetMode],'file') or EV([targets/@targetMode],'evtDatabase') or [targets/deliveryTarget/@nonEmpty]"
               xpath="/ignored/@parentTargetAdded"/>
          <set expr="iif ((EV(@deliveryMode, 'external') and NodeCount([output/extraction/source/select/node])&gt;0 and (([/ignored/@operationId]=0 and [output/@downloadDestFile]=true) or [output/outputScript]!='')) or ((EV(@deliveryMode, 'external')=false and ([content/html/source]!='' or [content/text/source]!='' or [content/sms/source]!='' or [/ignored/@lineMessage]=1 or [content/twitterMsg/source]!='' or [/ignored/@facebookMessage]=1 or [content/iosMessage/source]!='' or [content/androidMessage/source]!='' or @messageType &gt; Eval(@messageType, 'other')))), true, false)"
               xpath="/ignored/@hasDeliveryContent"/>
          <set expr="@state" xpath="/ignored/@deliveryState"/>
          <set value="0" xpath="/ignored/@actionMode"/>
          <if expr="[targets/proofTarget/@nonEmpty]">
            <setModified/>
          </if>
          <if expr="[/ignored/@deliveryState]=''">
            <set expr="@state" xpath="/ignored/@deliveryState"/>
          </if>
          <set value="false" xpath="/ignored/@showTarget"/>
          <set value="nl:arrow_ntf_orange.png" xpath="/ignored/@img"/>
          <if expr="[/delivery/@FCP]=0">
          <!-- Reset fcp id to force to create new one -->
            <set value="" xpath="properties/@FCPid"/>
          </if>
          <set expr="(EV([targets/@targetMode],'file') and [targets/proofFile/name]!='') or [targets/proofTarget/@nonEmpty]"
               xpath="/ignored/@targetNoEmptyInit"/>

        <!-- Retrieve last FCP num -->
          <reset xpath="/ignored/queryDef"/>
          <set value="nms:delivery" xpath="/ignored/queryDef/@schema"/>
          <set expr="'@id='+[@id]" xpath="/ignored/queryDef/where/condition/@expr"/>
          <set value="getIfExists" xpath="/ignored/queryDef/@operation"/>
          <set value="[properties/@FCPLastNum]" xpath="/ignored/queryDef/select/node[1]/@expr"/>
          <set value="0" xpath="/ignored/@newIREnabled"/>
          <set value="@FCPLastNum" xpath="/ignored/queryDef/select/node[1]/@alias"/>
          <soapCall name="GetDeliverabilityServerDetails" service="nms:extAccount">
            <param exprIn="'deliverabilityInstance'" type="string"/>
            <param type="DOMDocument" xpathOut="/ignored/deliverabilityServerDetails"/>
          </soapCall>
          <soapCall name="ExecuteQuery" service="xtk:queryDef">
            <param exprIn="[/ignored/queryDef]" type="DOMDocument"/>
            <param type="DOMDocument" xpathOut="/ignored/queryDefRes"/>
          </soapCall>
          <set expr="[/ignored/queryDefRes/@FCPLastNum]" xpath="properties/@FCPLastNum"/>
          <set expr="[/ignored/deliverabilityServerDetails/@active] =           true"
               xpath="/ignored/@newIREnabled"/>
        </enter>
        <container backcolor="white" colcount="2" padding-bottom="4" padding-left="8"
                   padding-right="8" padding-top="4">
          <static font-size="16" label="配達確認を送信" unbound-width="true"/>
          <static img="nms:mail-list.png" rowspan="2" type="image" valign="center"/>
          <static label="配達確認が送信されると、「E メールのレンダリング」レポートでレンダリングを使用できるようになります。"/>
        </container>
        <container backcolor="tooltip" padding="5" type="visibleGroup" visibleIf="[/ignored/@deliveryAnalyzed] and [/ignored/@enableStart]=false and HasNamedRight('deliveryValidate') and [/ignored/@newIREnabled] ">
          <static img="nms:checked.png">配信が開始されました。\nこのウィンドウは閉じることができます。</static>
        </container>
        <container backcolor="tooltip" padding="5" type="visibleGroup" visibleIf="![/ignored/@newIREnabled]">
          <static img="nms:caution.png">新しい受信ボックスレンダリングが無効です。</static>
        </container>
        <container backcolor="tooltip" padding="5" type="visibleGroup" visibleIf="![/ignored/@hasDeliveryContent] and [/ignored/@newIREnabled] ">
          <static img="nms:exclam.png">メインの配信のコンテンツが空です。\n配達確認を送信できません。</static>
        </container>
        <container backcolor="tooltip" padding="5" type="visibleGroup" visibleIf="![/ignored/@parentTargetAdded] and [/ignored/@newIREnabled]">
          <static img="nms:caution.png">メインの配信ターゲットが指定されていません。\n配達確認を送信していない可能性があります。</static>
        </container>
        <static type="separator"/>

        <container type="visibleGroup" visibleIf="[/ignored/@hasDeliveryContent] and [/ignored/@parentTargetAdded] and [/ignored/@newIREnabled]">
          <container ref="nms:delivery:lib/prepareDelivery"/>
        </container>
        <leave>
        <!-- Need to restore state if it has been changed with fcp process -->
          <if expr="[/ignored/@deliveryState]!=@state">
            <set expr="[/ignored/@deliveryState]" xpath="@state"/>
            <set expr="[/ignored/@deliveryState]" xpath="properties/@deliveryState"/>
          </if>
          <set value="0" xpath="/delivery/@launchFCP"/>
          <if expr="EV([/delivery/@deliveryMode], 'external')">

            <if expr="[/ignored/@operationId]!=0">
            <!-- Specific code here for proof on external operation delivery (will be replaced later)
                 Wake up workflow to build routing email on proof if needed -->
              <soapCall name="WakeupTask" service="xtk:workflow">
                <param exprIn="'supplierMgt'" type="string"/>
                <param exprIn="''" type="string"/>
                <param exprIn="'scheduler'" type="string"/>
              </soapCall>
            </if>
          </if>
        </leave>
      </form>
    </input>

  <!--[cf]-->
  <!--[of]:  Send proof-->
    <input img="nms:bat.png" insertAfter="" label="配達確認を送信" name="Send" prebuildSubForm="false"
           type="flatSubFormButton" visibleIf="![/tmp/@readOnly] and [/delivery/@FCP]=0 and [/delivery/@isModel]==false and [/ignored/@dlvNotReady]='' and [/ignored/@dlvNotInDatabase]!='1' and [/delivery/@deliveryMode]!=2 and EV([/delivery/@deleteStatus], 'recycled') = false and [/ignored/@isACSConnector]==false">
      <form label="配達確認を送信" nothingToEdit="true" nothingToSave="true">
        <enter>
      <!-- Force Proof -->
          <set value="1" xpath="@launchFCP"/>
          <set value="false" xpath="@outOfProcess"/>
          <set value="prepareda" xpath="@module"/>
          <set value="false" xpath="/ignored/@showMappingChoice"/>
          <set value="false" xpath="/ignored/@start"/>
          <set value="false" xpath="/ignored/@enableStart"/>
          <set value="false" xpath="/ignored/@analyzed"/>
          <set expr="iif ((EV(@deliveryMode, 'external') and NodeCount([output/extraction/source/select/node])&gt;0 and (([/ignored/@operationId]=0 and [output/@downloadDestFile]=true) or [output/outputScript]!='')) or ((EV(@deliveryMode, 'external')=false and ([content/html/source]!='' or [content/text/source]!='' or [content/sms/source]!='' or [/ignored/@lineMessage]=1 or [content/twitterMsg/source]!='' or [/ignored/@facebookMessage]=1 or [content/iosMessage/source]!='' or [content/androidMessage/source]!='' or @messageType &gt; Eval(@messageType, 'other')))), true, false)"
               xpath="/ignored/@hasDeliveryContent"/>
          <set expr="@state" xpath="/ignored/@deliveryState"/>
          <set value="0" xpath="/ignored/@actionMode"/>
          <if expr="[targets/proofTarget/@nonEmpty]">
            <setModified/>
          </if>
          <if expr="[/ignored/@deliveryState]=''">
            <set expr="@state" xpath="/ignored/@deliveryState"/>
          </if>
          <set value="false" xpath="/ignored/@showTarget"/>
          <set value="nl:arrow_ntf_orange.png" xpath="/ignored/@img"/>
          <if expr="[/delivery/@FCP]=0">
          <!-- Reset fcp id to force to create new one -->
            <set value="" xpath="properties/@FCPid"/>
          </if>

          <set expr="(EV([targets/@targetMode],'file') and [targets/proofFile/name]!='') or [targets/proofTarget/@nonEmpty]"
               xpath="/ignored/@targetNoEmptyInit"/>

        <!-- Retrieve last FCP num -->
          <reset xpath="/ignored/queryDef"/>
          <set value="nms:delivery" xpath="/ignored/queryDef/@schema"/>
          <set expr="'@id='+[@id]" xpath="/ignored/queryDef/where/condition/@expr"/>
          <set value="getIfExists" xpath="/ignored/queryDef/@operation"/>
          <set value="[properties/@FCPLastNum]" xpath="/ignored/queryDef/select/node[1]/@expr"/>
          <set value="@FCPLastNum" xpath="/ignored/queryDef/select/node[1]/@alias"/>
          <soapCall name="ExecuteQuery" service="xtk:queryDef">
            <param exprIn="[/ignored/queryDef]" type="DOMDocument"/>
            <param type="DOMDocument" xpathOut="/ignored/queryDefRes"/>
          </soapCall>
          <set expr="[/ignored/queryDefRes/@FCPLastNum]" xpath="properties/@FCPLastNum"/>
        <!-- Only fcp mode allowed for recurring delivery is specific target -->
          <if expr="hasPackage('nms:campaign')">
            <set expr="[@recurringDelivery-id] != 0" xpath="/ignored/isRecurring"/>
          </if>
          <if expr="[/ignored/isRecurring]">
            <set expr="'specificTarget'" xpath="fcpParameters/@fcpMode"/>
          </if>


        </enter>

      <!-- header -->
        <container backcolor="white" colcount="2" padding-bottom="4" padding-left="8"
                   padding-right="8" padding-top="4">
          <static font-size="16" label="配達確認を送信" unbound-width="true"/>
          <static img="nms:mail-list.png" rowspan="2" type="image" valign="center"/>
          <static label="メインターゲットを示し、配信の準備を開始します。"/>
        </container>
        <static type="separator"/>

        <container ref="nms:delivery:lib/wizSend/pgProof"/>

        <leave>
        <!-- Need to restore state if it has been changed with fcp process -->
          <if expr="[/ignored/@deliveryState]!=@state">
            <set expr="[/ignored/@deliveryState]" xpath="@state"/>
            <set expr="[/ignored/@deliveryState]" xpath="properties/@deliveryState"/>
          </if>
          <set value="0" xpath="/delivery/@launchFCP"/>
          <if expr="EV([/delivery/@deliveryMode], 'external')">

            <if expr="[/ignored/@operationId]!=0">
            <!-- Specific code here for proof on external operation delivery (will be replaced later)
                 Wake up workflow to build routing email on proof if needed -->
              <soapCall name="WakeupTask" service="xtk:workflow">
                <param exprIn="'supplierMgt'" type="string"/>
                <param exprIn="''" type="string"/>
                <param exprIn="'scheduler'" type="string"/>
              </soapCall>
            </if>
          </if>
        </leave>
      </form>
    </input>
  <!--[cf]-->
  <!--[of]:  Send-->
    <input img="nms:sendemail.png" insertAfter="" label="送信" name="Send" prebuildSubForm="false"
           type="flatSubFormButton" visibleIf="![/tmp/@readOnly] and [/delivery/@deliveryMode]!=2 and ([/delivery/@FCP]=0 or ([/delivery/@FCP]=1 AND [/delivery/@state]=0)) and [/delivery/@isModel]==false and [/ignored/@dlvNotReady]='' and [/delivery/targets/@targetMode]&lt;4 and ([/ignored/tmp/@workflowId]&lt;=0 or [/ignored/@operationId]='' or [/delivery/@FCP]=1) and [/ignored/@limitEdition]=false and [/delivery/@deliveryMode]!=2 and [/ignored/@triggerMessage]!=1 and EV([/delivery/@deleteStatus], 'recycled') = false and [/ignored/@isACSConnector]==false">
      <form label="メインの配信ターゲットに送信" nothingToEdit="true" nothingToSave="true">
        <enter>
          <set value="0" xpath="@launchFCP"/>
          <set expr="[advancedParameters/@outOfProcessMode]" xpath="@outOfProcess"/>
          <set value="prepareda" xpath="@module"/>

          <set value="false" xpath="/ignored/@start"/>
          <set value="false" xpath="/ignored/@enableStart"/>
          <set value="false" xpath="/ignored/@analyzed"/>
          <set value="" xpath="/ignored/@deliveryState"/>
          <set expr="iif ((EV(@deliveryMode, 'external') and NodeCount([output/extraction/source/select/node])&gt;0 and (([/ignored/@operationId]=0 and [output/@downloadDestFile]=true) or [output/outputScript]!='')) or ((EV(@deliveryMode, 'external')=false and ([content/html/source]!='' or [content/pdf/name]!='' or [content/text/source]!='' or [content/sms/source]!='' or [/ignored/@lineMessage]=1 or [content/twitterMsg/source]!='' or [/ignored/@facebookMessage]=1 or [content/iosMessage/source]!='' or [content/androidMessage/source]!='' or @messageType &gt; Eval(@messageType, 'other')))), true, false)"
               xpath="/ignored/@hasDeliveryContent"/>
          <set value="false" xpath="/ignored/@showMappingChoice"/>

          <set expr="(EV([targets/@targetMode],'file') and [targets/deliveryFile/name]!='') or [targets/deliveryTarget/@nonEmpty]"
               xpath="/ignored/@targetNoEmptyInit"/>

          <if expr="@FCP=0">
          <!-- Reset fcp id to force to create new one -->
            <set value="" xpath="properties/@FCPid"/>
          </if>
          <if expr="[targets/deliveryTarget/@nonEmpty]">
            <setModified/>
          </if>

        <!-- default action : analyze target -->
          <set value="2" xpath="/ignored/@actionMode"/>
          <if expr="[/ignored/@hasDeliveryContent] and ([/ignored/@contentStatus]=2 or [/ignored/@useContentValidation]=false) and [/ignored/@useTargetValidation]=false">
          <!-- force to choice an action -->
            <set value="-1" xpath="/ignored/@actionMode"/>
            <if expr="EV([properties/@deliveryState], 'edition')=false">
            <!-- force preparation of messages if target has already been processed -->
              <if expr="[scheduling/@delayed]">
                <set value="1" xpath="/ignored/@actionMode"/>
              </if>
              <if expr="![scheduling/@delayed]">
                <set value="0" xpath="/ignored/@actionMode"/>
              </if>
            </if>
          </if>

          <if expr="[/ignored/@deliveryState]!='' and [/ignored/@deliveryState]!=@state">
            <set expr="[/ignored/@deliveryState]" xpath="@state"/>
            <set expr="[/ignored/@deliveryState]" xpath="properties/@deliveryState"/>
          </if>

          <set value="false" xpath="/ignored/@showTarget"/>
          <set value="nl:arrow_ntf_orange.png" xpath="/ignored/@img"/>
          <set value="false" xpath="/ignored/@showAction"/>
          <set value="nl:arrow_ntf_orange.png" xpath="/ignored/@imgAction"/>
        </enter>

      <!-- header -->
        <container backcolor="white" colcount="2" padding-bottom="4" padding-left="8"
                   padding-right="8" padding-top="4">
          <static font-size="16" label="メインの配信ターゲットに送信" unbound-width="true"/>
          <static img="nms:mail-list.png" rowspan="2" type="image" valign="center"/>
          <static label="メインターゲットを示し、配信の準備を開始します。"/>
        </container>
        <static type="separator"/>

        <container ref="nms:delivery:lib/wizSend/pgTarget"/>

        <leave>
      <!-- Need to reload delivery detail from base if main target has been targeted -->
          <if expr="[/ignored/@start] and [/delivery/@launchFCP]=0">
            <reload/>
            <setNotifySaved/>
          </if>
        </leave>
      </form>
    </input>
  <!--[cf]-->
  <!--[of]:  Attachments-->
    <input collection="/delivery/attachment" enabledIf="![/tmp/@readOnly]" form="nms:uploadAttachment"
           img="nms:attachment.png" label="添付" prebuildSubForm="false" textAlign="toolTip"
           type="fileTransferButton" visibleIf="EV([/delivery/@messageType], 'mail') and [/ignored/@dlvNotReady]='' and [/ignored/@limitEdition]=false and [/ignored/@hasParentDelivery]!=1">
      <enter name="onClick">
        <set expr="[/tmp/@uploadFile]" xpath="name"/>
        <set value="normal" xpath="@type"/>
      </enter>
    </input>
  <!--[cf]-->
<!--[of]:Tracking and images-->
    <input img="nms:tracking.png" label="トラッキングおよび画像" name="tracking" prebuildSubForm="false"
           textAlign="toolTip" type="flatSubFormButton" visibleIf="[/delivery/mapping/storage/@trackingLogSchema]!='' and [/ignored/@dlvNotReady]='' and EV([/delivery/@deliveryMode], 'external')=false and ([/ignored/@socialMessage]=1 or [/ignored/@lineMessage]=1 or [/ignored/@pushMessage]=1 or EV([/delivery/@messageType], 'mail') or (EV([/delivery/@messageType], 'sms') and EV([/delivery/smsParameters/@mobileMsgType], 'sms', 'wapPush', 'mms'))) and [/ignored/@limitEdition]=false and [/ignored/@hasParentDelivery]!=1">
      <form label="トラッキング＆画像" readOnlyExpr="[/tmp/@readOnly]" type="notebook">
<!--[of]:Tracking-->
        <container label="トラッキング">
          <input nolabel="true" xpath="tracking/@enabled"/>
          <container enabledIf="[tracking/@enabled]" type="enabledGroup">
            <container type="visibleGroup" visibleIf="EV(@messageType, 'mail')">
              <input nolabel="true" xpath="tracking/@openEnabled"/>
            </container>
            <input flatMode="false" type="urlTree" xpath="content"/>
          </container>
        </container>
<!--[cf]-->
<!--[of]:Images (Email)-->
        <container label="画像" visibleIf="EV([/delivery/@messageType], 'mail') AND GetOption('NmsDelivery_ImagePublishing')!='none'">
          <container colcount="3" xpath="content">
            <input nolabel="true" xpath="@uploadImages"/>
            <container enabledIf="@uploadImages" type="enabledGroup">
              <input nolabel="true" xpath="@multipartRelated"/>
            </container>
            <container enabledIf="@multipartRelated and @uploadImages" type="enabledGroup">
              <input label="すべての画像を含める" type="button">
                <enter>
                  <forEach xpath="html/imageConfig/image">
                    <set value="1" xpath="@multipartRelated"/>
                  </forEach>
                  <setModified/>
                </enter>
              </input>
            </container>
          </container>
          <container colcount="2" enabledIf="[content/@uploadImages]" type="enabledGroup">
            <input colspan="2" flatMode="false" type="ImageSelector" xpath="content/html"
                   xpathMultipart="content/@multipartRelated"/>
            <static colspan="2" label="エラー :" type="separator"/>
            <input colspan="2" flatMode="false" lineCount="6" name="imageSelectorErrorList"
                   type="LogList"/>

            <input xpath="content/@publicURL"/>
            <static rowspan="2" type="help">空の場合、デプロイメントウィザードで定義した値が使用されます。</static>
            <input img="xtk:upload.png" label="画像をすぐにアップロード..." prebuildSubForm="false"
                   type="subFormLink" xpath="content/html/source">
              <form label="画像をアップロード" nothingToEdit="true" nothingToSave="true">
                <container ref="nms:delivery:lib/imageUpload"/>
              </form>
            </input>
          </container>
        </container>
<!--[cf]-->
<!--[of]:Advanced-->
        <container label="詳細設定" xpath="tracking">
          <container type="visibleGroup" visibleIf="[/ignored/@showTracking]">
            <static img="nms:tracking.png" label="トラッキングする URL の計算式 :"/>
            <input fullToolbar="true" htmlMode="false" name="ctClickFormula" nolabel="true"
                   type="htmlSource" xpath="clickFormula" xpathInsert="/ignored/customizeTrackingClick">
              <container>
                <input menuId="deliveryMenuBuilder" type="customizeBtn" xpath="/ignored/customizeTrackingClick"/>
              </container>
            </input>
          </container>
          <static img="nms:tracking.png" label=" 開く URL の計算式 :"/>
          <input fullToolbar="true" htmlMode="false" name="ctOpenFormula" nolabel="true"
                 type="htmlSource" xpath="openFormula" xpathInsert="/ignored/customizeTrackingOpen">
            <container>
              <input menuId="deliveryMenuBuilder" type="customizeBtn" xpath="/ignored/customizeTrackingOpen"/>
            </container>
          </input>
        </container>
<!--[cf]-->
      </form>
    </input>
<!--[cf]-->
<!--[of]:Offers-->
    <input applicableIf="HasPackage('nms:coreInteraction')" img="nms:offer.png" label="オファー"
           name="offers" prebuildSubForm="false" textAlign="toolTip" type="flatSubFormButton"
           visibleIf="[/ignored/@dlvNotReady]='' and [/ignored/@limitEdition]=false and EV([/delivery/@deliveryMode], 'descriptive')=false">
      <form label="オファー管理" readOnlyExpr="[/tmp/@readOnly]">
        <enter>
          <set expr="Iif(hasPackage('nms:campaign') OR hasPackage('nms:interaction'), @useTargetOffers, 1)"
               xpath="@useTargetOffers"/>
        </enter>
        <container label="オファーの選択" type="frame">
          <container type="visibleGroup" visibleIf="(hasPackage('nms:campaign') OR hasPackage('nms:interaction')) AND ([/ignored/tmp/@workflowId] OR [/ignored/@workflow-id] OR @isModel)">
            <input checkedValue="0" label="オファーエンジンまたは配信の概要で定義されたオファーへの呼び出しを使用" nolabel="true"
                   type="radioButton" xpath="@useTargetOffers"/>
            <input checkedValue="1" label="ターゲティング時に作成されたオファーを使用" nolabel="true"
                   type="radioButton" xpath="@useTargetOffers"/>
          </container>
          <container maxLabelWidth="200" type="visibleGroup" visibleIf="!@useTargetOffers">
            <input createMode="none" notifyPathList="@defaultCategory-id|/tmp/@defaultCategoryId,@disablePropositionStorage,defaultCategory/@label|/tmp/@defaultCategoryCs,@defaultThemes|/tmp/@defaultThemes"
                   xpath="offerSpace">
              <enter name="onChange">
                <set expr="[/tmp/@defaultCategoryId]" xpath="/tmp/defaultCategory/@id"/>
                <set expr="[/tmp/@defaultCategoryCs]" xpath="/tmp/defaultCategory/@_cs"/>
                <set expr="[/tmp/@defaultCategoryId]" xpath="/tmp/defaultCategory"/>
                <set expr="[/tmp/@defaultThemes]" xpath="@offerThemes"/>
                <set value="nms:offerSpace" xpath="/ignored/queryDefOfferSpace/@schema"/>
                <set value="get" xpath="/ignored/queryDefOfferSpace/@operation"/>
                <set value="[representationFields/@xpath]" xpath="/ignored/queryDefOfferSpace/select/node[1]/@expr"/>
                <set value="@id" xpath="/ignored/queryDefOfferSpace/select/node[2]/@expr"/>
                <set value="@name" xpath="/ignored/queryDefOfferSpace/select/node[3]/@expr"/>
                <set value="[env/@id]" xpath="/ignored/queryDefOfferSpace/select/node[4]/@expr"/>
                <set value="[env/@name]" xpath="/ignored/queryDefOfferSpace/select/node[5]/@expr"/>
                <set value="[env/@propositionSchema]" xpath="/ignored/queryDefOfferSpace/select/node[6]/@expr"/>
                <set value="[.]" xpath="/ignored/queryDefOfferSpace/select/node[7]/@expr"/>
                <set value="[rendering/@useTextFunction]" xpath="/ignored/queryDefOfferSpace/select/node[8]/@expr"/>
                <set value="[rendering/@useHtmlFunction]" xpath="/ignored/queryDefOfferSpace/select/node[9]/@expr"/>
                <if expr="HasPackage('nms:interaction')">
                  <set value="@anonymousFallback" xpath="/ignored/queryDefOfferSpace/select/node[10]/@expr"/>
                </if>
                <set expr="'@id='+[/delivery/offerSpace/@id]" xpath="/ignored/queryDefOfferSpace/where/condition/@expr"/>
                <soapCall name="ExecuteQuery" service="xtk:queryDef">
                  <param exprIn="[/ignored/queryDefOfferSpace]" type="DOMDocument"/>
                  <param type="DOMDocument" xpathOut="/ignored/offerSpace"/>
                </soapCall>
                <if expr="[/ignored/offerSpace/@id]!=0">
              <!-- needed for a preview -->
                  <set expr="[/ignored/offerSpace/env/@id]" xpath="/delivery/offerSpace/env/@id"/>
                  <set expr="[/ignored/offerSpace/env/@propositionSchema]" xpath="/delivery/offerSpace/env/@propositionSchema"/>
                </if>
                <if expr="[/ignored/offerSpace/@id]=0">
                  <reset xpath="/delivery/offerSpace/env"/>
                </if>
                <if expr="[/ignored/@triggerMessage]=1">
                  <if expr="[/ignored/offerSpace/@id]!=0">
                    <soapCall name="GetUrls" service="nms:offerSpace">
                      <param exprIn="[/delivery/offerSpace/@id]" type="int"/>
                      <param type="string" xpathOut="/delivery/triggerMessage/@offerSpaceUrl"/>
                    </soapCall>
                  </if>
                  <if expr="[/ignored/offerSpace/@id]=0">
                    <set expr="''" xpath="/delivery/triggerMessage/@offerSpaceUrl"/>
                  </if>
                  <set expr="@id" xpath="/delivery/triggerMessage/@templateId"/>
                </if>
              </enter>
              <sysFilter>
                <condition expr="[env/@live]=true"/>
                <condition expr="@channel=$(@messageType)"/>
              </sysFilter>
            </input>
            <container applicableIf="HasPackage('nms:interaction')" type="visibleGroup"
                       visibleIf="[@offerSpace-id]=0">
              <static fontBold="true" img="xtk:logmsg.png" type="help">配信コンテンツ内のオファー表示域を要求するには、スペースを入力してください。</static>
            </container>
            <container applicableIf="HasPackage('nms:interaction')" type="visibleGroup"
                       visibleIf="[@offerSpace-id]!=0">
              <static fontBold="true" type="help">準備中にオファーエンジンを有効化するには、次のパラメーターを入力してください。</static>
              <container applicableIf="HasPackage('nms:campaign')" type="visibleGroup"
                         visibleIf="![/ignored/@hasDlvOutlineOffers]">
                <input xpath="offerCategory" xpathRefresh="/tmp/defaultCategory">
                  <sysFilter>
                    <condition expr="(@model ='nmsOfferCategory' AND [@env-id] = $(/ignored/offerSpace/env/@id)) OR ( @model = 'nmsOfferEnv' AND @id = $(/ignored/offerSpace/env/@id))"/>
                  </sysFilter>
                </input>
                <input xpath="@offerThemes"/>
              </container>
              <container type="visibleGroup" visibleIf="HasPackage('nms:campaign')=false">
                <input xpath="offerCategory" xpathRefresh="/tmp/defaultCategory">
                  <sysFilter>
                    <condition expr="(@model ='nmsOfferCategory' AND [@env-id] = $(/ignored/offerSpace/env/@id)) OR ( @model = 'nmsOfferEnv' AND @id = $(/ignored/offerSpace/env/@id))"/>
                  </sysFilter>
                </input>
                <input xpath="@offerThemes"/>
              </container>
              <container applicableIf="HasPackage('nms:interaction')" type="visibleGroup"
                         visibleIf="[/ignored/@triggerMessage]=1 AND [/ignored/offerSpace/@anonymousFallback]">
                <input xpath="offerAnonymousCategory">
                  <sysFilter>
                    <condition expr="@model IN ('nmsOfferCategory', 'nmsOfferEnv')"/>
                  </sysFilter>
                </input>
              </container>
              <container applicableIf="HasPackage('nms:campaign')" type="visibleGroup"
                         visibleIf="[@operation-id]!=0 AND [/ignored/@hasDlvOutlineOffers]==false">
                <static type="help">オファーが配信の概要で定義されている場合、カテゴリとテーマは考慮されません。カテゴリが指定されていない場合、環境のすべてのオファーが適格になります。テーマが指定されていない場合、すべてのテーマが適格になります。</static>
              </container>
              <container applicableIf="HasPackage('nms:campaign')" type="visibleGroup"
                         visibleIf="[@operation-id]=0">
                <static type="help">カテゴリが指定されていない場合は、環境内のすべてのオファーが対象になります。テーマが指定されていない場合は、すべてのテーマが対象になります。</static>
              </container>
              <container type="visibleGroup" visibleIf="HasPackage('nms:campaign')=false">
                <static type="help">カテゴリが指定されていない場合は、環境内のすべてのオファーが対象になります。テーマが指定されていない場合は、すべてのテーマが対象になります。</static>
              </container>
              <input minValue="0" xpath="@maxPropositionCount"/>
            </container>
          </container>
          <container maxLabelWidth="200" type="visibleGroup" visibleIf="@useTargetOffers">
            <input createMode="none" notifyPathList="@defaultCategory-id|/tmp/@defaultCategoryId,@disablePropositionStorage,defaultCategory/@label|/tmp/@defaultCategoryCs,@defaultThemes|/tmp/@defaultThemes"
                   xpath="offerSpace">
              <enter name="onChange">
                <set expr="[/tmp/@defaultCategoryId]" xpath="/tmp/defaultCategory/@id"/>
                <set expr="[/tmp/@defaultCategoryCs]" xpath="/tmp/defaultCategory/@_cs"/>
                <set expr="[/tmp/@defaultCategoryId]" xpath="/tmp/defaultCategory"/>
                <set expr="[/tmp/@defaultThemes]" xpath="@offerThemes"/>
                <set value="nms:offerSpace" xpath="/ignored/queryDefOfferSpace/@schema"/>
                <set value="get" xpath="/ignored/queryDefOfferSpace/@operation"/>
                <set value="[representationFields/@xpath]" xpath="/ignored/queryDefOfferSpace/select/node[1]/@expr"/>
                <set value="@id" xpath="/ignored/queryDefOfferSpace/select/node[2]/@expr"/>
                <set value="[env/@id]" xpath="/ignored/queryDefOfferSpace/select/node[3]/@expr"/>
                <set value="[env/@propositionSchema]" xpath="/ignored/queryDefOfferSpace/select/node[4]/@expr"/>
                <set value="[.]" xpath="/ignored/queryDefOfferSpace/select/node[5]/@expr"/>
                <set value="[rendering/@useTextFunction]" xpath="/ignored/queryDefOfferSpace/select/node[6]/@expr"/>
                <set value="[rendering/@useHtmlFunction]" xpath="/ignored/queryDefOfferSpace/select/node[7]/@expr"/>
                <set expr="'@id='+[/delivery/offerSpace/@id]" xpath="/ignored/queryDefOfferSpace/where/condition/@expr"/>
                <soapCall name="ExecuteQuery" service="xtk:queryDef">
                  <param exprIn="[/ignored/queryDefOfferSpace]" type="DOMDocument"/>
                  <param type="DOMDocument" xpathOut="/ignored/offerSpace"/>
                </soapCall>
              </enter>
              <sysFilter>
                <condition expr="[env/@live]=true"/>
                <condition expr="@channel=$(@messageType)"/>
              </sysFilter>
            </input>
            <input minValue="0" xpath="@maxPropositionCount"/>
            <static type="help">ターゲティングワークフローで、「オファーエンジン」または「配信の概要」アクティビティを使用してオファーを定義した場合、配信コンテンツの入力時の補助となるように、(上部で) スペースに加えて、このアクティビティに設定されているオファー数を示すことができます。</static>
          </container>
        </container>
        <static/>
        <container type="visibleGroup" visibleIf="[/ignored/@triggerMessage]!=1">
          <input nolabel="true" xpath="targets/@excludeOnMissingOffer"/>
          <static type="help">配信の概要でオファーが参照されているか、ターゲティング中に準備された場合に、除外処理がターゲティング中に実行されます。\nオファーがオファーエンジンによって自動的に選択されている場合は、除外処理がメッセージのパーソナライゼーション中に実行されます。</static>
        </container>
        <input nolabel="true" xpath="targets/@emptyReprForMissingOffer"/>
        <static type="help">オファーがない場合、表示域の表示リクエストの送信がキャンセルされます。\nこのボックスをオンにした場合、メッセージはキャンセルされず、空の表示域が生成されます。</static>
        <input expr="Iif(@useTargetOffers, '', AddOfferViewToBLogSchema([offerSpace/env/@propositionSchema], 'nms:offerView'))"
               type="expr" xpath="/ignored/@offerViewSchema"/>
      </form>
    </input>
<!--[cf]-->
  <!--[of]:  Measure-->
    <input img="nms:response.png" label="配信測定" name="measure" prebuildSubForm="false"
           textAlign="toolTip" type="flatSubFormButton" visibleIf="[/ignored/@dlvNotReady]='' and [/delivery/@FCP]=0 and [/ignored/@limitEdition]=false and EV([/delivery/@deliveryMode], 'descriptive')=false">
      <form label="配信測定" maxLabelWidth="50" readOnlyExpr="false">
        <container ref="nms:delivery:lib/measureROI" xpath="forecast"/>
        <container applicableIf="HasPackage('nms:response')" type="visibleGroup"
                   visibleIf="[/delivery/@operation-id]!=0 and [/delivery/@operation-id]!='' and [/ignored/@useMeasure] and HasPackage('nms:response')">
          <static label="効果的な ROI の計算" type="separator"/>
          <container colspan="2" type="visibleGroup" visibleIf="!@isModel">
            <container ref="nms:operation:lib/hypothesis"/>
          </container>
          <container colspan="2" type="visibleGroup" visibleIf="@isModel" xpath="measure">
            <container ref="nms:operation:lib/hypothesis"/>
          </container>
        </container>
      </form>
    </input>
  <!--[cf]-->
  <!--[of]:  Budget-->
    <input applicableIf="HasPackage('nms:campaign')" img="nms:budget.png" label="費用と売上高"
           prebuildSubForm="true" textAlign="toolTip" type="flatSubFormButton" visibleIf="[/ignored/@dlvNotReady]='' and [/ignored/@useBudget] and [/delivery/@FCP]=0 and ([/ignored/@hasParentDelivery]!=1 or [/ignored/@linkedOperation-id]!=0) and [/ignored/@limitEdition]=false">
      <form label="費用と売上高" maxLabelWidth="50" readOnlyExpr="[/tmp/@readOnly]">
        <container ref="nms:delivery:lib/budget"/>
      </form>
    </input>
  <!--[cf]-->
<!--[of]:Documents-->
    <input applicableIf="HasPackage('nms:campaign')" img="nms:document.png" label="ドキュメント"
           name="document" prebuildSubForm="false" textAlign="toolTip" type="flatSubFormButton"
           visibleIf="[/delivery/@operation-id]!=0 and [/ignored/@useValidation] and [/ignored/@dlvNotReady]=''">
      <form label="参照されたドキュメント" maxLabelWidth="50" readOnlyExpr="[/tmp/@readOnly]">
        <container ref="nms:plan:lib/document"/>
        <container applicableIf="HasPackage('nms:mrm')" ref="nms:plan:lib/asset"/>
      </form>
    </input>
<!--[cf]-->

  <!--[of]:  Properties-->
    <input img="xtk:properties.png" label="プロパティ" name="advanced" prebuildSubForm="false"
           type="flatSubFormButton" visibleIf="[/ignored/@dlvNotReady]='' and [/ignored/@limitEdition]=false">
      <form label="配信プロパティ" maxLabelWidth="50" readOnlyExpr="[/tmp/@readOnly]" type="notebook">
        <enter>
          <set expr="iif ([scheduling/@validationMode]='manual', true, false)" xpath="/tmp/@validationMode"/>
        </enter>
  <!--[of]:General-->
        <container label="一般" propagateConstraints="false">
          <container ref="nms:delivery:lib/general"/>
        </container>
  <!--[cf]-->
  <!--[of]:Analyse-->
        <container label="分析" propagateConstraints="false" visibleIf="EV(@deliveryMode, 'descriptive')=false">
          <container label="配信のラベルとコード" type="frame">
            <input xpath="scenario/@useLabelScript"/>
            <container type="visibleGroup" visibleIf="[scenario/@useLabelScript]">
              <input label="ラベル" menuId="deliveryMenuBuilder" options="noRcp" type="scriptEdit"
                     xpath="scenario/labelScript"/>
            </container>
            <input xpath="scenario/@useDeliveryCodeScript"/>
            <container type="visibleGroup" visibleIf="[scenario/@useDeliveryCodeScript]">
              <input label="配信コード" menuId="deliveryMenuBuilder" options="noRcp" type="scriptEdit"
                     xpath="scenario/deliveryCodeScript"/>
            </container>
            <input xpath="scenario/@useFolderScript"/>
            <container type="visibleGroup" visibleIf="[scenario/@useFolderScript]">
              <input label="フォルダー" menuId="deliveryMenuBuilder" options="noRcp" type="scriptEdit"
                     xpath="scenario/folderScript"/>
            </container>
          </container>
          <container type="visibleGroup" visibleIf="![/ignored/@operationId] or ([/ignored/@operationId] and EV(@deliveryMode, 'external')=false and [/ignored/@useValidation]=false)">
            <container label="承認" type="frame">
              <input xpath="scheduling/@validationMode"/>
              <container type="visibleGroup" visibleIf="EV([scheduling/@validationMode], 'manual')">
                <static type="help">配信を開始するには、分析フェーズの後、ユーザーが配信を承認する必要があります。</static>
              </container>
              <container type="visibleGroup" visibleIf="EV([scheduling/@validationMode], 'secure')">
                <static type="help">分析ステップで警告が生成されない場合は、配信が自動的に開始されます。</static>
              </container>
              <container type="visibleGroup" visibleIf="EV([scheduling/@validationMode], 'auto')">
                <static type="help">配信は分析終了時に自動的に開始します。</static>
              </container>
            </container>
          </container>
          <container type="visibleGroup" visibleIf="EV(@deliveryMode, 'external')">
            <container label="配信後の結果と動作" type="frame" xpath="output">
              <input useDesc="true" xpath="@feedbackMode"/>
            </container>
          </container>
          <input width="7" xpath="advancedParameters/@useDataManagement"/>
          <input xpath="advancedParameters/@outOfProcessMode"/>
          <container type="visibleGroup" visibleIf="[/ignored/@workflow-id]==0 OR [/ignored/@workflow-id]==''">
            <input useDesc="true" xpath="advancedParameters/@showSQL"/>
          </container>
          <container type="visibleGroup" visibleIf="@deliveryMode != 0">
            <input useDesc="true" xpath="content/@ignoreScripts"/>
            <static type="help">コンテンツ内の JavaScript タグ (&lt;% %&gt; タグで区切られている) は解釈されませんが、送信されるコンテンツにそのまま残ります。</static>
          </container>
          <container name="broadlogOptions" type="visibleGroup" visibleIf="@FCP=0"
                     xpath="targets">
            <input useDesc="true" xpath="@skipIgnoredLogs"/>
            <container type="visibleGroup" visibleIf="EV(@targetMode, 'database', 'evtDatabase')">
              <container type="visibleGroup" visibleIf="FieldExists([../mapping/storage/@broadLogSchema], '@externalId')">
                <input nolabel="false" type="pathEdit" xpath="@externalId" xpathSchema="../mapping/@schema"/>
                <static colspan="2" label="マッピング計算式を上書きします。外部識別子はメッセージごとに計算され、関連付けられた配信ログに保存されます。"
                        type="help"/>
              </container>
            </container>
          </container>
        </container>
  <!--[cf]-->
  <!--[of]:Web Analytics-->
        <container applicableIf="HasPackage('nms:webAnalytics')" label="Web 分析" propagateConstraints="false"
                   visibleIf="HasPackage('nms:webAnalytics') and EV(@deliveryMode, 'descriptive')=false">
          <container label="トラッキングされる URL" type="frame">
            <input createMode="none" fullLoad="true" notifyPathList="webAnalyticsParams/@partner|/tmp/webAnalyticsAccount/webAnalyticsParams/@partner,webAnalyticsParams/clickFormula|/tmp/webAnalyticsAccount/webAnalyticsParams/clickFormula"
                   xpath="webAnalyticsAccount">
              <sysFilter>
                <condition expr="@type = 8"/>
                <condition expr="@active = 1"/>
              </sysFilter>
            </input>
            <static type="help">配信でトラッキングされた URL は、Web 分析アカウントで定義された数式に基づいてエンリッチメントされます。</static>
          </container>
          <container type="visibleGroup" visibleIf="[/tmp/webAnalyticsAccount/webAnalyticsParams/@partner]=1 or [webAnalyticsAccount/webAnalyticsParams/@partner]=1">
            <container label="配信設定をパートナーと交換しました" type="frame">
              <input xpath="@internalName"/>
              <container applicableIf="HasPackage('nms:campaign')" type="visibleGroup"
                         visibleIf="[operation/@id]!=0">
                <input readOnly="true" xpath="operation/@label"/>
                <input readOnly="true" xpath="operation/@nature"/>
              </container>
              <input xpath="webAnalytics/@tag1"/>
              <input xpath="webAnalytics/@tag2"/>
              <input xpath="webAnalytics/@tag3"/>
              <static type="help">これらの設定は、Web Analytics レポートのエンリッチメントのために、パートナーに送信されます。</static>
            </container>
          </container>
        </container>
  <!--[cf]-->
  <!--[of]:Data loading-->
        <container label="パーソナライゼーション" propagateConstraints="false" visibleIf="( EV([targets/@targetMode],'file')==false or [targets/@noReconciliation]==false ) and [/ignored/@hasParentDelivery]!=1 and [/delivery/@deliveryMode]!=2">
          <container type="visibleGroup" visibleIf="EV(@deliveryMode, 'external') == false">
            <container type="visibleGroup" visibleIf="[mapping/@recipientLink] != '' or [mapping/@schema] == 'nms:recipient'">
              <container ref="nms:delivery:lib/editRecipientQuery"/>
            </container>
            <container type="visibleGroup" visibleIf="( [mapping/@schema] != 'nms:recipient' or [mapping/@recipientLink] != '' )">
              <container ref="nms:delivery:lib/editTargetQuery"/>
            </container>
          </container>
  <!--[of]:Coupons-->
          <container applicableIf="HasPackage('nms:coupon')" type="visibleGroup"
                     visibleIf="[@coupon-id]!=0">
            <input img="nms:campaign.png" label="クーポンを読み込むためのクエリを編集..." prebuildSubForm="false"
                   type="subFormLink" xpath="/delivery/content/extraCoupon">
              <form img="nms:pictoprofile.png" label="クーポンを読み込むためのクエリを編集" type="wizard">
                <container desc="パーソナライゼーションのために読み込むクーポンのフィールドを入力してください。" title="読み込むクーポンのフィールド">
                  <enter>
                    <set value="nms:coupon" xpath="/tmp/selectCtrl/in/@schema"/>
                    <set value="/" xpath="/tmp/selectCtrl/in/@startPath"/>
                  </enter>
                  <container extraColumns="@alias" ref="xtk:queryDef:hidden/selectCtrl"
                             showCollections="true" xpath="custom"/>
                </container>
                <container desc="コレクションリンクごとにフィルター条件と並べ替え順序を編集してください。リンク済みレコードの読み込みを制限するために使用します。"
                           title="コレクションのパーソナライゼーション情報" visibleIf="NodeExists([custom/conditionLink])"
                           xpath="custom">
                  <input alwaysActive="true" editable="false" img="xtk:xtklinkn.png"
                         name="cc" noEditCollection="true" nolabel="true" prebuildSubForm="true"
                         type="customizeCondition" xpath="conditionLink" xpathSchema="/tmp/schema/@coupon"
                         xpathSelect="select/node" zoom="true">
                    <input xpath="@label"/>
                    <input xpath="@lineCount"/>
                    <input xpath="where/@displayFilter"/>
                    <input xpath="orderBy/@displayOrder"/>
                    <input hidden="true" xpath="@schema"/>
                    <form img="nms:pictoprofile.png" label="パーソナライゼーション情報を収集するためのフィルター"
                          type="wizard">
                      <container desc="保持するコレクション要素数を指定するために使用される情報を入力します。" name="parameters"
                                 title="一般パラメーター">
                        <static type="help">入力するフィルター条件を満たすコレクション要素が 1 つのみであることがわかっている場合は、\n
次のオプションを選択します (これによりサブクエリを回避でき、パフォーマンスが向上します)。</static>
                        <input xpath="@singleRow"/>
                        <container enabledIf="!@singleRow" type="enabledGroup">
                          <static type="help">返すコレクション要素の数。</static>
                          <input xpath="@lineCount"/>
                        </container>
                        <leave>
                          <if expr="@singleRow">
                            <set value="1" xpath="@lineCount"/>
                          </if>
                        </leave>
                      </container>
                      <container desc="保持するコレクション要素を指定するために使用されるフィルター条件を入力します。" name="where"
                                 title="フィルター">
                        <container buildQueryXPath="." ref="xtk:queryDef:where"/>
                      </container>
                      <container desc="候補のライン数があらかじめ指定した数よりも多い場合に、並べ替え順序を指定して維持するラインを指定します。"
                                 name="orderBy" title="並べ替え" visibleIf="@singleRow == false">
                        <input name="sortList" nolabel="true" toolbarCaption="列を並べ替え"
                               type="orderByList" xpath="orderBy/node" xpathCurrentLookupPath="/lookupPath/orderBy"
                               xpathHelp="/@help" zoom="false">
                          <input colSize="20" xpath="@label"/>
                          <input choiceType="sort" colSize="35" editable="true" type="pathedit"
                                 xpath="@expr" xpathSchema="../../@schema"/>
                          <input colSize="15" editable="true" xpath="@sortDesc"/>
                        </input>
                        <input type="help" xpath="/@help"/>
                      </container>
                    </form>
                  </input>
                </container>
              </form>
            </input>
          </container>
  <!--[cf]-->
          <static label="追加のスクリプトオブジェクト" type="separator"/>
          <container xpath="content">
            <input useDesc="true" xpath="@addExtraObject"/>
            <container type="visibleGroup" visibleIf="@addExtraObject">
              <input editable="false" nolabel="true" prebuildSubForm="false" type="list"
                     xpath="extraObject" zoom="true" zoomOnAdd="true">
                <input xpath="@jsName"/>
                <input xpath="@array"/>
                <input xpath="@schema"/>
                <input xpath="@startPath"/>
                <form label="追加のスクリプトオブジェクト" type="wizard">
                  <container desc="読み込むオブジェクトのスキーマとフィルター条件を指定してください。" title="オブジェクト定義">
                    <input noTransaction="false" schema="xtk:schema" type="schemaEdit"
                           xpath="@schema" xpathStartPath="@startPath"/>
                    <input checkSiblingNodes="true" exprDefault="Iif(@startPath!='/', ExtractRight(@startPath,'/'), ExtractRight(@schema,':'))"
                           type="dlvJsNameEdit" xpath="@jsName"/>
                    <input useDesc="true" xpath="@array"/>
                    <static type="help">このオプションを選択すると、JavaScript テーブルから複数のデータ行を取得できます。\n
  デフォルトでは、並べ替え順に従って 1 つのレコードのみが保持されます。</static>
                    <leave>
                      <if expr="@jsName=''">
                        <set expr="Iif(@startPath!='/', ExtractRight(@startPath,'/'), ExtractRight(@schema,':'))"
                             xpath="@jsName"/>
                      </if>
                    </leave>
                  </container>
                  <container desc="パーソナライゼーション用に読み込むオブジェクトのフィールドを指定してください。" name="load"
                             title="読み込むオブジェクトフィールド" visibleIf="@schema != ''">
                    <enter>
                      <set expr="@schema" xpath="/tmp/selectCtrl/in/@schema"/>
                      <set expr="@startPath" xpath="/tmp/selectCtrl/in/@startPath"/>
                      <set expr="@schema" xpath="custom/@schema"/>
                      <set expr="@startPath" xpath="custom/@startPath"/>
                    </enter>
                    <container extraColumns="@alias" ref="xtk:queryDef:hidden/selectCtrl"
                               showCollections="true" xpath="custom"/>
                  </container>
                  <container desc="データの並べ替え順序を指定します。" name="orderBy" title="並べ替え">
                    <container type="visibleGroup" visibleIf="@array==false">
                      <static type="help">複数の候補があった場合、保持するレコードを決定するために使用する並べ替え順を指定します。</static>
                    </container>
                    <container colcount="2" type="visibleGroup" visibleIf="@array">
                      <input label="取得されるレコード数を次に制限 :" xpath="@useLineCount"/>
                      <container enabledIf="@useLineCount" type="enabledGroup">
                        <input label=" " xpath="@lineCount"/>
                      </container>
                      <static colspan="2" type="help">JavaScript テーブルのレコードの並べ替え順を指定します。</static>
                    </container>
                    <input name="sortList" nolabel="true" toolbarCaption="列を並べ替え"
                           type="orderByList" xpath="orderBy/node" xpathChoiceTarget="@expr"
                           xpathCurrentLookupPath="/lookupPath/orderBy" xpathHelp="/@help"
                           zoom="false">
                      <input colSize="20" xpath="@label"/>
                      <input choiceType="sort" colSize="35" editable="true" type="pathedit"
                             xpath="@expr" xpathSchema="../../@schema"/>
                      <input colSize="15" editable="true" xpath="@sortDesc"/>
                    </input>
                    <input type="help" xpath="/@help"/>
                  </container>
                  <container desc="JavaScript オブジェクトのプロパティの選択に使用するフィルター条件を以下で指定します。"
                             name="where" title="フィルター">
                    <container style="flat" type="notebook">
                      <container label="条件">
                        <container buildQueryXPath="." ref="xtk:queryDef:where"/>
                      </container>
                      <container label="プレビュー">
                        <input hideEditButtons="true" name="entityPreviewQuery" noToolbar="true"
                               nolabel="true" type="filterPreviewList" xpath="."
                               xpathSchema="@schema" xpathTargetPart="."/>
                      </container>
                    </container>
                  </container>
                  <container desc="コレクションリンクごとにフィルター条件と並べ替え順序を編集してください。リンク済みレコードの読み込みを制限するために使用します。"
                             name="extraObjectCustomLinks" title="コレクションのパーソナライゼーション情報"
                             visibleIf="NodeExists([custom/conditionLink])" xpath="custom">
                    <container ref="xtk:exportSource:lib/conditionLinkRef"/>
                  </container>
                </form>
              </input>
            </container>
            <static type="help">分析フェーズの間、追加のスクリプトオブジェクトが読み込まれます。これらのオブジェクトは、配信のすべての受信者で同じです。</static>
          </container>
        </container>
  <!--[cf]-->
  <!--[of]:Typology-->
        <container colcount="2" label="タイポロジ" propagateConstraints="false" visibleIf="EV(@deliveryMode, 'descriptive')=false">
          <container colspan="2" label="タイポロジ" type="frame">
            <input colspan="2" label="タイポロジ" notifyPathList="@IPAffinity" xpath="typology"/>
            <static colspan="2" type="help">タイポロジとは、分析フェーズですべてのメッセージに対して実行される一連の検証ルールのことです。</static>
          </container>
          <container applicableIf="HasPackage('nms:campaignOptimization')" colspan="2"
                     label="頻度パラメーター" type="frame" xpath="forecast">
      <!-- message weight -->
            <input xpath="@weightType"/>
            <container type="visibleGroup" visibleIf="EV(@weightType, 'constant')">
              <input width="7" xpath="@weight"/>
            </container>
            <container type="visibleGroup" visibleIf="EV(@weightType, 'formula')">
              <input label="数式" nolabel="false" schemaExpr="GetLinkSchema([/delivery/mapping/@schema], [/delivery/mapping/@recipientLink])"
                     type="pathEdit" xpath="weightFormula"/>
            </container>

            <static type="help">配信の重み付けは、「頻度」タイポロジルールに配信の優先順位を指定するために使用されます。</static>
            <container applicableIf="HasPackage('nms:campaign')" type="visibleGroup"
                       visibleIf="[../@operation-id]!=0">
              <input readOnly="true" xpath="../validation/@sandboxMode"/>
              <input xpath="../validation/@sandboxModeEnforced"/>
            </container>
            <container applicableIf="HasPackage('nms:campaign')" type="visibleGroup"
                       visibleIf="[../@operation-id]==0">
              <input xpath="../validation/@sandboxMode"/>
            </container>
            <container type="visibleGroup" visibleIf="HasPackage('nms:campaign')==false">
              <input xpath="../validation/@sandboxMode"/>
            </container>
          </container>

          <container applicableIf="HasPackage('nms:campaignOptimization')" colspan="2"
                     label="処理能力設定" type="frame" xpath="volume">
            <input createMode="none" fullLoad="true" img="nms:periodVolume.png" xpath="rule">
              <sysFilter>
                <condition expr="@active=1"/>
                <condition expr="@ruleType='volume'"/>
                <condition>
                  <condition boolOperator="OR" enabledIf="$(../@messageType)!=''"
                             expr="@messageType=$(../@messageType)"/>
                  <condition expr="@messageType=127"/>
                </condition>
              </sysFilter>
            </input>
            <static label="受信者の重要度" type="separator"/>
            <input label="数式" nolabel="false" schemaExpr="GetLinkSchema([/delivery/mapping/@schema], [/delivery/mapping/@recipientLink])"
                   type="pathEdit" xpath="weightFormula"/>
            <static type="help">受信者の重要度は、「処理能力」タイポロジルールが超過した場合にどの受信者を保持し送信対象とするかを決定するために使用します。</static>
            <container type="visibleGroup" visibleIf="EV([../@messageType], 'phone') or [../@messageType]=5">
              <static img="nms:phone.png" label="使用済み容量の推定" type="separator"/>
              <input xpath="@rate"/>
              <input xpath="@duration"/>
            </container>
          </container>
        </container>
  <!--[cf]-->
  <!--[of]:Delivery-->
        <container colcount="2" label="配信" propagateConstraints="false" visibleIf="@deliveryMode!=0 and EV(@deliveryMode, 'descriptive')=false">
          <container colcount="2" colspan="2" label="配信" type="frame">
            <input colspan="2" xpath="@priority"/>
            <input colspan="2" width="7" xpath="advancedParameters/@splitValue"/>
            <container colcount="2" colspan="2" type="visibleGroup" visibleIf="EV(@deliveryMode, 'external')==false">
              <input label="複数のウェーブを使用して送信" xpath="scheduling/waves/@enabled"/>
              <container type="visibleGroup" visibleIf="[scheduling/waves/@enabled]">
                <input label="ウェーブを定義..." nolabel="true" prebuildSubForm="true" type="subFormLink">
                  <form label="ウェーブの定義" maxLabelWidth="60" xpath="scheduling/waves">
                    <input checkedValue="0" label="同じサイズの複数のウェーブをスケジュール" type="RadioButton"
                           xpath="@mode"/>
                    <container colcount="2" enabledIf="EV(@mode, 'split')" type="enabledGroup">
                      <input xpath="@splitSize"/>
                      <input xpath="@splitDelay"/>
                    </container>
                    <input checkedValue="1" label="カレンダーに従ってウェーブをスケジュール" type="RadioButton"
                           xpath="@mode"/>
                    <container enabledIf="EV(@mode, 'calendar')" type="enabledGroup">
                      <input editable="true" label="カレンダー" type="list" xpath="calendar/calendarItem">
                        <input colSize="20" xpath="@start"/>
                        <input colSize="50" xpath="@size"/>
                      </input>
                    </container>
                    <static type="help">開始または期間では、2 つの連続したウェーブを開始する時間差を指定します。サイズは、ウェーブ内のメッセージ数を絶対数または割合で指定します。</static>

                    <leave>
                      <soapCall name="ValidateWavesDefinition" service="nms:delivery">
                        <param exprIn="[scheduling/waves]" type="DOMElement"/>
                        <param type="DOMElement" xpathOut="scheduling/waves"/>
                      </soapCall>
                    </leave>

                  </form>
                </input>
              </container>
            </container>
            <container colspan="2" type="visibleGroup" visibleIf="EV(@messageType, 'mail')">
              <input xpath="advancedParameters/@verifyMode"/>
              <input xpath="advancedParameters/@emailArchiving"/>
            </container>
            <container colspan="2" type="visibleGroup" visibleIf="EV(@messageType, 'sms')"
                       xpath="smsParameters">
              <static label="SMS パラメーター" type="separator"/>
              <input menuId="deliveryMenuBuilder" type="scriptEdit" xpath="@sourceAddress"/>
              <container type="visibleGroup" visibleIf="[../deliveryProvider/@mobileConnector] == 4">
                <input xpath="@serviceType"/>
              </container>
              <container type="visibleGroup" visibleIf="[../deliveryProvider/@mobileConnector] == 4 or [../deliveryProvider/@mobileConnector] == 127">
                <input xpath="@mbloxServiceId"/>
              </container>
              <input xpath="@smsMode"/>
              <input xpath="@smsPriority"/>
              <input xpath="@smsAppType"/>
              <input maxValue="255" minValue="0" xpath="@maxSmsPerMessage"/>
              <container type="visibleGroup" visibleIf="[../deliveryProvider/@mobileConnector]&gt;=2">
                <static label="文字エンコーディング" type="separator"/>
                <container xpath="../advancedParameters">
                  <input useDesc="true" xpath="@forceCodepage"/>
                  <container type="visibleGroup" visibleIf="@forceCodepage">
                    <input defaultIfInvalid="GSM7" enum="nms:extAccount:smppCharset"
                           noInvalidErr="true" xpath="@codepage"/>
                  </container>
                </container>
              </container>
            </container>
          </container>
          <container colspan="2" label="再試行" type="frame">
            <container xpath="mailParameters">
              <input width="7" xpath="../execution/@retryPeriod"/>
              <input width="7" xpath="../execution/@maxRetry"/>
              <static type="help">最初の試行の後、エラーのあるメッセージに対して再試行が実行されます。また、再試行は配信期間が終わるまで毎日おこなわれます。</static>
            </container>
          </container>
          <container colspan="2" type="visibleGroup" visibleIf="EV(@messageType, 'mail')">
            <container label="メールフォーマット" type="frame">
              <container margin-left="40">
                <container enabledIf="[mapping/@format] != ''" type="enabledGroup">
                  <input checkedValue="preferences" label="受信者の環境設定を使用" type="RadioButton"
                         xpath="content/@formatSelection"/>
                </container>
                <input checkedValue="multipart" label="受信者のメールクライアントに最適なフォーマットを選択させる (マルチパート /オルタナティブ)"
                       type="RadioButton" xpath="content/@formatSelection"/>
                <input checkedValue="text" label="すべてのメッセージをテキストフォーマットで送信 (ミラーページには HTML を使用)"
                       type="RadioButton" xpath="content/@formatSelection"/>
                <container margin-left="20" type="visibleGroup" visibleIf="EV([content/@formatSelection], 'multipart') and [mapping/@format] != ''">
                  <static img="xtk:logwarn.png">受信者の E メールリーダーに選択させる場合は、両方のバージョンのドキュメントがマルチパート /オルタナティブフォーマットを使用して送信されます。\nそのため、このオプションを使用すると配信のスループットが低下します。</static>
                </container>
                <container margin-left="20" type="visibleGroup" visibleIf="EV([content/@formatSelection], 'text')">
                  <static img="xtk:logwarn.png">メッセージは、すべての受信者に対してテキストフォーマットで送信されます。HTML フォーマットはミラーページに対してのみ定義されます。</static>
                </container>
              </container>
            </container>
          </container>
        </container>
  <!--[cf]-->
  <!--[of]:Validity-->
        <container label="有効性" propagateConstraints="false" visibleIf="[/delivery/@deliveryMode]!=2">
          <container label="有効期間" type="frame">
            <container type="visibleGroup" visibleIf="![scenario/@setDirectDates]">
              <input xpath="scenario/@validityDuration"/>
            </container>
            <container type="visibleGroup" visibleIf="[scenario/@setDirectDates]">
              <input xpath="scheduling/@validityDate"/>
            </container>
            <container type="visibleGroup" visibleIf="[scenario/@setDirectDates] == false">
              <input xpath="scenario/@webValidityDuration"/>
            </container>
            <container type="visibleGroup" visibleIf="[scenario/@setDirectDates]">
              <input xpath="scheduling/@webValidityDate"/>
            </container>
            <input nolabel="false" xpath="scenario/@setDirectDates"/>
            <static type="help">配信期間は、メッセージを送信できる期間を示します。\nリソースの有効期間は、配信で参照されるリソース (ミラーページ、画像など) が保持される期間を示します。</static>
          </container>
          <container type="visibleGroup" visibleIf="@messageType=0 OR @messageType=1 OR @messageType=41 OR @messageType=42">
            <container label="ミラーページ管理" type="frame" xpath="mailParameters">
              <input label="モード" useDesc="true" xpath="@mirrorPagePolicy"/>
              <container type="visibleGroup" visibleIf="EV(@mirrorPagePolicy,'default')">
                <static type="help">ミラーページは必要な場合にのみ生成されます。</static>
              </container>
              <container type="visibleGroup" visibleIf="EV(@mirrorPagePolicy,'fromMsgId')">
                <static type="help">このオプションは、送信された各メッセージのコンテンツを視覚化するために必要です。ミラーページのプレビューには配信ログのリストからアクセスできます。</static>
              </container>
            </container>
          </container>

          <container label="トラッキング" type="frame">
            <container type="visibleGroup" visibleIf="![scenario/@setDirectDates]">
              <input label="有効期間" xpath="scenario/@trackingDuration"/>
            </container>
            <container type="visibleGroup" visibleIf="[scenario/@setDirectDates]">
              <input xpath="tracking/@expiration"/>
            </container>
            <static type="help">ここでトラッキングサーバー上のリダイレクト URL の有効期間を指定できます。</static>
            <static label="期限切れリダイレクト URL の代替 URL" type="Separator"/>
            <input label="URL" xpath="tracking/@errorUrl"/>
          </container>
        </container>
  <!--[cf]-->
  <!--[of]:SMTP-->
        <container label="SMTP" propagateConstraints="false" visibleIf="EV(@messageType, 'mail') and EV(@deliveryMode, 'external', 'descriptive')=false">
          <container type="visibleGroup" visibleIf="EV(@messageType, 'mail') and IsUnicode()"
                     xpath="advancedParameters">
            <container label="文字エンコーディング" type="frame">
              <input useDesc="true" xpath="@forceCodepage"/>
              <container type="visibleGroup" visibleIf="@forceCodepage">
                <input xpath="@codepage"/>
              </container>
            </container>
          </container>

          <container label="バウンスメール" type="frame" xpath="mailParameters">
            <input label="プラットフォームに定義されたデフォルトのエラーアドレスを使用" type="checkbox" xpath="@useDefaultErrorAddress"/>
            <container type="visibleGroup" visibleIf="@useDefaultErrorAddress==false">
              <input img="nms:sendemail.png" menuId="deliveryMenuBuilder" type="scriptEdit"
                     xpath="errorAddress"/>
            </container>
            <static type="help">配信のバウンスメール (メーラーデーモン) を誤ったアドレスで受信しました。このバウンスメールは inMail プロセスで自動的に分析されます。</static>
            <input img="nms:sendemail.png" menuId="deliveryMenuBuilder" type="scriptEdit"
                   xpath="bounceAddress"/>
            <static type="help">未処理のバウンスメールは、次のアドレスが提供されている場合はそのアドレスに転送されます。それ以外の場合は、インスタンスに対して定義されているデフォルトの転送アドレスに転送されます。</static>
          </container>

          <static label="追加の SMTP ヘッダー" type="separator"/>
          <container xpath="mailParameters">
            <input fullToolbar="true" htmlMode="false" nolabel="true" type="htmlSource"
                   xpath="headers" xpathInsert="/ignored/customizeSMTPHeaders" xpathUrl="/tmp/urlTree/@toSelect">
              <container>
                <input menuId="deliveryMenuBuilder" type="customizeBtn" xpath="/ignored/customizeSMTPHeaders"/>
              </container>
            </input>
            <static type="help">このスクリプトは追加の SMTP ヘッダーを\n1 行に 1 ヘッダーのリスト (name: value) として返すことができます。必要に応じて値は自動的にエンコードされます。</static>
          </container>

        </container>
  <!--[cf]-->
  <!--[of]:Variables-->
        <container label="変数" propagateConstraints="false" visibleIf="[/delivery/@deliveryMode]!=2"
                   xpath="variables">
          <input editable="false" nolabel="true" prebuildSubForm="false" toolbarAlign="horizontal"
                 type="list" xpath="var" xpathRefresh="/delivery/variables/var*"
                 zoom="true" zoomOnAdd="true">
            <input editable="true" xpath="@name"/>
            <input editable="true" xpath="desc"/>
            <input editable="true" xpath="@required"/>
            <input xpath="@dataType"/>
            <input label="値" xpath="Iif(![@calculated],Iif([@dataType]==7,@timeStampValue,Iif([@dataType]==6,@stringValue,Iif([@dataType]==5,@doubleValue,Iif([@dataType]==3,@longValue,memoValue)))),'')"/>
            <input label="式" xpath="Iif([@calculated],expr,'')"/>
            <form label="配信パラメーターの定義">
              <input xpath="@name"/>
              <input xpath="@required"/>
              <input xpath="desc"/>
              <input xpath="@dataType"/>
              <container type="visibleGroup" visibleIf="!@calculated">
                <container ref="xtk:option:editVariantValue"/>
              </container>
              <container type="visibleGroup" visibleIf="@calculated">
                <input nolabel="false" type="pathEdit" xpath="expr" xpathSchema="/tmp/schema/@delivery"/>
              </container>
              <input xpath="@calculated"/>
            </form>
          </input>
          <static type="help">配信パラメーターは、配信のすべてのメッセージで同一の値を定義するために使用します。これらのパラメーターはクエリエディターおよびパーソナライゼーションスクリプトで使用できます。</static>
        </container>
  <!--[cf]-->
  <!--[of]:validations-->
        <container applicableIf="HasPackage('nms:campaign')" label="承認" propagateConstraints="false"
                   visibleIf="[/delivery/@operation-id]!=0 and [/ignored/@useValidation] and [/ignored/@dlvNotReady]='' and [/delivery/@FCP]=0 and EV([/delivery/@deliveryMode], 'descriptive')=false">
          <container colcount="2" readOnlyIf="[/tmp/@readOnly] and HasNamedRight('approvalAdministration')=false"
                     type="readOnlyGroup">
            <container colcount="2" colspan="2" label="ジョブの検証" type="frame" xpath="validation">
              <container colspan="2" readOnlyIf="HasNamedRight('approvalAdministration')=false or [../@state] &gt; Eval([../@state], 'ready')"
                         type="readOnlyGroup">
                <container colcount="2" colspan="2" ref="nms:delivery:lib/validation"/>
              </container>
            </container>
          </container>
        </container>
  <!--[cf]-->
  <!--[of]:Advanced-->
        <container label="詳細設定" propagateConstraints="false" visibleIf="EV(@deliveryMode, 'descriptive')=false">
          <container applicableIf="HasPackage('nms:campaign')" type="visibleGroup"
                     visibleIf="[@operation-id]!=0 and EV(@deliveryMode, 'descriptive')=false">
            <container label="スケジューラーによるメッセージの準備" type="frame" xpath="scheduling/messagePreparation">
              <input xpath="@priority"/>
              <input useDesc="true" xpath="@forecasted"/>
            </container>
          </container>
          <container applicableIf="HasPackage('nms:campaign')" type="visibleGroup"
                     visibleIf="[@linkedDelivery-id]=0">
            <container type="visibleGroup" visibleIf="EV(@deliveryMode, 'external')">
              <container label="抽出ファイル" type="frame">
                <input label="ファイル名計算スクリプト" menuId="deliveryMenuBuilder" type="scriptEdit"
                       xpath="output/outputScript"/>
                <container applicableIf="HasPackage('nms:campaign')" type="visibleGroup"
                           visibleIf="[@operation-id]!=0">
                  <input label="ローカルにダウンロードできるようファイルを有効にする" xpath="output/@downloadDestFile"/>
                </container>
              </container>
            </container>
      <!--NEO-9792 only visible for External delivery and editable within a template-->
            <container readOnlyExpr="@isModel==0" type="visiblegroup" visibleIf="EV(@deliveryMode, 'external')=true">
              <container label="日付計算式" type="frame">
                <input label="計算式を使用" type="checkBox" xpath="/tmp/@hasDateExpr"/>
                <container enabledIf="[/tmp/@hasDateExpr]" type="enabledGroup" xpath="scheduling">
                  <container type="visibleGroup" visibleIf="EV([../@deliveryMode], 'external')">
                    <input label="ファイルの抽出日" nolabel="false" schema="nms:delivery"
                           type="pathEdit" xpath="@extractionExpr"/>
                    <input label="コンタクト日" nolabel="false" schema="nms:delivery" type="pathEdit"
                           xpath="@contactDateExpr"/>
                  </container>
                  <container type="visibleGroup" visibleIf="[../@isModel]">
                    <input label="予約配信 (予約された日になると自動実行)" xpath="@delayed"/>
                  </container>
                </container>
              </container>
            </container>
          </container>
          <container applicableIf="HasPackage('nms:campaign')" type="visibleGroup"
                     visibleIf="[@linkedDelivery-id]=0 and (([@operation-id]!=0 and EV(@deliveryMode, 'external')=false) or (@isModel and [@operation-id]=0))">
            <container ref="nms:delivery:lib/supplier"/>
          </container>
          <container applicableIf="HasPackage('nms:campaign')" type="visibleGroup"
                     visibleIf="[@operation-id]!=0 and EV(@deliveryMode, 'external')=false">
            <container label="配信の概要" type="frame">
              <input createMode="none" fullLoad="true" xpath="deliveryOutline">
                <sysFilter>
                  <condition expr="[@operation-id]=$(@operation-id)"/>
                  <condition>
                    <condition boolOperator="OR" expr="@messageType=$(@messageType)"/>
                    <condition expr="@messageType=127"/>
                  </condition>
                </sysFilter>
              </input>
            </container>
          </container>
          <container applicableIf="HasPackage('nms:coupon')">
            <container label="クーポン管理" type="frame">
              <input notifyPathList="@id,@code,@type" xpath="coupon"/>
            </container>
          </container>
          <container applicableIf="HasPackage('ncm:content')" type="visibleGroup"
                     visibleIf="EV(@deliveryMode, 'external')=false and EV(@deliveryMode, 'descriptive')=false">
            <container label="コンテンツテンプレート" type="frame">
              <input label="テンプレート" xpath="publishing"/>
            </container>
          </container>
          <container type="visibleGroup" visibleIf="EV(@deliveryMode, 'external')==false and EV(@deliveryMode, 'descriptive')=false">
            <input xpath="/delivery/@contentEditingMode">
              <enter name="onChange">
                <if expr="[/delivery/@contentEditingMode]=0">
                  <set expr="false" xpath="@useDce"/>
                  <set expr="false" xpath="@useAEM"/>
                </if>
                <if expr="[/delivery/@contentEditingMode]=1">
                  <set expr="true" xpath="@useDce"/>
                  <set expr="false" xpath="@useAEM"/>
                </if>
                <if expr="[/delivery/@contentEditingMode]=2">
                  <set expr="false" xpath="@useDce"/>
                  <set expr="true" xpath="@useAEM"/>
                </if>
              </enter>
            </input>
            <container applicableIf="HasPackage('nms:aemIntegration')" type="visibleGroup"
                       visibleIf="[/delivery/@contentEditingMode]=2 OR [/delivery/@contentEditingMode]=1">
              <input xpath="cmsAccount">
                <sysFilter>
                  <condition expr="@type=12"/>
                </sysFilter>
                <enter name="onChange">
                  <if expr="[cmsAccount/@id] !=0">
                    <set expr="true" xpath="@useAEM"/>
                  </if>
                </enter>
              </input>
            </container>
          </container>
          <container type="visibleGroup" visibleIf="@FCP=false and EV(@deliveryMode, 'descriptive')=false">
            <input img="nms:bat.png" label="配達確認のプロパティ..." type="subFormLink" xpath=".">
              <form label="配達確認のプロパティ">
                <container label="パラメーター" type="frame">
                  <container enabledIf="[targets/@deduplicate] or [targets/@noRcpIdDedup] == false"
                             type="enabledGroup">
                    <input useDesc="true" xpath="fcpParameters/@ignoreDeduplicate"/>
                  </container>
                  <container enabledIf="[targets/@useBlackList]" type="enabledGroup">
                    <input useDesc="true" xpath="fcpParameters/@ignoreBlacklist"/>
                  </container>
                  <container enabledIf="[targets/@useQuarantine]" type="enabledGroup">
                    <input useDesc="true" xpath="fcpParameters/@ignoreQuarantaine"/>
                  </container>

                  <container type="visibleGroup" visibleIf="EV(@deliveryMode, 'external')"
                             xpath="fcpParameters">
                    <static img="xtk:export.png" label="特定の出力ファイルを使用" type="separator"/>
                    <input useDesc="true" xpath="@useSpecificOutputFile"/>
                    <container label="特定の出力ファイル" type="frame">
                      <container enabledIf="@useSpecificOutputFile" type="enabledGroup"
                                 xpath="fcpOutput">
                  <!-- just for factorization -->
                        <input useDesc="true" xpath="@downloadDestFile"/>
                        <container type="visibleGroup" visibleIf="@downloadDestFile">
                          <input defExt="txt" filters="テキストファイル (*.txt;*.tab)|*.txt;*.tab|CSV ファイル (*.csv)|*.csv|XML ファイル (*.xml)|*.xml|すべて (*.*)|*.*|"
                                 label="ローカルファイル" required="true" type="saveFileEdit"
                                 xpath="@fileName"/>
                        </container>
                        <container type="visibleGroup" visibleIf="@downloadDestFile = 'false'">
                          <input menuId="deliveryMenuBuilder" type="scriptEdit" xpath="outputScript"/>
                        </container>
                      </container>
                    </container>
                  </container>

                  <static label="配達確認のラベル" type="separator"/>
                  <input nolabel="false" xpath="fcpParameters/@keepDeliveryCode"/>
            <!-- else label is directly editable -->
                  <input xpath="fcpParameters/@labelPrefix"/>
                  <container type="visibleGroup" visibleIf="EV(@messageType, 'mail')">
                    <container type="visibleGroup" visibleIf="EV([fcpParameters/@fcpMailFormat], 'normal') == false">
                      <input nolabel="true" useDesc="true" xpath="fcpParameters/@addFormatInPrefix"/>
                    </container>
                  </container>
                </container>
              </form>
            </input>
          </container>

        </container>
  <!--[cf]-->
        <leave>
          <if expr="HasPackage('nms:campaign')">
            <check expr="[validation/@assignEdition]=false or [validation/@useContentValidation]=false or [validation/edition/@primaryAssignee-id]!=0">
              <error>コンテンツを編集するオペレーターを選択してください。</error>
            </check>
            <check expr="[validation/@externalValidation]=false or [validation/@useContentValidation]=false or [validation/external/@primaryAssignee-id]!=0">
              <error>外部コンテンツ検証を担当するオペレーターを入力してください。</error>
            </check>
          </if>
          <if expr="[scenario/@setDirectDates]=0 and [scheduling/@contactDate]!=''">
            <set expr="DateAdd([scheduling/@contactDate], [scenario/@validityDuration])"
                 xpath="scheduling/@validityDate"/>
          </if>
          <if expr="HasPackage('nms:campaign')">
            <if expr="[@workflow-id]=0 and [validation/@useTargetValidation]=false and ([validation/@useBudgetValidation] or ([validation/@useExtractionValidation] and EV(@deliveryMode, 'external')))">
            <!-- delivery created outise workflow : need to activate target approval if budget / extraction is selected -->
              <set value="true" xpath="validation/@useTargetValidation"/>
            </if>

            <if expr="[@operation-id]!=0 and [/delivery/@FCP]=0 and [/ignored/@useValidation]">
            <!-- change validation mode : confirm or not the delivery -->
              <if expr="[/tmp/@validationMode]=true">
                <set value="manual" xpath="scheduling/@validationMode"/>
              </if>
              <if expr="[/tmp/@validationMode]=false">
                <set value="auto" xpath="scheduling/@validationMode"/>
              </if>
            </if>
          </if>
          <if expr="HasPackage('nms:webAnalytics')">
            <set expr="Iif([@webAnalyticsAccount-id]!=0,false,true)" xpath="/ignored/@showTracking"/>
          </if>
        </leave>
      </form>
    </input>
  <!-- aem content link-->
    <input applicableIf="HasPackage('nms:aemIntegration')" img="nms:aemLink.png"
           label="同期" prebuildSubForm="false" type="flatSubFormButton" visibleIf="[/ignored/@isAEMContent]='true' and [/ignored/@isLinkedToContent]='false' and [/ignored/@currentPage]!='pageModel' and [/delivery/@state] &lt;= EVal([/delivery/@state], 'ready')">
      <form label="AEM コンテンツと同期">
        <enter>
          <set value="false" xpath="/ignored/@aemContentPicked"/>
        </enter>
        <input type="aemContentPicker"/>
        <leave>
          <set value="true" xpath="/ignored/@aemContentPicked"/>
          <soapCall name="aemLinkContent" service="nms:delivery">
            <param exprIn="/delivery" type="DOMElement"/>
            <param exprIn="[/tmp/@aemContentName]" type="string"/>
            <param type="DOMElement" xpathOut="/ignored/aemContent"/>
          </soapCall>
          <set expr="[/ignored/aemContent/@permalink]" xpath="remoteContent/@remotePath"/>
          <set expr="[/ignored/aemContent/@label]" xpath="remoteContent/@remoteLabel"/>
          <set expr="[/ignored/aemContent/@approved]" xpath="remoteContent/@remoteValidation"/>
          <set expr="GetDate()" xpath="remoteContent/@lastSync"/>
          <set expr="[/ignored/aemContent/subject]" xpath="mailParameters/subject"/>
          <set expr="[/ignored/aemContent/html]" xpath="content/html/source"/>
          <set expr="[/ignored/aemContent/text]" xpath="content/text/source"/>
        </leave>
      </form>
    </input>
    <input applicableIf="HasPackage('nms:aemIntegration')" img="nms:aemUnlink.png"
           label="同期解除" prebuildSubForm="false" type="flatSubFormButton" visibleIf="[/ignored/@isLinkedToContent]='true' and [/ignored/@currentPage]!='pageModel' and [/delivery/@state] &lt;= EVal([/delivery/@state], 'ready')">
      <form label="AEM コンテンツからの同期を解除">
        <enter>
          <setModified/>
          <set translatedExpr="'AEM コンテンツ '+[remoteContent/@remoteLabel]+' ('+[remoteContent/@remotePath]+') の同期を停止してもよろしいですか？'"
               xpath="/ignored/@aemUnlinkConfirmation"/>
        </enter>
        <value height="3" nolabel="true" xpath="/ignored/@aemUnlinkConfirmation"/>
        <leave>
          <soapCall name="aemUnlinkContent" service="nms:delivery">
            <param exprIn="/delivery" type="DOMElement"/>
            <param type="boolean" xpathOut="/ignored/@isUnlinked"/>
          </soapCall>
          <if expr="[/ignored/@isUnlinked]">
            <set expr="''" xpath="remoteContent/@remotePath"/>
            <set expr="''" xpath="remoteContent/@remoteLabel"/>
            <set expr="false" xpath="remoteContent/@remoteValidation"/>
            <set expr="GetDate()" xpath="remoteContent/@lastSync"/>
          </if>
        </leave>
      </form>
    </input>
  <!--[cf]-->
  <!--[of]:  Preview-->
    <input img="xtk:html.png" label="プレビュー" prebuildSubForm="false" type="flatSubFormButton"
           visibleIf="false">
      <form label="プレビュー" maxLabelWidth="50" readOnlyExpr="[/tmp/@readOnly]">
        <container type="notebook">
          <container img="xtk:html.png" label="HTML" name="htmlContent" visibleIf="EV(@messageType, 'mail')"
                     xpath="content/html/source">
            <container ref="nms:delivery:lib/content/HTML/htmlContentEditor/notebook/tabPreview"/>
          </container>
          <container img="xtk:textfile.png" label="テキスト" name="textContent" visibleIf="EV(@messageType, 'mail')"
                     xpath="content/text/source">
            <container ref="nms:delivery:lib/content/Text/textContentEditor/notebook/tabPreview"/>
          </container>
          <container img="nms:mobile.png" label="SMS" name="smsContent" visibleIf="EV(@messageType, 'sms') and EV([smsParameters/@mobileMsgType], 'sms', 'wapPush')"
                     xpath="smsParameters">
            <container ref="nms:delivery:edit/mobileDefinition/SMSProperties/parameters/smsContentEditor/notebook/tabPreview"/>
          </container>
          <container applicableIf="HasPackage('nms:social')" img="nms:facebook.png"
                     label="Facebook" name="facebookContent" visibleIf="EV(@messageType, 'facebook')"
                     xpath="content/html/source">
            <container ref="nms:delivery:lib/content/Facebook/facebookContentEditor/tabPreview"/>
          </container>
          <container applicableIf="HasPackage('nms:social')" img="nms:twitter.png"
                     label="ツイート" name="tweetContent" visibleIf="EV(@messageType, 'twitter')"
                     xpath="content/twitterMsg/source">
            <container ref="nms:delivery:lib/content/Tweet/tweetContentEditor/tabPreview"/>
          </container>
          <container applicableIf="HasPackage('nms:line') OR HasPackage('nms:lineV2')"
                     img="nms:line.png" label="LINE" name="lineContent" visibleIf="EV(@messageType, 'line')"
                     xpath="content/lineMessage/source">
            <container ref="nms:delivery:lib/content/Line/lineContentEditor/tabPreview"/>
          </container>
          <container applicableIf="HasPackage('nms:mobileApp')" img="nms:ios.png"
                     label="iOS" name="iOSContent" visibleIf="EV(@messageType, 'ios')"
                     xpath="content">
            <container ref="nms:delivery:lib/content/iOS/iOSContentEditor/tabPreview"/>
          </container>
          <container applicableIf="HasPackage('nms:mobileApp')" img="nms:android.png"
                     label="Android" name="androidContent" visibleIf="EV(@messageType, 'android')"
                     xpath="content">
            <container ref="nms:delivery:lib/content/android/androidContentEditor/tabPreview"/>
          </container>
        </container>
      </form>
    </input>
  <!--[cf]-->
  </container>
<!--[cf]-->

  <!-- readOnly depending on the delivery state -->
  <input expr="( !@isModel and @state &gt; EVal(@state, 'ready') ) or ( @midSourcing and EV(@state,'ready') )"
         type="expr" xpath="/tmp/@readOnly"/>

  <input applicableIf="HasPackage('nms:campaign')" expr="[@operation-id]" type="expr"
         xpath="/ignored/@operationId"/>

  <input applicableIf="HasPackage('nms:campaign')" expr="[validation/@useTargetValidation] and [@operation-id]!=0"
         type="expr" xpath="/ignored/@useTargetValidation"/>
  <input applicableIf="HasPackage('nms:campaign')" expr="[validation/@useContentValidation] and [@operation-id]!=0"
         type="expr" xpath="/ignored/@useContentValidation"/>

  <input applicableIf="HasPackage('nms:campaign')" expr="@contentStatus" type="expr"
         xpath="/ignored/@contentStatus"/>
  <input applicableIf="HasPackage('nms:campaign')" expr="@targetStatus" type="expr"
         xpath="/ignored/@targetStatus"/>

  <input applicableIf="HasPackage('nms:campaign')" expr="[@workflow-id]" type="expr"
         xpath="/ignored/tmp/@workflowId"/>

  <input applicableIf="HasPackage('nms:campaign')" expr="[/ignored/tmp/parameter/@useBudget] or [operation/parameter/@useBudget]"
         type="expr" xpath="/ignored/@useBudget"/>
  <input applicableIf="HasPackage('crm:lead')" expr="[/ignored/tmp/parameter/@useLandingPage] or [operation/parameter/@useLandingPage]"
         type="expr" xpath="/ignored/@useLandingPage"/>

  <input expr="[mapping/storage/@broadLogSchema]" type="expr" xpath="/ignored/@extractionSchema"/>

  <input alwaysActive="true" expr="Iif(EV([targets/@targetMode], 'file'), 'specificTarget', [fcpParameters/@fcpMode])"
         type="expr" xpath="fcpParameters/@fcpMode"/>

  <input applicableIf="HasPackage('nms:campaign')" expr="[targets/@deliveryLimitExpr]"
         type="expr" xpath="/ignored/@deliveryLimitExpr"/>
  <input applicableIf="HasPackage('nms:campaign')" expr="[scheduling/@extractionExpr]"
         type="expr" xpath="/ignored/@extractionExpr"/>
  <input applicableIf="HasPackage('nms:campaign')" expr="[scheduling/@contactDateExpr]"
         type="expr" xpath="/ignored/@contactDateExpr"/>

  <input applicableIf="HasPackage('nms:aemIntegration')" expr="Iif([/delivery/@contentEditingMode]=2, 'true', 'false')"
         type="expr" xpath="/ignored/@isAEMContent"/>
  <input applicableIf="HasPackage('nms:aemIntegration')" expr="Iif([/delivery/@contentEditingMode]=2 and [remoteContent/@remotePath] != '', 'true', 'false')"
         type="expr" xpath="/ignored/@isLinkedToContent"/>

<!--[of]:Library-->
  <container name="lib" type="visibleGroup" visibleIf="false">
<!--[of]:Mapping-->
    <container name="deliveryMapping">
      <input boldLineExpr="@builtIn = 1" createMode="none" noZoom="true" notifyPathList="@name, @label, @schema, @email, @fax, @sms, @paper, @phone, @agency, @format, @blackListEmail, @blackListSms, @blackListPhone, @blackListFax, @blackListPaper, @blackListAgency, @externalId, @recipientLink, @targetSchema, @countryCode, storage/@broadLogSchema, storage/@trackingLogSchema, storage/@exclusionType, storage/@broadLogExclSchema,storage/extraField/@dstXPath,storage/extraField/@srcExpr,@line,@blackListLine"
             xpath="."/>
    </container>
<!--[cf]-->
<!--[of]:Image Upload-->
    <container name="imageUpload" type="deliveryImageUploader" xpathCurProgress="/tmp/@uploadCurrent"
               xpathImageConfig="../imageConfig" xpathMaxProgress="/tmp/@uploadMax">
      <input name="JobLogsList" type="JobLogList"/>
      <container colcount="2">
        <value name="JobProgressBar" type="ProgressBar" valign="center" xpathCur="/tmp/@uploadCurrent"
               xpathMax="/tmp/@uploadMax"/>
        <input label="開始(&amp;S)" name="JobSubmitButton" type="flatbutton"/>
      </container>
    </container>
<!--[cf]-->
<!--[of]:Measure ROI-->
    <container name="measureROI">
      <container label="ROI 評価の設定" type="frame">
        <input xpath="@simuResponseType"/>
        <container type="visibleGroup" visibleIf="EV(@simuResponseType, 'formula')">
          <input nolabel="false" schemaExpr="GetLinkSchema([/delivery/mapping/@schema], [/delivery/mapping/@recipientLink])"
                 type="pathEdit" xpath="simuResponseRateFormula"/>
          <input nolabel="false" schemaExpr="GetLinkSchema([/delivery/mapping/@schema], [/delivery/mapping/@recipientLink])"
                 type="pathEdit" xpath="simuRevenueFormula"/>
          <static label="利益計算モード" type="separator"/>
          <input checkedValue="1" label="利益率 (%)" nolabel="false" type="radioButton"
                 xpath="@simuMarginType"/>
          <input checkedValue="0" label="単位当たりの利益" nolabel="false" type="radioButton"
                 xpath="@simuMarginType"/>
          <input nolabel="false" schemaExpr="GetLinkSchema([/delivery/mapping/@schema], [/delivery/mapping/@recipientLink])"
                 type="pathEdit" xpath="simuMarginFormula"/>
        </container>
        <container type="visibleGroup" visibleIf="EV(@simuResponseType, 'constant')">
          <input xpath="@simuResponseRate"/>
          <input xpath="@simuRevenue"/>
          <static label="利益計算モード" type="separator"/>
          <input checkedValue="1" label="利益率 (%)" nolabel="false" type="radioButton"
                 xpath="@simuMarginType"/>
          <input checkedValue="0" label="単位当たりの利益" nolabel="false" type="radioButton"
                 xpath="@simuMarginType"/>
          <input xpath="@simuMargin"/>
        </container>
      </container>
    </container>
<!--[cf]-->
<!--[of]:validation-->
    <container name="validation">
      <input nolabel="true" xpath="@useContentValidation"/>
      <container enabledIf="@useContentValidation" type="enabledGroup">
        <container colcount="2" ref="nms:operation:lib/assignee" xpath="content"/>
      </container>

      <container colcount="2" colspan="2" type="visibleGroup" visibleIf="@useContentValidation">
        <input xpath="@assignEdition"/>
        <container enabledIf="@assignEdition" type="enabledGroup">
          <container colcount="2" ref="nms:operation:lib/assignee" xpath="edition"/>
        </container>
        <input xpath="@externalValidation"/>
        <container enabledIf="@externalValidation" type="enabledGroup">
          <container colcount="2" ref="nms:operation:lib/assignee" xpath="external"/>
        </container>

        <container colcount="2" colspan="2" type="visibleGroup" visibleIf="EV([../@deliveryMode], 'external') and EV([../@deliveryMode], 'descriptive')=false">
          <input xpath="@useFCPValidation"/>
          <static/>
        </container>
        <container colcount="2" colspan="2" type="visibleGroup" visibleIf="EV([../@deliveryMode], 'external')=false and EV([../@deliveryMode], 'descriptive')=false">
          <input label="配達確認の送信を有効にする" xpath="@useFCPValidation"/>
          <static/>
        </container>
      </container>

      <container colcount="2" colspan="2" type="visibleGroup" visibleIf="EV([../@deliveryMode], 'descriptive')=false">
        <input nolabel="true" xpath="@useTargetValidation"/>
        <container enabledIf="@useTargetValidation" type="enabledGroup">
          <container colcount="2" ref="nms:operation:lib/assignee" xpath="target"/>
        </container>
      </container>
      <container colcount="2" colspan="2" type="visibleGroup" visibleIf="[/ignored/@useBudget]">
        <input nolabel="true" xpath="@useBudgetValidation"/>
        <container enabledIf="@useBudgetValidation" type="enabledGroup">
          <container colcount="2" ref="nms:operation:lib/assignee" xpath="budget"/>
        </container>
      </container>
      <container colcount="2" colspan="2" type="visibleGroup" visibleIf="EV([../@deliveryMode], 'external') and [/ignored/@hasParentDelivery]!=1">
        <input nolabel="true" xpath="@useExtractionValidation"/>
        <container enabledIf="@useExtractionValidation" type="enabledGroup">
          <container colcount="2" ref="nms:operation:lib/assignee" xpath="extraction"/>
        </container>
      </container>
      <container colcount="2" colspan="2" type="visibleGroup" visibleIf="EV([../validation/@sandboxMode], 'sandbox') AND EV([../validation/@sandboxModeEnforced],'operationDriven')">
        <static img="nms:businessRanking.png" label="暫定カレンダーに統合 :"/>
        <container colcount="2" ref="nms:operation:lib/assignee" xpath="forecast"/>
      </container>
      <container colcount="2" colspan="2" type="visibleGroup" visibleIf="EV([../@deliveryMode], 'external')=false and EV([../@deliveryMode], 'descriptive')=false and [/ignored/@hasParentDelivery]!=1">
        <static img="nms:campaign.png" label="配信開始 :"/>
        <container colcount="2" ref="nms:operation:lib/assignee" xpath="starting"/>
      </container>

      <container colcount="2" colspan="2" type="visibleGroup" visibleIf="EV([../@deliveryMode], 'external') and @useContentValidation=false">
    <!-- Specific there for external delivery : enable/disable FCP approval once file has been extracted -->
        <input colspan="2" label="配達確認の検証を有効にする" nolabel="true" xpath="@useFCPValidation"/>
      </container>

      <container colspan="2" type="visibleGroup" visibleIf="EV([../@deliveryMode], 'descriptive')=false and EV([../@deliveryMode], 'external')=false and [/ignored/@hasParentDelivery]!=1">
        <input label="送信前に配信を確定する" nolabel="true" type="checkbox" xpath="/tmp/@validationMode"/>
      </container>

      <container colspan="2" type="visibleGroup" visibleIf="EV([../@deliveryMode], 'descriptive')=false">
        <static type="separator"/>
        <input readOnly="true" xpath="@sandboxMode"/>
      </container>
    </container>
<!--[cf]-->
<!--[of]:Extraction-->
    <container name="extraction">
      <container ref="nms:delivery:lib/deliveryLimitDef"/>
      <container>
        <static label="抽出される母集団のサイズを制限します。ゼロに設定すると、ターゲットとなり得るすべてのメンバーが抽出されます。" type="help"/>
      </container>

      <container applicableIf="HasPackage('nms:campaign')" colspan="2" type="visibleGroup"
                 visibleIf="[@operation-id]!=0">
        <container type="visibleGroup" visibleIf="[@deliveryOutline-id]=0">
          <input img="nms:deliveryOutline.png" label="配信の概要を選択..." nolabel="true"
                 prebuildSubForm="false" type="subFormLink" xpath="deliveryOutline">
            <form label="配信の概要を選択" nothingToSave="true">
              <input img="nms:deliveryOutline.png" monoSelection="true" schema="nms:deliveryOutline"
                     toolbarCaption="配信の概要のリスト" type="linkListChoice" xpath="." xpathOut="/ignored/deliveryOutlineList">
                <input xpath="[.]"/>
                <sysFilter>
                  <condition expr="[@operation-id]=$(../@operation-id)"/>
                  <condition>
                    <condition boolOperator="OR" expr="@messageType=$(../@messageType)"/>
                    <condition expr="@messageType=127"/>
                  </condition>
                </sysFilter>
              </input>
              <leave>
                <set expr="[/ignored/deliveryOutlineList/deliveryOutline/@id]" xpath="@id"/>
                <set expr="[/ignored/deliveryOutlineList/deliveryOutline/@_cs]" xpath="@_cs"/>
                <set expr="[/ignored/deliveryOutlineList/deliveryOutline/@id]" xpath="../@deliveryOutline-id"/>
              </leave>
            </form>
          </input>
        </container>
        <container colspan="2" padding-right="10" type="visibleGroup" visibleIf="[@deliveryOutline-id]!=0">
          <input createMode="none" fullLoad="true" xpath="deliveryOutline" xpathRefresh="/ignored/deliveryOutlineList/deliveryOutline">
            <sysFilter>
              <condition expr="[@operation-id]=$(@operation-id)"/>
              <condition>
                <condition boolOperator="OR" expr="@messageType=$(@messageType)"/>
                <condition expr="@messageType=127"/>
              </condition>
            </sysFilter>
          </input>
        </container>
      </container>
    </container>
    <container name="extractionDef">
      <input img="nms:extraction.png" label="抽出ファイルのフォーマットを編集..." nolabel="false"
             prebuildSubForm="false" type="subFormLink" xpath=".">
        <form img="xtk:export32.png" label="抽出ファイルフォーマット" type="wizard">
          <enter>
        <!-- make sure targetData/x and offerView/y can be declared -->
            <set value="1" xpath="/tmp/@useTargetingDimension"/>
            <if expr="[/tmp/@schemaChoice]=''">
              <set value="0" xpath="/tmp/@useTargetingDimension"/>
              <set expr="[../mapping/storage/@broadLogSchema]" xpath="extraction/source/@schema"/>
          <!-- set input parameters for selectCtrl -->
              <set expr="[../mapping/storage/@broadLogSchema]" xpath="/tmp/selectCtrl/in/@schema"/>
              <set value="export" xpath="/tmp/selectCtrl/in/@choiceType"/>
            </if>
            <if expr="HasPackage('nms:purl')">
              <set value="true" xpath="/tmp/selectCtrl/in/@addPURL"/>
            </if>

            <if expr="FieldExists([/tmp/selectCtrl/in/@schema], 'targetData')=false and [/ignored/@operationId]!=0 and [/ignored/tmp/@workflowId]!=0">
          <!-- Delivery operation openned outside workflow : check if its columns use targetData-->
              <set value="0" xpath="/ignored/@hasTargetData"/>
              <forEach xpath="extraction/source/select/node">
                <if expr="StartWith(@expr, '[targetData/')">
                  <set value="1" xpath="/ignored/@hasTargetData"/>
                </if>
              </forEach>

              <if expr="[/ignored/@hasTargetData]=1">
            <!-- Need to extend current schema to add targetData element in its context -->
                <set expr="mappingSchemaExt([/tmp/selectCtrl/in/@schema])" xpath="/tmp/selectCtrl/in/@schema"/>
              </if>
            </if>
          </enter>

          <container desc="抽出するファイルのターゲティングディメンションを選択します。" title="ターゲティングディメンション"
                     visibleIf="[/tmp/@schemaChoice]!=''">
            <input checkedValue="1" label="ターゲティングディメンションから配信ログを抽出" nolabel="true"
                   type="radioButton" xpath="/tmp/@useTargetingDimension"/>
            <container type="visibleGroup" visibleIf="[/tmp/@useTargetingDimension]==1">
              <input label="ターゲティングディメンション" type="schemaEdit" xpath="/tmp/@schemaChoice"/>
              <input expr="Iif([/tmp/@useTargetingDimension]==1,GetLinkSchema([/tmp/@schemaChoice], 'broadLog'), NodeValue('extraction/source/@schema'))"
                     type="expr" xpath="extraction/source/@schema"/>
              <input label="配信ログ" readOnly="true" type="schemaEdit" xpath="extraction/source/@schema"/>
            </container>
            <input checkedValue="0" label="抽出する配信ログを選択" nolabel="true" type="radioButton"
                   xpath="/tmp/@useTargetingDimension"/>
            <container type="visibleGroup" visibleIf="[/tmp/@useTargetingDimension]==0">
              <input label="配信ログ" type="schemaEdit" xpath="extraction/source/@schema"/>
            </container>
            <leave>
              <check expr="[extraction/source/@schema]!=''">
                <error>ターゲティングディメンション (個々の連絡先のテーブル。例えば、配信ログテーブルではなく「nms:recipient」など) を指定する必要があります。</error>
              </check>
            </leave>
          </container>

      <!-- column selection -->
          <container desc="ファイルのエクスポート時に抽出するデータを選択します。" name="column" title="抽出するデータ"
                     xpath="extraction/source">
            <enter>
          <!-- set input parameters for selectCtrl -->
              <set expr="@schema" xpath="/tmp/selectCtrl/in/@schema"/>
              <set expr="@startPath" xpath="/tmp/selectCtrl/in/@startPath"/>
              <set value="export" xpath="/tmp/selectCtrl/in/@choiceType"/>
            </enter>

            <container allowDistinct="true" allowGroupBy="true" allowUnexpandMemo="true"
                       columnListType="exportColumnList" extraColumns="@groupBy, @alias"
                       ref="xtk:queryDef:hidden/selectCtrl" showCollections="true">
          <!-- Additionnal form to insert pURL (use to be include inside column list defintion) -->
              <form label="pURL を選択" name="pURL">
                <input extraColumns="@schema,@url,@name,@label" monoSelection="true"
                       schema="nms:purl" setOnClick="true" type="linkListChoice"
                       xpath="/tmp/purl" xpathOut="/tmp/selection">
                  <input xpath="[.]"/>
                  <sysFilter>
                    <condition enabledIf="$(/delivery/scheduling/@contactDate)!=''"
                               expr="[webApp/@startDate]='' OR [webApp/@startDate] &lt;= #$noescaping(/delivery/scheduling/@contactDate)#"/>
                    <condition enabledIf="$(/delivery/scheduling/@contactDate)!=''"
                               expr="[webApp/@endDate]='' OR [webApp/@endDate] &gt;= #$noescaping(/delivery/scheduling/@contactDate)#"/>
                    <condition expr="@isModel=0"/>
                  </sysFilter>
                </input>
              </form>
            </container>

            <leave>
              <if expr="[/tmp/selectCtrl/out/@group] == false">
                <reset xpath="groupBy"/>
                <reset xpath="having"/>
              </if>
            </leave>
          </container>
          <container ref="xtk:exportSource:conditionLink" visibleIf="[extraction/source/conditionLink/@xpath]!=''"
                     xpath="extraction"/>
          <container ref="xtk:exportSource:sort" xpath="extraction"/>
          <container ref="xtk:exportSource:destInfo" xpath="extraction"/>
          <container ref="xtk:exportSource:mapping" xpath="extraction"/>
        </form>
      </input>
    </container>
<!--[cf]-->
<!--[of]:Supplier-->
    <container applicableIf="HasPackage('nms:campaign')" name="supplier" type="visibleGroup"
               visibleIf="[@operation-id]!=0 or @isModel">
      <container name="supplier">
        <container colspan="2" readOnlyIf="[/ignored/@limitEdition] and [/ignored/@contentStatus]!=10"
                   type="readOnlyGroup">
          <container label="サービスプロバイダー" type="frame">
            <container type="visibleGroup" visibleIf="@messageType != 9">
              <input alwaysActive="true" createMode="none" img="nms:supplier.png"
                     notifyPathList="@deliveryModel-id, extraction/outputScript|../output/outputScript"
                     xpath="supplierModel" xpathRefresh="/tmp/supplier">
                <enter name="onChange">
                  <if expr="[@supplierModel-id]!=0">
                    <soapCall name="ApplyExtractionDef" service="nms:supplier">
                      <param exprIn="[@supplierModel-id]" type="int"/>
                      <param exprIn="[mapping/storage/@broadLogSchema]" type="string"/>
                      <param exprIn="output/extraction" type="DOMElement"/>
                      <param type="DOMElement" xpathOut="output/extraction"/>
                    </soapCall>

                    <soapCall name="initCostCenterList" service="nms:supplier">
                      <param exprIn="[@supplierModel-id]" type="int"/>
                      <param exprIn="@messageType" type="byte"/>
                      <param exprIn="budgetParameters" type="DOMElement"/>
                      <param type="DOMElement" xpathOut="budgetParameters"/>
                    </soapCall>
                  </if>
                </enter>
              </input>

            </container>
            <container type="visibleGroup" visibleIf="@messageType=9">
              <input alwaysActive="true" createMode="none" img="nms:supplier.png"
                     xpath="supplierModel" xpathRefresh="/tmp/supplier">
                <enter name="onChange">
                  <soapCall name="initCostCenterList" service="nms:supplier">
                    <param exprIn="[@supplierModel-id]" type="int"/>
                    <param exprIn="@messageType" type="byte"/>
                    <param exprIn="budgetParameters" type="DOMElement"/>
                    <param type="DOMElement" xpathOut="budgetParameters"/>
                  </soapCall>
                </enter>
              </input>
            </container>
            <container type="visibleGroup" visibleIf="[@supplierModel-id]!=0 and NodeCount([budgetParameters/costCenter])">
              <input editable="false" hideEditButtons="false" label="コストカテゴリ" noToolbar="true"
                     type="list" xpath="budgetParameters/costCenter">
                <input editable="true" label="ラベル" noEdition="true" xpath="costCenter"
                       zoom="true"/>
                <input editable="true" label="タイプ" noZoom="true" notifyPathList="@stockLine-id|../@stockLine-id"
                       xpath="costType" xpathMandatory="@mandatory">
                  <sysFilter>
                    <condition expr="[@costCenter-id]=$(@costCenter-id)"/>
                  </sysFilter>
                </input>
                <input blankIfEmpty="true" digitCount="5" editable="true" xpath="@amount"/>
                <input createMode="none" editable="true" img="nms:expenseLine.png"
                       noZoom="true" xpath="category">
                  <sysFilter>
                    <condition expr="@type=0"/>
                  </sysFilter>
                </input>
                <input hidden="true" xpath="@id"/>
                <input hidden="true" xpath="@costCenter-id"/>
                <input hidden="true" xpath="@costCenter-cs"/>
                <input hidden="true" xpath="@costType-cs"/>
                <input hidden="true" xpath="@costType-id"/>
                <input hidden="true" xpath="@mandatory"/>
                <orderBy>
                  <node expr="costCenter"/>
                </orderBy>
              </input>
            </container>
          </container>
        </container>
      </container>
    </container>
<!--[cf]-->
<!--[of]:Main target-->
    <container name="mainTarget">
      <container type="visibleGroup" visibleIf="[/ignored/@showMappingChoice]">
        <container applicableIf="HasPackage('nms:campaign')" type="visibleGroup"
                   visibleIf="[/ignored/tmp/@workflowId] and [/ignored/@triggerMessage]!=1">"&gt;
      <input checkedValue="3" label="上流のターゲティングによって作成" nolabel="false" type="RadioButton"
             xpath="@targetMode"/>
        </container>
        <container type="visibleGroup" visibleIf="[/ignored/@triggerMessage]!=1">
          <input checkedValue="0" label="データベースで定義" nolabel="false" type="RadioButton"
                 xpath="@targetMode"/>
        </container>
        <container type="visibleGroup" visibleIf="![/ignored/tmp/@workflowId] and [/ignored/@triggerMessage]!=1">
          <input checkedValue="1" label="外部ファイルで定義" nolabel="false" type="RadioButton"
                 xpath="@targetMode"/>
        </container>
        <container enabledIf="EV(@targetMode, 'file')==false or @noReconciliation==false"
                   ref="nms:delivery:lib/deliveryMapping" type="enabledGroup" xpath="../mapping"/>
      </container>

      <container type="visibleGroup" visibleIf="EV(@targetMode, 'database')">
        <container name="database" ref="nms:delivery:lib/databaseTarget"/>
      </container>
  <!--[of]:  FileTarget-->
      <container name="file" type="visibleGroup" visibleIf="EV(@targetMode, 'file')">
        <container readOnlyIf="HasPackage('crm:lead')" type="readOnlyGroup">
          <input useDesc="true" xpath="@noReconciliation"/>
        </container>
        <value label="配信ターゲット母集団" xpath="deliveryFile/name"/>
        <input img="xtk:import.png" label="ファイルフォーマットの定義..." nolabel="true" prebuildSubForm="false"
               type="subFormLink" xpath="fileFormat">
          <form img="xtk:import32.png" label="配信受信者を含むファイルのフォーマット" maxLabelWidth="60"
                type="wizard">
            <enter>
          <!-- set some constant parameters in our specific case -->
              <set value="text" xpath="source/@type"/>
              <set value="xtkDataStore" xpath="destination/@type"/>
              <set value="deliveryFileTarget" xpath="@name"/>

              <set expr="[../../mapping/@schema]" xpath="destination/@schema"/>
              <set expr="[../@noReconciliation]" xpath="/tmp/dlvFromFile/@noReconciliation"/>
          <!-- for a hook in import MappingList control -->

          <!-- ### FB 2006-03-27 Kludge to fix bug ID151 : Bad display of "Recipient import" page of delivery wizard
             This is a copy of the enter of "Recipient import" page, because it's not executing when opening the
             wizard on this page.
             Else would be a too dangerous change in 4.0 -->
              <if expr="@useDefaultUserRcpFolder">
                <set value="0" xpath="@folder-id"/>
                <set value="" xpath="@folder-cs"/>
              </if>
              <if expr="[@group-id] == 0">
                <set value="0" xpath="/tmp/relationEntity/@groupOpt"/>
                <set translatedExpr="'リストに追加しない'" xpath="/tmp/relationEntity/@groupLabel"/>
              </if>
              <if expr="[@group-id] != 0 and [@clearGroup] == 0">
                <set value="1" xpath="/tmp/relationEntity/@groupOpt"/>
                <set translatedExpr="'リスト「'+[@group-cs]+'」に追加'" xpath="/tmp/relationEntity/@groupLabel"/>
              </if>
              <if expr="[@group-id] != 0 and @clearGroup == 1">
                <set value="2" xpath="/tmp/relationEntity/@groupOpt"/>
                <set translatedExpr="'リスト「'+[@group-cs]+'」を再作成 (最適化モード、ただしインポート前にこのリストのコンテンツは消去されます)'"
                     xpath="/tmp/relationEntity/@groupLabel"/>
              </if>
              <if expr="[@folder-id] == 0 and @useDefaultUserRcpFolder == 0">
                <set value="0" xpath="/tmp/relationEntity/@folderOpt"/>
                <set translatedExpr="'フォルダーにインポートしない'" xpath="/tmp/relationEntity/@folderLabel"/>
              </if>
              <set value="1" xpath="/tmp/relationEntity/@folderOpt"/>
              <set translatedExpr="'オペレーターのデフォルトフォルダーに追加'" xpath="/tmp/relationEntity/@folderLabel"/>
              <if expr="[@folder-id] != 0 and @useDefaultUserRcpFolder == 0">
                <set value="2" xpath="/tmp/relationEntity/@folderOpt"/>
                <set translatedExpr="'フォルダー「'+[@folder-cs]+'」に追加'" xpath="/tmp/relationEntity/@folderLabel"/>
              </if>
              <if expr="[@service-id] == 0">
                <set value="0" xpath="/tmp/relationEntity/@serviceOpt"/>
                <set translatedExpr="'サービスを購読しない'" xpath="/tmp/relationEntity/@serviceLabel"/>
              </if>
              <if expr="[@service-id] != 0">
                <set value="1" xpath="/tmp/relationEntity/@serviceOpt"/>
                <set translatedExpr="'サービス \''+[@service-cs]+'\' を購読'" xpath="/tmp/relationEntity/@serviceLabel"/>
              </if>

            </enter>

            <container desc="配信の受信者を含むファイルを指定します" name="sourceInfos" title="ソースファイル">
              <enter>
            <!-- store some parameters to check if they've changed when leaving -->
                <set expr="[../deliveryFile/name]" xpath="/tmp/deliveryFile/former/name"/>
                <set expr="[../deliveryFile/@upload]" xpath="/tmp/deliveryFile/former/@upload"/>
                <set expr="FileUploaded([../deliveryFile/name], [../deliveryFile/@md5])"
                     xpath="/ignored/file/@uploadStatus"/>
                <set value="1" xpath="/ignored/resource/@notInResTable"/>
              </enter>

              <container name="autoDetect" type="importAutoDetectContainer" xpath="source/dataSourceConfig"
                         xpathAutoDetect="../../../deliveryFile/name" xpathLastParsed="../@lastParsedDataSource"
                         xpathUploadFile="../../../deliveryFile/@upload">

                <container colcount="2">
                  <container colcount="2" colspan="2" name="targetFile" xpath="../../../deliveryFile">
                    <static colspan="2" label="配信ターゲット母集団" type="separator"/>
                    <container colspan="2" type="visibleGroup" visibleIf="@upload">
                      <input filters="テキスト、CSV または XML ファイル (*.txt;*.csv;*.tab;*.xml)|*.txt;*.csv;*.tab;*.xml|すべて (*.*)|*.*|"
                             label="ローカルファイル" type="fileEdit" xpath="name"/>
                    </container>
                    <container colspan="2" type="visibleGroup" visibleIf="![@upload]">
                      <input label="サーバーファイル" xpath="name"/>
                    </container>
                    <container ref="xtk:importSource:sourceInfos/autoDetect/file/upload"
                               xpath="."/>
                    <input colspan="2" img="xtk:refresh.png" label="フォーマットを自動検出"
                           name="autoDetectBtn1" nolabel="false" type="urlButton"/>
                  </container>

                  <container ref="xtk:importSource:sourceInfos/autoDetect/file/format"
                             xpath=".."/>
                  <container colspan="1" ref="xtk:importSource:sourceInfos/autoDetect/advanced"
                             xpath="."/>
                </container>

                <static img="xtk:preview.png" label="インポートするデータのプレビュー" type="separator"/>
                <input name="PreviewList" type="fileParsingPreviewList" xpath="."
                       xpathIndex="/tmp/columns/@current"/>
              </container>

            </container>

            <container desc="ソースフィールドと宛先フィールドをマッピングし、配信用のアドレスフィールドを指定してください。" name="mapping"
                       title="フィールドマッピング">
              <container ref="xtk:importSource:mappingInfos/mappingList"/>
              <container colcount="2">
                <container type="visibleGroup" visibleIf="EV([../../@messageType], 'paper') == false">
                  <input type="importDbColumnSelect" xpath="../@addressField" xpathCalculatedFields="../fileFormat/source/calculatedFields/calculatedField"
                         xpathSource="../fileFormat/source/dataSourceConfig/dataSourceColumn"/>
                </container>
                <container colspan="2" type="visibleGroup" visibleIf="EV([../../@messageType], 'paper')">
                  <container colcount="3" label="郵送先住所から取得するフィールド" type="frame">
                    <input allowNone="true" optional="@line1" type="importDbColumnSelect"
                           xpath="../postalAddress/@line1Field"/>
                    <input allowNone="true" optional="@line2" type="importDbColumnSelect"
                           xpath="../postalAddress/@line2Field"/>
                    <input allowNone="true" optional="@line3" type="importDbColumnSelect"
                           xpath="../postalAddress/@line3Field"/>
                    <input allowNone="true" optional="@line4" type="importDbColumnSelect"
                           xpath="../postalAddress/@line4Field"/>
                    <input allowNone="true" optional="@line5" type="importDbColumnSelect"
                           xpath="../postalAddress/@line5Field"/>
                    <input allowNone="true" optional="@line6" type="importDbColumnSelect"
                           xpath="../postalAddress/@line6Field"/>
                    <input allowNone="true" optional="@line7" type="importDbColumnSelect"
                           xpath="../postalAddress/@line7Field"/>
                    <input colspan="2" label="郵送先住所の詳細設定フィールド..." nolabel="false"
                           type="subFormLink" xpath=".">
                      <form label="郵送先住所の詳細フィールド">
                        <input allowNone="true" optional="@addrDefined" type="importDbColumnSelect"
                               xpath="../postalAddress/@addrDefinedField"/>
                        <input allowNone="true" optional="@addrQuality" type="importDbColumnSelect"
                               xpath="../postalAddress/@addrQualityField"/>
                        <input allowNone="true" optional="@addrLastCheck" type="importDbColumnSelect"
                               xpath="../postalAddress/@addrLastCheckField"/>
                        <input allowNone="true" optional="@addrErrorCount" type="importDbColumnSelect"
                               xpath="../postalAddress/@addrErrorCountField"/>
                      </form>
                    </input>
                  </container>
                </container>
                <static/>
                <container enabledIf="[../@useBlackList]" type="enabledGroup">
                  <input allowNone="true" type="importDbColumnSelect" xpath="../@blackListField"/>
                </container>
                <container enabledIf="EV([../../@messageType], 'mail')" type="enabledGroup">
                  <input allowNone="true" type="importDbColumnSelect" xpath="../@formatField"/>
                </container>
                <container type="visibleGroup" visibleIf="FieldExists([../../mapping/storage/@broadLogSchema], '@externalId')">
                  <input allowNone="true" type="importDbColumnSelect" xpath="../@externalIdField"/>
                </container>
                <container type="visibleGroup" visibleIf="FieldExists([../../mapping/storage/@broadLogSchema], '@segmentCode')">
                  <input allowNone="true" type="importDbColumnSelect" xpath="../@segmentCodeField"/>
                </container>
              </container>
            </container>

            <container ref="xtk:importSource:reconciliationInfos" visibleIf="[../@noReconciliation]==false"/>
            <container ref="xtk:importSource:group" visibleIf="[../@noReconciliation]==false and [destination/@schema] == 'nms:recipient'"/>
          </form>
        </input>
      </container>
  <!--[cf]-->
      <container type="visibleGroup" visibleIf="EV([../@deliveryMode], 'external')=false and [/ignored/@showMappingChoice]">
        <input nolabel="true" xpath="@addProofInTarget"/>
        <static type="help">配達確認の受信者をメインターゲットに自動的に追加するために使用します。</static>
      </container>
    </container>
<!--[cf]-->
<!--[of]:Proof target-->
    <container colcount="2" name="proofTarget">
      <container colspan="2" type="visibleGroup" visibleIf="EV([targets/@targetMode], 'file') == false and EV(@messageType, 'paper')==false and @messageType!=5 and [/ignored/@triggerMessage]!=1 and [/ignored/@pushMessage]!=1">
        <container readOnlyIf="[/ignored/isRecurring]" type="readOnlyGroup">
          <input label="ターゲティングモード" useDesc="true" xpath="fcpParameters/@fcpMode"/>
        </container>
      </container>

  <!-- FCP target definition -->
      <container colcount="2" colspan="2" name="visibleSpecTarget" type="visibleGroup"
                 visibleIf="EV([fcpParameters/@fcpMode], 'specificTarget')">
        <container colcount="2" colspan="2" name="fcpSpecificTarget" xpath="targets">
          <container colspan="2" type="visibleGroup" visibleIf="EV(@targetMode, 'database', 'evtDatabase')">
            <container ref="nms:delivery:lib/databaseTarget/target" xpath="proofTarget"/>
          </container>
          <container colcount="2" colspan="2" type="visibleGroup" visibleIf="EV(@targetMode, 'file')"
                     xpath="proofFile">
            <static colspan="2" label="配達確認のターゲット" type="separator"/>
            <container colspan="2" type="visibleGroup" visibleIf="@upload">
              <input filters="テキスト、CSV または XML ファイル (*.txt;*.csv;*.tab;*.xml)|*.txt;*.csv;*.tab;*.xml|すべて (*.*)|*.*|"
                     label="ローカルファイル" type="fileEdit" xpath="name"/>
            </container>
            <container colspan="2" type="visibleGroup" visibleIf="![@upload]">
              <input label="サーバーファイル" xpath="name"/>
            </container>
            <container ref="xtk:importSource:sourceInfos/autoDetect/file/upload"
                       xpath="."/>
            <static colspan="2" img="xtk:logwarn.png" label=" " nolabel="false">配達確認用に指定されたファイルは、メインの配信ターゲットファイルと同じフォーマットである必要があります。</static>
          </container>
        </container>
      </container>

  <!-- FCP target substitution -->
  <!-- ### to do : file case -->
      <container colspan="2" type="visibleGroup" visibleIf="EV([fcpParameters/@fcpMode], 'substituteAddress')">
        <input editable="true" prebuildSubForm="false" type="list" xpath="fcpParameters/substitution"
               zoom="true" zoomOnAdd="false">
          <input xpath="@address"/>
          <input editable="false" xpath="profile/rcp/@cs"/>
          <input xpath="@desc"/>
          <form label="代理の配達確認受信者の定義">
            <enter>
              <set expr="Iif([profile/rcp/@key]=='', true, false)" xpath="/ignored/fcp/@random"/>
            </enter>
        <!-- ### should apply dataPolicy on @address, but depend on messageType !!! + could be a userEnum per messageType -->
            <input xpath="@address"/>
            <input xpath="@desc"/>
            <input checkedValue="true" label="メインターゲットのプロファイルをランダムに選択" nolabel="false"
                   type="RadioButton" xpath="/ignored/fcp/@random"/>
            <input checkedValue="false" label="プロファイルを選択 (ターゲットに含める)" nolabel="false"
                   type="RadioButton" xpath="/ignored/fcp/@random"/>
            <container type="visibleGroup" visibleIf="[/ignored/fcp/@random] == false">
              <input hideEditButtons="true" label=" " monoSelection="true" type="targetPreviewList"
                     xpath="/ignored/previewList" xpathParams="/delivery/variables"
                     xpathSelection="profile" xpathTargets="/delivery/targets"/>
            </container>
            <leave>
              <if expr="[/ignored/fcp/@random] == true">
                <set value="" xpath="profile/rcp/@key"/>
                <set translatedExpr="'ランダム'" xpath="profile/rcp/@cs"/>
              </if>
            </leave>
          </form>
        </input>
        <static type="help">上記の配信から受信者を選択し、配達確認のアドレスを置換できます。</static>
      </container>

  <!-- FCP target seed member -->
      <container colspan="2" name="visibleSeedList" type="visibleGroup" visibleIf="EV([fcpParameters/@fcpMode], 'seedList')">
        <container name="fcpSeedList">

          <container type="visibleGroup" visibleIf="[/ignored/@triggerMessage]=1 and [/ignored/@showAllSeedMembers]=0 and NodeCount(FCPSeed)=1">
            <container colcount="2" ref="nms:seedMember:lib/rtEvent" xpath="FCPSeed/custom_nms_rtEvent"/>
            <input img="nms:unknownad.png" label="他のシードアドレスを追加" type="urlButton">
              <enter>
                <set value="1" xpath="/ignored/@showAllSeedMembers"/>
              </enter>
            </input>
          </container>

          <container type="visibleGroup" visibleIf="[/ignored/@triggerMessage]!=1 or [/ignored/@showAllSeedMembers]">
            <input img="nms:unknownad.png" label="シードテンプレートをインポート..." prebuildSubForm="false"
                   type="subFormLink" xpath=".">
              <form forceToSaveEntity="true" label="シードアドレスを選択">
                <container defaultColumns="@label,[custom_nms_recipient/@email],[custom_nms_broadLog/postalAddress/address/serialized]"
                           multiSelection="true" nodeModel="nmsSeedList" schema="nms:seedMember"
                           sharedUserConfig="true" type="navTreeEntityList" xpath="/ignored/seedMember">
                  <sysFilter>
                    <condition expr="@isModel=1"/>
                  </sysFilter>
                </container>
                <leave>
                  <reset xpath="/ignored/FCPSeedList"/>
                  <soapCall name="getAsModel" noRefresh="true" service="nms:seedMember">
                    <param exprIn="'proof-id'" type="string"/>
                    <param exprIn="@id" type="int"/>
                    <param exprIn="/tmp/navTreeEntityList/output/nmsSeedList" type="DOMElement"/>
                    <param exprIn="/ignored/FCPSeedList" type="DOMElement"/>
                    <param type="DOMElement" xpathOut="/ignored/FCPSeedList"/>
                  </soapCall>
                  <copyElement list="true" nodeName="FCPSeed" xpathDst="." xpathSrc="/ignored/FCPSeedList/seedMember"/>
                  <set value="*" xpath="/tmp/seedMember"/>
                </leave>
              </form>
            </input>

            <input editable="false" form="nms:seedMember" nolabel="true" prebuildSubForm="false"
                   toolbarAlign="vertical" toolbarCaption="シードアドレスのリスト" type="list"
                   xpath="FCPSeed" xpathRefresh="/tmp/seedMember" zoom="true" zoomOnAdd="true">
              <input editable="true" xpath="@label"/>
            </input>
            <container>
              <container label="シードアドレステンプレートにおける動的条件" type="frame" xpath="fcpParameters/seedList">
                <input img="nms:miniatures/mini-incremental.png" label="動的条件を編集..."
                       type="subFormLink" xpath=".">
                  <form label="動的条件">
                    <input nolabel="true" schema="nms:seedMember" toolbarAlign="horizontal"
                           toolbarCaption="フィルター条件" type="conditionList" xpath="where"
                           xpathCurrentLookupPath="/lookupPath/where" xpathHelp="/@helpCond">
                      <input colSize="15" label=" " xpath="/@bool-operator"/>
                      <input colSize="30" label="式" xpath="/@leftExpr"/>
                      <input colSize="15" label="演算子" xpath="/@operator"/>
                      <input colSize="30" label="値" xpath="/@rightExpr"/>
                    </input>
                    <input expr="[/@helpCond]" type="expr" xpath="@humanCond"/>
                  </form>
                </input>
                <container type="visibleGroup" visibleIf="NodeCount([where/condition])&gt;0">
                  <input fontBold="true" noBorder="true" nolabel="true" readOnly="true"
                         type="memo" xpath="@humanCond"/>
                </container>
              </container>
            </container>
          </container>
        </container>
      </container>

      <container colspan="2" type="visibleGroup" visibleIf="EV([fcpParameters/@fcpMode], 'mixedMode')">
        <container style="flat" type="notebook">
          <container label="配達確認受信者" ref="nms:delivery:lib/proofTarget/visibleSpecTarget/fcpSpecificTarget"/>
          <container label="配達確認用シードアドレス" ref="nms:delivery:lib/proofTarget/visibleSeedList/fcpSeedList"/>
        </container>
      </container>

      <container type="visibleGroup" visibleIf="EV(@messageType, 'mail') and [content/html/source]!='' and [content/text/source]!='' and [/ignored/@showMappingChoice]">
        <static img="nms:email.png" label="配達確認ターゲット内のすべての受信者に送信するメッセージのフォーマット" type="separator"/>
        <input checkedValue="normal" label="単一のメッセージ (通常の行動)" type="RadioButton"
               xpath="fcpParameters/@fcpMailFormat"/>
        <input checkedValue="textMultipart" label="2 つのメッセージを送信 (テキストとマルチパート /オルタナティブ)"
               type="RadioButton" xpath="fcpParameters/@fcpMailFormat"/>
        <input checkedValue="allFormats" label="3 つのメッセージを送信 (テキスト、HTML、マルチパート /オルタナティブ)"
               type="RadioButton" xpath="fcpParameters/@fcpMailFormat"/>
      </container>
    </container>
<!--[cf]-->
<!--[of]:Edit recipient query-->
<!-- SubFormLink to edit the recipient query with links 1..n -->
    <container name="editRecipientQuery">
      <input img="nms:recipient.png" label="受信者プロファイルの読み込みクエリを編集..." prebuildSubForm="false"
             type="subFormLink" xpath="/delivery">
        <form img="nms:pictoprofile.png" label="受信者プロファイル読み込みクエリを編集" type="wizard">
          <enter>
            <set expr="GetLinkSchema([mapping/@schema], [mapping/@recipientLink])"
                 xpath="/tmp/selectCtrl/in/@schema"/>
            <set value="" xpath="/tmp/selectCtrl/in/@startPath"/>
            <set expr="[/tmp/selectCtrl/in/@schema]" xpath="/tmp/@rcpLinkSchemaCondLink"/>
          </enter>
          <container desc="パーソナライゼーション用に読み込む受信者の情報を入力してください。" title="読み込む受信者のフィールド">
            <container extraColumns="@alias" ref="xtk:queryDef:hidden/selectCtrl"
                       showCollections="true" xpath="content/customRecipient"/>
          </container>
          <container desc="コレクションリンクごとにフィルター条件と並べ替え順序を編集してください。読み込むリンク済みレコードを制限するために使用します。"
                     name="clt" title="コレクションのパーソナライゼーション情報" visibleIf="NodeExists([content/customRecipient/conditionLink])"
                     xpath="content/customRecipient">
            <input alwaysActive="true" editable="false" img="xtk:xtklinkn.png" name="cc"
                   noEditCollection="true" nolabel="true" prebuildSubForm="true"
                   type="customizeCondition" xpath="conditionLink" xpathSchema="/tmp/@rcpLinkSchemaCondLink"
                   xpathSelect="select/node" zoom="true">
              <input xpath="@label"/>
              <input xpath="@lineCount"/>
              <input xpath="where/@displayFilter"/>
              <input xpath="orderBy/@displayOrder"/>
              <input hidden="true" xpath="@schema"/>

              <form img="nms:pictoprofile.png" label="パーソナライゼーション情報を収集するためのフィルター"
                    type="wizard">
                <container desc="保持するコレクション要素数を指定するために使用される情報を入力します。" name="parameters"
                           title="一般パラメーター">
                  <static type="help">入力するフィルター条件を満たすコレクション要素が 1 つのみであることがわかっている場合は、\n
次のオプションを選択します (これによりサブクエリを回避でき、パフォーマンスが向上します)。</static>
                  <input xpath="@singleRow"/>
                  <container enabledIf="!@singleRow" type="enabledGroup">
                    <static type="help">返すコレクション要素の数。</static>
                    <input xpath="@lineCount"/>
                  </container>
                  <leave>
                    <if expr="@singleRow">
                      <set value="1" xpath="@lineCount"/>
                    </if>
                  </leave>
                </container>
                <container desc="保持するコレクション要素を指定するために使用されるフィルター条件を入力します。" name="where"
                           title="フィルター">
                  <container buildQueryXPath="." ref="xtk:queryDef:where"/>
                </container>
                <container desc="候補のライン数があらかじめ指定した数よりも多い場合に、並べ替え順序を指定して維持するラインを指定します。"
                           name="orderBy" title="並べ替え" visibleIf="@singleRow == false">
                  <input name="sortList" nolabel="true" toolbarCaption="列を並べ替え" type="orderByList"
                         xpath="orderBy/node" xpathCurrentLookupPath="/lookupPath/orderBy"
                         xpathHelp="/@help" zoom="false">
                    <input colSize="20" xpath="@label"/>
                    <input choiceType="true" colSize="35" editable="true" type="pathedit"
                           xpath="@expr" xpathSchema="../../@schema"/>
                    <input colSize="15" editable="true" xpath="@sortDesc"/>
                  </input>
                  <input type="help" xpath="/@help"/>
                </container>
              </form>
            </input>
          </container>
        </form>
      </input>
    </container>
<!--[cf]-->
<!--[of]:Edit target Query-->
    <container name="editTargetQuery">
      <input img="nms:segment.png" label="ターゲットレコードの読み込みクエリを編集..." prebuildSubForm="false"
             type="subFormLink" xpath="/delivery">
        <form img="nms:pictoprofile.png" label="ターゲットレコード読み込みクエリの編集" type="wizard">
          <enter>
            <set expr="[mapping/@schema]" xpath="/tmp/selectCtrl/in/@schema"/>
            <set value="" xpath="/tmp/selectCtrl/in/@startPath"/>
            <set expr="[/tmp/selectCtrl/in/@schema]" xpath="/tmp/@targetSchemaCondLink"/>
          </enter>
          <container desc="ターゲット内のレコードからパーソナライゼーション用のデータを指定してください。" title="読み込むターゲットのフィールド">
            <container extraColumns="@alias" ref="xtk:queryDef:hidden/selectCtrl"
                       showCollections="true" xpath="content/customTarget"/>
          </container>
          <container desc="コレクションリンクごとにフィルター条件と並べ替え順序を編集してください。読み込むリンク済みレコードを制限するために使用します。"
                     name="clt" title="コレクションのパーソナライゼーション情報" visibleIf="NodeExists([content/customTarget/conditionLink])"
                     xpath="content/customTarget">
            <input alwaysActive="true" editable="false" img="xtk:xtklinkn.png" name="cc"
                   noEditCollection="true" nolabel="true" prebuildSubForm="true"
                   type="customizeCondition" xpath="conditionLink" xpathSchema="/tmp/@targetSchemaCondLink"
                   xpathSelect="select/node" zoom="true">
              <input xpath="@label"/>
              <input xpath="@lineCount"/>
              <input xpath="where/@displayFilter"/>
              <input xpath="orderBy/@displayOrder"/>
              <input hidden="true" xpath="@schema"/>

              <form img="nms:pictoprofile.png" label="パーソナライゼーション情報を収集するためのフィルター"
                    type="wizard">
                <container desc="保持するコレクション要素数を指定するために使用される情報を入力します。" name="parameters"
                           title="一般パラメーター">
                  <static type="help">入力するフィルター条件を満たすコレクション要素が 1 つのみであることがわかっている場合は、\n
次のオプションを選択します (これによりサブクエリを回避でき、パフォーマンスが向上します)。</static>
                  <input xpath="@singleRow"/>
                  <container enabledIf="!@singleRow" type="enabledGroup">
                    <static type="help">返すコレクション要素の数。</static>
                    <input xpath="@lineCount"/>
                  </container>
                  <leave>
                    <if expr="@singleRow">
                      <set value="1" xpath="@lineCount"/>
                    </if>
                  </leave>
                </container>
                <container desc="保持するコレクション要素を指定するために使用されるフィルター条件を入力します。" name="where"
                           title="フィルター">
                  <container buildQueryXPath="." ref="xtk:queryDef:where"/>
                </container>
                <container desc="候補のライン数があらかじめ指定した数よりも多い場合に、並べ替え順序を指定して維持するラインを指定します。"
                           name="orderBy" title="並べ替え" visibleIf="@singleRow == false">
                  <input name="sortList" nolabel="true" toolbarCaption="列を並べ替え" type="orderByList"
                         xpath="orderBy/node" xpathCurrentLookupPath="/lookupPath/orderBy"
                         xpathHelp="/@help" zoom="false">
                    <input colSize="20" xpath="@label"/>
                    <input choiceType="true" colSize="35" editable="true" type="pathedit"
                           xpath="@expr" xpathSchema="../../@schema"/>
                    <input colSize="15" editable="true" xpath="@sortDesc"/>
                  </input>
                  <input type="help" xpath="/@help"/>
                </container>
              </form>
            </input>
          </container>
        </form>
      </input>
    </container>
<!--[cf]-->
<!--[of]:Wizsend-->
    <container name="wizSend">
  <!--[of]:  Main target-->
      <container name="pgTarget">
        <input alwaysActive="true" expr="EV([targets/@targetMode],'file') or [targets/deliveryTarget/@nonEmpty]"
               type="expr" xpath="/ignored/@targetNoEmpty"/>
        <input expr="([/ignored/@analyzed] and [/ignored/@start] and EV([properties/@deliveryState], 'targetReady', 'ready')) or ([/ignored/@start] and EV([properties/@deliveryState], 'startPending', 'started', 'finished'))"
               type="expr" xpath="/ignored/@deliveryTargeted"/>

        <container backcolor="tooltip" padding="5" type="visibleGroup" visibleIf="![/ignored/@targetNoEmpty]">
          <static img="nms:caution.png">メインの配信のターゲットが指定されていません。\n以下のリストから、ターゲティングする母集団を定義してください。</static>
        </container>

    <!-- text display once process is finished -->
        <container backcolor="tooltip" padding="5" type="visibleGroup" visibleIf="[/ignored/@targetNoEmpty] and [/ignored/@deliveryTargeted] and [/ignored/@enableStart]=false and HasNamedRight('deliveryValidate')">
          <container backcolor="tooltip" type="visibleGroup" visibleIf="![scheduling/@delayed]">
            <static img="nms:checked.png">配信が開始されました。\nこのウィンドウは閉じることができます。</static>
          </container>
          <container backcolor="tooltip" colcount="2" type="visibleGroup" visibleIf="[scheduling/@delayed]">
            <static img="nms:checked.png" rowspan="2" type="image" vAlign="center"/>
            <static>配信を開始しました。</static>
            <value fontBold="true" label="配信スケジュール :" xpath="scheduling/@contactDate"/>
          </container>

        </container>

    <!-- text displayed after analyze or confirmation -->
        <container type="visibleGroup" visibleIf="[/ignored/@targetNoEmpty] and [/ignored/@deliveryTargeted] and [/ignored/@enableStart] and [/ignored/@targetStatus]!=1 and [/ignored/@targetStatus]!=3">
          <container backcolor="tooltip" colcount="2" padding="5" type="visibleGroup"
                     visibleIf="[/ignored/@actionMode]=2 or [/ignored/@useTargetValidation]">
            <static img="nms:caution.png" rowspan="3" type="image" vAlign="center"/>
            <static>ターゲットの計算が完了しました。</static>
            <value colspan="2" fontBold="true" xpath="properties/@toDeliver"/>
            <container backcolor="tooltip" colspan="2" type="visibleGroup" visibleIf="[/ignored/@useTargetValidation]=false">
              <static>ターゲティングを変更して配信分析を再度開始するか、ウィンドウを閉じることができます。</static>
            </container>
            <container backcolor="tooltip" colspan="2" type="visibleGroup" visibleIf="[/ignored/@useTargetValidation]">
              <container backcolor="tooltip" type="visibleGroup" visibleIf="[scheduling/@delayed]">
                <value fontBold="true" label="配信スケジュール :" xpath="scheduling/@contactDate"/>
              </container>
              <container backcolor="tooltip" type="visibleGroup" visibleIf="[/ignored/@actionMode]=2 and [/ignored/@useTargetValidation]=false">
                <static>目的のアクションを選択して、承認するターゲットを送信してください。</static>
              </container>
              <container backcolor="tooltip" type="visibleGroup" visibleIf="[/ignored/@useTargetValidation]">
                <container backcolor="tooltip" colspan="2" type="visibleGroup" visibleIf="![/ignored/@isTargetModified]">
                  <static>承認するターゲットを送信するか、ターゲットを変更して配信分析を再度開始してください。</static>
                </container>
                <container backcolor="tooltip" colspan="2" type="visibleGroup" visibleIf="[/ignored/@isTargetModified]">
                  <static type="warning">ターゲットが変更されています。別の配信分析を実行してください。</static>
                </container>
              </container>
            </container>
          </container>
          <container backcolor="tooltip" colcount="2" padding="5" type="visibleGroup"
                     visibleIf="[/ignored/@actionMode]!=2 and [/ignored/@useTargetValidation]=false">
            <static img="nms:caution.png" rowspan="10" type="image" vAlign="center"/>
            <static>配信の準備が完了しました。</static>
            <value colspan="2" fontBold="true" xpath="properties/@toDeliver"/>
            <container backcolor="tooltip" colspan="2" type="visibleGroup" visibleIf="[scheduling/@delayed]">
              <value colspan="2" fontBold="true" label="配信スケジュール :" xpath="scheduling/@contactDate"/>
            </container>

            <container backcolor="tooltip" colspan="2" type="visibleGroup" visibleIf="![/ignored/@isTargetModified]">
              <static colspan="2">メッセージの送信を確定するか、ターゲットを変更して配信分析を再度開始してください。</static>
            </container>
            <container backcolor="tooltip" colspan="2" type="visibleGroup" visibleIf="[/ignored/@isTargetModified]">
              <static type="warning">ターゲットが変更されています。別の配信分析を実行してください。</static>
            </container>
          </container>
        </container>

        <container backcolor="tooltip" colcount="2" padding="5" type="visibleGroup"
                   visibleIf="[/ignored/@targetNoEmpty] and ([/ignored/@targetStatus]=1 or [/ignored/@targetStatus]=3)">
          <static img="nms:checked.png" rowspan="3" type="image" vAlign="center"/>
          <container backcolor="tooltip" type="visibleGroup" visibleIf="![/ignored/@useContentValidation] or [/ignored/@contentStatus]=2">
            <static>ターゲットが承認のために送信されました。</static>
          </container>
          <container backcolor="tooltip" type="visibleGroup" visibleIf="[/ignored/@useContentValidation] and [/ignored/@contentStatus]!=2">
            <static>ターゲットが承認用に送信されました。\nコンテンツが承認されるまで配信が送信されない可能性があります。</static>
          </container>
          <value fontBold="true" xpath="properties/@toDeliver"/>
          <container backcolor="tooltip" colspan="2" type="visibleGroup" visibleIf="[scheduling/@delayed]">
            <value fontBold="true" label="配信スケジュール :" xpath="scheduling/@contactDate"/>
          </container>
          <static colspan="2">ターゲティングを変更し、分析を再度開始して承認のために再度送信することができます。</static>
        </container>

    <!-- collapse link to show target edition -->
        <container type="visibleGroup" visibleIf="[/ignored/@deliveryTargeted] and [/ignored/@enableStart]">
          <input imgExpr="[/ignored/@img]" label="メインの配信ターゲットを変更" type="urlButton">
            <enter name="onClick">
              <set expr="![/ignored/@showTarget]" xpath="/ignored/@showTarget"/>
              <set expr="Iif([/ignored/@showTarget], 'nl:arrow_orange.png', 'nl:arrow_ntf_orange.png')"
                   xpath="/ignored/@img"/>
            </enter>
          </input>
        </container>

    <!-- text displayed before analyze or confirmation -->
        <container type="visibleGroup" visibleIf="[/ignored/@targetNoEmpty]">
          <container backcolor="tooltip" colcount="2" padding="5" type="visibleGroup"
                     visibleIf="EV([properties/@deliveryState], 'preparationError')=false and ([/ignored/@actionMode]=2 and [/ignored/@start]=false and ([/ignored/@hasDeliveryContent]=false or ([/ignored/@useContentValidation] and [/ignored/@contentStatus]!=2))) and [/ignored/@useTargetValidation]=false">
            <static img="nms:caution.png" rowspan="3" type="image" vAlign="center"/>
            <container backcolor="tooltip" type="visibleGroup" visibleIf="EV([properties/@deliveryState], 'edition') and [/ignored/@useContentValidation]=false">
              <static>配信コンテンツが入力されていません。</static>
              <static colspan="2">ターゲット分析を開始して配信の可能性を評価できます。</static>
            </container>

            <container backcolor="tooltip" type="visibleGroup" visibleIf="EV([properties/@deliveryState], 'edition') and [/ignored/@useContentValidation] and [/ignored/@contentStatus]=0 and [/ignored/@useTargetValidation]=false">
              <static>配信コンテンツは承認待ちです。</static>
              <container backcolor="tooltip" colspan="2" type="visibleGroup" visibleIf="EV([properties/@deliveryState], 'edition')">
                <static>ターゲット分析を開始して配信の可能性を評価してください。</static>
              </container>
            </container>

            <container backcolor="tooltip" type="visibleGroup" visibleIf="EV([properties/@deliveryState], 'edition')=false and ([/ignored/@useTargetValidation]=false or [/ignored/@useContentValidation])">
              <container backcolor="tooltip" type="visibleGroup" visibleIf="[/ignored/@useContentValidation] and [/ignored/@contentStatus]!=2 and [/ignored/@useTargetValidation]=false">
                <static>ターゲットが計算されました。配信コンテンツは承認待ちです。</static>
              </container>
              <container backcolor="tooltip" type="visibleGroup" visibleIf="![/ignored/@useContentValidation] or [/ignored/@contentStatus]=2">
                <static>ターゲットが計算されました。</static>
              </container>
              <value colspan="2" fontBold="true" xpath="properties/@toDeliver"/>
              <static colspan="2">ターゲット分析を開始して配信の可能性をもう一度評価できます。</static>
            </container>
          </container>

          <container backcolor="tooltip" padding="5" type="visibleGroup" visibleIf="EV([properties/@deliveryState], 'preparationError')">
            <static img="nms:exclam.png">配信の準備中にエラーが発生しました。\n分析をやり直してください。</static>
          </container>

          <container type="visibleGroup" visibleIf="EV([properties/@deliveryState], 'preparationError')=false and ((([/ignored/@hasDeliveryContent] and ([/ignored/@contentStatus]=2 or [/ignored/@useContentValidation]=false)) or [/ignored/@useTargetValidation]) and [/ignored/@start]=false)">
            <container backcolor="tooltip" colcount="2" padding="5" type="visibleGroup"
                       visibleIf=" EV([properties/@deliveryState], 'edition')">
              <static img="nms:caution.png" rowspan="3" type="image" vAlign="center"/>
              <container backcolor="tooltip" type="visibleGroup" visibleIf="[/ignored/@useTargetValidation]=false and [/ignored/@actionMode]=-1">
                <static>配信はすぐに送信できます (コンテンツとターゲティングが入力済み)。\n必要なアクションを選択してください。</static>
              </container>
              <container backcolor="tooltip" type="visibleGroup" visibleIf="[/ignored/@useTargetValidation] and [/ignored/@actionMode]=-1">
                <static>この配信はターゲットの承認が必要です。\n
  分析を開始して配信ターゲットを計算してください。</static>
              </container>
              <container backcolor="tooltip" colspan="2" type="visibleGroup" visibleIf="[/ignored/@useTargetValidation]=false and [/ignored/@actionMode]!=2 and [/ignored/@actionMode]!=-1">
                <static>配信の送信を準備するには、分析を開始してください。\nこの処理が完了すると、配信の送信準備が整います。</static>
              </container>
              <container backcolor="tooltip" colspan="2" type="visibleGroup" visibleIf="[/ignored/@useTargetValidation]=false and [/ignored/@actionMode]=2 and [/ignored/@actionMode]!=-1">
                <static>配信を送信する準備ができました。\n分析を開始して、配信ターゲットを計算してください。</static>
              </container>
              <container backcolor="tooltip" colspan="2" type="visibleGroup" visibleIf="[/ignored/@useTargetValidation] and [/ignored/@actionMode]!=-1">
                <static>分析を開始して、配信ターゲットを計算してください。\nこの処理が完了すると、ターゲットの承認準備が整います。</static>
              </container>
            </container>
            <container type="visibleGroup" visibleIf="EV([properties/@deliveryState], 'edition')=false and EV([properties/@deliveryState], 'preparationError')=false">
              <container backcolor="tooltip" colcount="2" padding="5" type="visibleGroup"
                         visibleIf="[/ignored/@useTargetValidation] and [/ignored/@targetStatus]!=1 and [/ignored/@targetStatus]!=3">
                <container backcolor="tooltip" colcount="2" colspan="2" type="visibleGroup"
                           visibleIf="[/ignored/@targetStatus]=0">
                  <static img="nms:caution.png" rowspan="3" type="image" vAlign="center"/>
                  <static>ターゲットが計算されました。</static>
                  <value fontBold="true" xpath="properties/@toDeliver"/>
                  <container backcolor="tooltip" colspan="2" type="visibleGroup"
                             visibleIf="[scheduling/@delayed]">
                    <value fontBold="true" label="配信スケジュール :" xpath="scheduling/@contactDate"/>
                  </container>
                  <static colspan="2">承認するターゲットを送信するか、ターゲットを変更して配信分析を再度開始してください。</static>
                </container>
                <container backcolor="tooltip" colcount="2" colspan="2" type="visibleGroup"
                           visibleIf="[/ignored/@targetStatus]=2">
                  <static img="nms:checked.png" rowspan="3" type="image" vAlign="center"/>
                  <static>ターゲットが承認されました。</static>
                  <value fontBold="true" xpath="properties/@toDeliver"/>
                  <static colspan="2">ターゲティングを変更し、分析を再度開始して承認のために再度送信することができます。</static>
                </container>
              </container>

              <container backcolor="tooltip" colcount="2" padding="5" type="visibleGroup"
                         visibleIf="[/ignored/@useTargetValidation]=false">
                <static img="nms:caution.png" rowspan="3" type="image" vAlign="center"/>
                <static>ターゲットが計算されました。</static>
                <value fontBold="true" xpath="properties/@toDeliver"/>
                <static colspan="2">送信を確認するか、またはターゲットを変更して分析を再度開始してください。</static>
              </container>

          <!-- collapse link to show delivery action -->
              <container type="visibleGroup" visibleIf="[/ignored/@useTargetValidation]=false">
                <input imgExpr="[/ignored/@imgAction]" label="配信アクションを変更" type="urlButton">
                  <enter name="onClick">
                    <set expr="![/ignored/@showAction]" xpath="/ignored/@showAction"/>
                    <set expr="Iif([/ignored/@showAction], 'nl:arrow_orange.png', 'nl:arrow_ntf_orange.png')"
                         xpath="/ignored/@imgAction"/>
                  </enter>
                </input>
              </container>
            </container>

        <!-- display delivery actions choices -->
            <container type="visibleGroup" visibleIf="(EV([properties/@deliveryState], 'edition') and [/ignored/@useTargetValidation]=false) or [/ignored/@showAction]">
              <container label="配信時のアクション" type="frame">
                <container colcount="2" colspan="2" margin-left="50">
                  <container colcount="3" colspan="2">
                    <static img="nms:campaign.png" type="image"/>
                    <input checkedValue="0" label="可能な限り早く配信" nolabel="false" type="radioButton"
                           xpath="/ignored/@actionMode"/>
                    <container type="visiblegroup" visibleIf="[scheduling/@contactDate]!='' and [/ignored/@actionMode]=0">
                      <static label="既に入力済みのコンタクト日は無視されます。" type="warning"/>
                    </container>
                    <container type="visiblegroup" visibleIf="[scheduling/@contactDate]='' or [/ignored/@actionMode]!=0">
                      <static/>
                    </container>
                    <static colspan="3">配信をすぐに送信するためのターゲット計算とコンテンツの準備。</static>
                  </container>
                  <container colcount="3" colspan="2">
                    <static img="nms:businessRanking.png" type="image"/>
                    <input checkedValue="1" label="配信を延期" nolabel="true" type="radioButton"
                           xpath="/ignored/@actionMode"/>
                    <container type="visibleGroup" visibleIf="[/ignored/@actionMode]=1">
                      <input xpath="scheduling/@contactDate"/>
                    </container>
                    <container type="visibleGroup" visibleIf="[/ignored/@actionMode]!=1">
                      <static/>
                    </container>
                    <static colspan="3" label="配信の送信を延期するためのターゲットの抽出およびコンテンツの準備 (コンタクト日以降)。"/>
                  </container>

                  <container colcount="2" colspan="2" type="visibleGroup" visibleIf="[/ignored/@socialMessage]!=1 AND [/ignored/@pushMessage]!=1">
                    <static img="nms:recipientActivity.png" type="image"/>
                    <input checkedValue="2" label="ターゲットとする母集団を推算" nolabel="true"
                           type="radioButton" xpath="/ignored/@actionMode"/>
                    <static colspan="2" label="潜在的な配信ターゲットを推定算出。"/>
                  </container>
                </container>
              </container>
            </container>
          </container>
        </container>

    <!-- display target edition -->
        <container type="visibleGroup" visibleIf="[/ignored/@showTarget] or ([/ignored/@targetNoEmptyInit]=false and [/ignored/@deliveryTargeted]=false)">
          <container type="visibleGroup" visibleIf="EV([targets/@targetMode],'file')">
            <static label="メインターゲット" type="separator"/>
          </container>
          <container ref="nms:delivery:lib/mainTarget" xpath="targets"/>
        </container>

    <!-- display analyze and confirmation buttons -->
        <container type="visibleGroup" visibleIf="[/ignored/@targetNoEmpty] and [/ignored/@actionMode]!=-1">
          <container ref="nms:delivery:lib/prepareDelivery"/>
        </container>

        <static type="separator"/>

        <leave>
          <check expr="[/ignored/@targetNoEmpty]">
            <error>ターゲティングする母集団を入力してください。</error>
          </check>
        </leave>
      </container>
  <!--[cf]-->
  <!--[of]:  Proof target-->
      <container name="pgProof">
        <input alwaysActive="true" expr="(EV([targets/@targetMode],'file') and [targets/proofFile/name]!='') or ([targets/proofTarget/@nonEmpty] and EV([targets/@targetMode],'file')=false) or EV([fcpParameters/@fcpMode], 'specificTarget')=false"
               type="expr" xpath="/ignored/@targetNoEmpty"/>
        <input expr="[/ignored/@targetNoEmpty] and [/ignored/@analyzed] and [/ignored/@start] and EV([properties/@deliveryState], 'ready', 'startPending', 'started', 'finished')"
               type="expr" xpath="/ignored/@deliveryAnalyzed"/>

        <container backcolor="tooltip" colcount="2" padding="5" type="visibleGroup"
                   visibleIf="![/ignored/@targetNoEmpty]">
          <static img="nms:caution.png" vAlign="center">配達確認のターゲットが指定されていません。\n以下のリストから、ターゲティングする母集団を定義してください。</static>
        </container>

        <container backcolor="tooltip" padding="5" type="visibleGroup" visibleIf="[/ignored/@deliveryAnalyzed] and [/ignored/@enableStart]=false and HasNamedRight('deliveryValidate')">
          <static img="nms:checked.png">配信が開始されました。\nこのウィンドウは閉じることができます。</static>
        </container>

        <container backcolor="tooltip" colcount="2" padding="5" type="visibleGroup"
                   visibleIf="[/ignored/@deliveryAnalyzed] and [/ignored/@enableStart]">
          <static img="nms:caution.png" rowspan="3" type="image" vAlign="center"/>
          <static>配信の準備が完了しました。</static>
          <value colspan="2" fontBold="true" xpath="properties/@toDeliver"/>
          <container backcolor="tooltip" colspan="2" type="visibleGroup" visibleIf="![/ignored/@isTargetModified]">
            <static>メッセージの送信を確定するか、ターゲットを変更して配信分析を再度開始してください。</static>
          </container>
          <container backcolor="tooltip" colspan="2" type="visibleGroup" visibleIf="[/ignored/@isTargetModified]">
            <static type="warning">ターゲットが変更されています。別の配信分析を実行してください。</static>
          </container>
        </container>

        <container type="visibleGroup" visibleIf="[/ignored/@deliveryAnalyzed] and [/ignored/@enableStart]">
          <input imgExpr="[/ignored/@img]" label="配達確認の対象を変更" type="urlButton">
            <enter name="onClick">
              <set expr="![/ignored/@showTarget]" xpath="/ignored/@showTarget"/>
              <set expr="Iif([/ignored/@showTarget], 'nl:arrow_orange.png', 'nl:arrow_ntf_orange.png')"
                   xpath="/ignored/@img"/>
            </enter>
          </input>
        </container>

        <container backcolor="tooltip" padding="5" type="visibleGroup" visibleIf="![/ignored/@hasDeliveryContent] and [/ignored/@targetNoEmpty]">
          <static img="nms:exclam.png">メインの配信のコンテンツが指定されていません。\n配達確認を送信できません。</static>
        </container>

        <container backcolor="tooltip" padding="5" type="visibleGroup" visibleIf="[/ignored/@hasDeliveryContent] and [/ignored/@targetNoEmpty] and [/ignored/@start]=false">
          <static img="nms:caution.png">配信の送信を準備するには配達確認分析を開始してください。\nこの処理が完了すると、配信の送信準備が整います。</static>
        </container>

        <container type="visibleGroup" visibleIf="[/ignored/@deliveryAnalyzed]=false or [/ignored/@showTarget]">
          <container ref="nms:delivery:lib/proofTarget"/>
        </container>

        <container type="visibleGroup" visibleIf="[/ignored/@hasDeliveryContent] and [/ignored/@targetNoEmpty]">
          <container ref="nms:delivery:lib/prepareDelivery"/>
        </container>

        <static type="separator"/>

        <leave>
          <check expr="[/ignored/@targetNoEmpty]">
            <error>ターゲティングする母集団を入力してください。</error>
          </check>
        </leave>
      </container>
  <!--[cf]-->
    </container>
<!--[cf]-->
<!--[of]:Database target-->
    <container name="databaseTarget" xpath="deliveryTarget">
      <container name="target">
        <input type="browserSummary" xpath="." xpathSchema="../../mapping/@schema">

          <form label="ターゲット要素を選択" name="brSummaryWizard" nothingToSave="true" type="wizard">
            <enter>
              <set value="1" xpath="/ignored/@currentFilterStack"/>
              <set value="0" xpath="/ignored/@addFilter"/>
              <set value="" xpath="/ignored/@filterName"/>
            </enter>

            <container colcount="2" desc="ターゲット要素のタイプを選択" img="nms:pictoprofile.png"
                       name="typePage" title="ターゲットのタイプ">
              <static colspan="2" label="制限フィルターのリスト" type="separator"/>
              <input colspan="2" dblClickAction="wizNext" img="xtk:filter.png" noEditCollection="true"
                     noToolbar="true" nolabel="true" type="filterList" xpath="/tmp/filterList"
                     xpathFilter="/ignored/@filterName" xpathSchema="../../../mapping/@schema"
                     xpathWhere="where"/>
              <container ref="nms:delivery:lib/segment"/>
            </container>
            <container desc="ターゲット要素の定義を入力してください" enabledButtonLabelIf="[/ignored/@currentFilterStack] == true"
                       img="nms:pictoprofile.png" name="targetPage" nextButtonLabel="ターゲットを絞り込む＞"
                       nextPage="typePage" title="ターゲット要素">
              <container name="targetPageFocus" style="flat" type="notebook">
                <container label=" 条件">
                  <input xpath="@label"/>
                  <static label="フィルター設定" type="separator"/>
                  <input exprsContext="[../../../mapping/@id]" type="filterView"
                         xpath="." xpathFilter="/ignored/@filterName" xpathLabel="@label"
                         xpathQueryLabel="@computedLabel" xpathSchema="../../../mapping/@schema"
                         xpathsContext="tmp/@targetMapping-id"/>
                  <container ref="nms:delivery:lib/segment"/>
                </container>
                <container label="プレビュー">
                  <input hideEditButtons="true" name="targetPreviewQuery" noToolbar="true"
                         nolabel="true" type="targetPreviewList" xpath="/ignored/previewList"
                         xpathParams="/delivery/variables" xpathTargetPart="." xpathTargets="/delivery/targets"/>
                </container>
              </container>
              <leave>
                <set value="1" xpath="/ignored/@addFilter"/>
                <set value="" xpath="/ignored/@filterName"/>
              </leave>
            </container>
          </form>
        </input>
      </container>
    </container>
<!--[cf]-->
<!--[of]:General-->
    <container colcount="2" name="general">
      <container colcount="2" colspan="2" type="visibleGroup" visibleIf="[/ignored/@dlvNotReady]=''">
        <input discardReadOnly="true" xpath="@label"/>
        <input xpath="@internalName"/>
      </container>
      <container colspan="2" type="visibleGroup" visibleIf="[/ignored/@dlvNotReady]!=''">
        <input xpath="@label"/>
      </container>
      <container applicableIf="HasPackage('nms:messageCenter')" colspan="2" type="visibleGroup"
                 visibleIf="[/ignored/@triggerMessage]=1">
        <input xpath="triggerMessage/@eventType"/>
      </container>
      <container colspan="2" type="visibleGroup" visibleIf="[/ignored/@triggerMessage]!=1">
        <input xpath="@deliveryCode"/>
      </container>
      <input colspan="2" xpath="@nature"/>
  <!-- Display landingPage linkedit. Filter on landingPage of the operation or landingPage without operation -->
      <container applicableIf="HasPackage('crm:lead')" colspan="2" type="visibleGroup"
                 visibleIf="EV(@messageType, 'mail') and ([/ignored/@useLandingPage] or [/ignored/@operationId]=0)">
        <input img="crm:landingPage.png" notifyPathList="[renderApp/@internalName],[renderApp/@id]"
               writeAccess="true" xpath="landingPage">
          <sysFilter>
        <!-- Two tests here to prevent use of BoolOperator which seems to be weird sometimes -->
            <condition enabledIf="$(/ignored/@operationId)!=0" expr="[@operation-id] = 0 OR [@operation-id] = $long(/ignored/@operationId)"/>
            <condition enabledIf="$(/ignored/@operationId)=0" expr="[@operation-id] = 0"/>
          </sysFilter>
        </input>
      </container>
      <input colspan="2" discardReadOnly="true" xpath="desc"/>
      <container colspan="2" type="visibleGroup" visibleIf="@isModel and ([/ignored/@dlvNotReady]='' or [/tmp/@showFolder]==1)">
        <input img="nms:campaign.png" xpath="folderProcess">
          <sysFilter>
            <condition expr="@model = 'nmsDelivery'"/>
          </sysFilter>
        </input>
        <input img="nms:deliveryModel.png" writeAccess="true" xpath="folder">
          <sysFilter>
            <condition expr="@model = 'nmsDeliveryModel'"/>
          </sysFilter>
        </input>
      </container>
      <container colspan="2" type="visibleGroup" visibleIf="@isModel=false and ([/ignored/@dlvNotReady]='' or [/tmp/@showFolder]==1) and ([/tmp/processId]==0 or [/tmp/processId]==''or [/tmp/@showFolder]==1)">
        <input img="nms:campaign.png" writeAccess="true" xpath="folder">
          <sysFilter>
            <condition expr="@model = 'nmsDelivery'"/>
          </sysFilter>
        </input>
      </container>
      <container colspan="2" type="visibleGroup" visibleIf="[/ignored/@dlvNotReady]=''">
        <input enumImage="@messageType" img="nms:extAccount.png" notifyPathList="@messageType,@deliveryMode,@id,@messageType,@deliveryMode,@account,@mobileConnector,@active,@label,lineService/@id"
               xpath="deliveryProvider">
          <enter name="onChange">
            <if expr="HasPackage('nms:mobileApp') AND @isModel">
          <!-- When creating a delivery model for push, we have to generate some default parameters needed for the connector -->
          <!-- Ensure that the values below are the same than the ones in the delivery templates located in the mobileApp package -->
          <!-- Reset any existing params. Can happen when switching models -->
              <reset xpath="/delivery/content/iosCheckParams/source[*]"/>
              <reset xpath="/delivery/content/iosNotifType/source[*]"/>
              <reset xpath="/delivery/content/androidCheckParams/source[*]"/>
              <reset xpath="/delivery/content/androidService/source[*]"/>
              <reset xpath="/delivery/content/androidCollapseKey/source[*]"/>

              <if expr="EV(@messageType, 'ios')">
                <set value="0" xpath="/delivery/content/iosNotifType/source"/>
                <set value="&lt;%   if( appSubscription.mobileApp.password!='' &amp;&amp; appSubscription.mobileApp.uuid !='' &amp;&amp;       appSubscription.mobileApp.certificate!='' &amp;&amp; String(appSubscription.mobileApp.sandbox)!='' &amp;&amp;       appSubscription.mobileApp.label &amp;&amp; appSubscription.mobileApp.img &amp;&amp;       String(message.delivery.idTracking)!='' &amp;&amp; String(message.delivery.idMarketing)!='' )   { %&gt; 'OK' &lt;%   }   else   { %&gt; 'Error' &lt;%   } %&gt;"
                     xpath="/delivery/content/iosCheckParams/source"/>
              </if>

              <if expr="EV(@messageType, 'android')">
                <set value="&lt;%= appSubscription.mobileApp.uuid %&gt;" xpath="/delivery/content/androidService/source"/>
                <set value="&lt;%= message.id %&gt;" xpath="/delivery/content/androidCollapseKey/source"/>
                <set value="&lt;%   if( appSubscription.mobileApp.label!='' &amp;&amp; appSubscription.mobileApp.img!='' &amp;&amp;       appSubscription.mobileApp.senderId!='' &amp;&amp; appSubscription.mobileApp.password!='' &amp;&amp;       String(message.delivery.idTracking)!='' &amp;&amp; String(message.delivery.idMarketing)!='' )   { %&gt; 'OK' &lt;%   }   else   { %&gt; 'Error' &lt;%   } %&gt;"
                     xpath="/delivery/content/androidCheckParams/source"/>
              </if>
            </if>
          </enter>
          <sysFilter>
            <condition expr="@type = 3 and @active = 1"/>
            <condition enabledIf="!$(/delivery/@isModel)" expr="@messageType = $(/delivery/@messageType)"/>
            <condition enabledIf="!$(/delivery/@isModel)" expr="(@deliveryMode = $(/delivery/@deliveryMode) or (@deliveryMode in (1,4) and $(/delivery/@deliveryMode) in (1,4)))"/>
          </sysFilter>
        </input>
        <container applicableIf="HasPackage('nms:campaign')" type="visibleGroup"
                   visibleIf="[@operation-id]!=0 and [@workflow-id]!=0 and (EV(@deliveryMode, 'external') or [@linkedDelivery-id]!=0)">
          <container label="メインの配信" type="frame">
            <input createMode="none" fullLoad="true" label="配信" notifyPathList="@offerSpace-id"
                   xpath="linkedDelivery">
              <sysFilter>
                <condition expr="@id!=$(@id)"/>
                <condition expr="@messageType=$(@messageType)"/>
                <condition enabledIf="$(@isModel)==false" expr="@isModel=0"/>
                <condition enabledIf="$(@isModel)" expr="@isModel=1"/>
                <condition expr="[@linkedDelivery-id]=0 and [@operation-id]!=0 and [@workflow-id]!=0"/>
                <condition expr="([@operation-id]=$(@operation-id) or [@operation-id]=$long(/ignored/@linkedOperation-id))"/>
              </sysFilter>
            </input>
            <input expr="Iif([@linkedDelivery-id]!=0, 1, 0)" type="expr" xpath="/ignored/@hasParentDelivery"/>
            <static label="指定されたメインの配信からファイルの抽出を実行します。" type="help"/>
          </container>
        </container>
      </container>
    </container>
<!--[cf]-->
<!--[of]:Summary-->
    <container img="nms:delivery.png" label="概要" name="summary" visibleIf="[/ignored/@isACSConnector]==false">
      <input alwaysActive="true" expr="Coalesce([properties/@outputFile], [properties/@outputLocal])"
             type="expr" xpath="/ignored/@outputFile"/>
      <input addSelectionInPost="true" entityRefresh="nms:delivery" sessionToken="true"
             type="urlViewer" urlExpr="$(serverUrl)+'/nms/delivery.jssp?id='+@id+ '&amp;standalone=1'"/>
      <container applicableIf="HasPackage('nms:campaign')" type="visibleGroup" visibleIf="[@operation-id]!=0 and (EV(@deliveryMode, 'external') or EV(@deliveryMode, 'descriptive')) and (EV(@state,'finished') or EV(@state,'cancelled'))">
        <container label="配信時のアクション" type="frame">
          <input discardReadOnly="true" img="xtk:refresh.png" label="配信を再初期化して再実行..."
                 type="subFormLink" xpath=".">
            <form label="配信を再初期化...">
              <enter>
                <setModified/>
              </enter>
              <static type="warning">配信を再初期化すると、再実行できるようにステータスが「配信準備完了」にリセットされます。</static>
              <static label="「OK」をクリックして確定します。" type="help"/>
              <leave>
            <!-- change statut as 'to validate' (needed to force to delete previous broadlogs) -->
                <soapCall name="CheckValidationAccess" service="nms:operation">
                  <param exprIn="validation" type="DOMElement"/>
                  <param exprIn="[operation/@owner-id]" type="int"/>
                  <param exprIn="-1" type="byte"/>
                  <param type="boolean" xpathOut="/ignored/@hasAccess"/>
                </soapCall>

                <check expr="[/ignored/@hasAccess]">
                  <error>この操作の実行を許可されていません。</error>
                </check>

                <set expr="Eval(@state, 'edition')" xpath="@state"/>
                <set expr="Eval(@contentStatus, 'edition')" xpath="@contentStatus"/>
                <set expr="Eval(@targetStatus, 'edition')" xpath="@targetStatus"/>
                <set expr="Eval(@budgetStatus, 'edition')" xpath="@budgetStatus"/>
                <set expr="Eval(@extractionStatus, 'edition')" xpath="@extractionStatus"/>
                <set expr="Eval(@sandboxStatus, 'edition')" xpath="@sandboxStatus"/>
                <if expr="[@linkedDelivery-id]!=0">
                  <set value="" xpath="scheduling/@contactDate"/>
                </if>
                <discardReadOnly/>
              </leave>
            </form>
          </input>
        </container>
      </container>
    </container>

    <container img="nms:properties.png" label="概要ツリー" name="summaryTree">
      <container type="visibleGroup" visibleIf="@midSourcing">
        <static fontBold="true" img="xtk:loginfo.png" label="配信がミッドソーシングモードで送信されました"/>
      </container>

  <!-- compute some expressions to display in the tree -->
      <input alwaysActive="true" expr="([/ignored/@propertiesMode] == 'wizard' and @launchFCP) or @FCP"
             type="expr" xpath="/ignored/@isFCP"/>
      <input alwaysActive="true" expr="Iif([/ignored/@propertiesMode] == 'wizard', Iif([/ignored/@action]=='edit' and EV(@state,'targetReady','preparationError'), [/ignored/@strForecast], Iif([/ignored/@action]=='FCP', [/ignored/@strFCP], Iif([/ignored/@action]=='send', [/ignored/@strSend], ''))), '')"
             type="expr" xpath="/ignored/@actionLabel"/>
      <input alwaysActive="true" expr="Iif([/ignored/@isFCP], [targets/proofFile/name], Iif([targets/@addProofInTarget], [targets/deliveryFile/name]+' + '+[targets/proofFile/name] , [targets/deliveryFile/name]))"
             type="expr" xpath="/ignored/targetFile"/>
      <input alwaysActive="true" expr="SizeInBytesToString([content/html/source])"
             type="expr" xpath="/ignored/@htmlContentSize"/>
      <input alwaysActive="true" expr="SizeInBytesToString([content/text/source])"
             type="expr" xpath="/ignored/@textContentSize"/>
      <input alwaysActive="true" expr="Iif([fcpParameters/@labelPrefix]=='', '', '[' + [fcpParameters/@labelPrefix] + '] ')"
             type="expr" xpath="/ignored/@subjPrefix"/>
      <input alwaysActive="true" expr="Iif([/ignored/@action]=='FCP' and StartWith([mailParameters/subject],[/ignored/@subjPrefix])==false, [/ignored/@subjPrefix], '') + [mailParameters/subject]"
             type="expr" xpath="/ignored/subject"/>
      <input alwaysActive="true" expr="Coalesce([properties/@outputLocal], [properties/@outputFile])"
             type="expr" xpath="/ignored/@outputFile"/>
      <input alwaysActive="true" expr="[properties/@midAccountUsedCs]+' ('+[properties/@midAccountUsedName]+')'"
             type="expr" xpath="/ignored/@multiMidAccount"/>

      <input editable="false" nolabel="true" type="treeEdit">
        <container label="一般">
          <input label="アクション" visibleIf="[/ignored/@actionLabel] != ''" xpath="/ignored/@actionLabel"/>
          <input editable="true" xpath="@label"/>
          <input editable="true" xpath="@internalName"/>
          <input visibleIf="EV(@messageType, 'sms')==false" xpath="@messageType"/>
          <input xpath="@state"/>
          <input applicableIf="HasPackage('nms:messageCenter')" visibleIf="EV([triggerMessage/@publicationStatus], 'notApplicable')=false"
                 xpath="triggerMessage/@publicationStatus"/>
          <input applicableIf="HasPackage('nms:messageCenter')" visibleIf="[triggerMessage/@eventType]!=''"
                 xpath="triggerMessage/@eventType"/>
          <input editable="true" xpath="@deliveryCode"/>
          <input applicableIf="HasPackage('nms:campaign')" editable="false" visibleIf="[@operation-id]!=0"
                 xpath="@targetStatus"/>
          <input applicableIf="HasPackage('nms:campaign')" editable="false" visibleIf="[@operation-id]!=0"
                 xpath="@contentStatus"/>
          <input applicableIf="HasPackage('nms:campaign')" editable="false" visibleIf="[@budget-id]!=0"
                 xpath="@budgetStatus"/>
          <input applicableIf="HasPackage('nms:campaign')" editable="false" visibleIf="EV(@deliveryMode, 'external')"
                 xpath="@extractionStatus"/>
          <input applicableIf="HasPackage('nms:coupon')" visibleIf="[@coupon-id] != 0"
                 xpath="coupon/@code"/>
          <input editable="true" visibleIf="EV(@state, 'targetReady', 'preparationError') or [scheduling/@delayed] or @state &gt; 15"
                 xpath="scheduling/@contactDate"/>
          <input editable="true" visibleIf="EV(@deliveryMode, 'external')" xpath="scheduling/@extraction"/>
          <input visibleIf="EV(@deliveryMode, 'external')" xpath="scheduling/@extracted"/>
          <input label="出力ファイル" visibleIf="EV(@deliveryMode, 'external')" xpath="/ignored/@outputFile"/>
          <input visibleIf="![/ignored/@isFCP] and EV([targets/@targetMode], 'database')"
                 xpath="targets/deliveryTarget/@serialization"/>
          <input visibleIf="[/ignored/@isFCP] and EV([targets/@targetMode], 'database')"
                 xpath="targets/proofTarget/@serialization"/>
          <input label="ターゲットファイル" visibleIf="EV([targets/@targetMode], 'file')"
                 xpath="/ignored/targetFile"/>
          <input dynamic="true" xpath="properties/@totalTarget"/>
          <input xpath="properties/@toDeliver"/>
          <input xpath="indicators/@processed"/>
          <input xpath="indicators/@success"/>
          <input applicableIf="HasPackage('nms:campaign')" visibleIf="[properties/@ctrlGrpReject] &gt; 0"
                 xpath="properties/@ctrlGrpReject"/>
          <input label="件名" visibleIf="EV(@messageType, 'mail')" xpath="/ignored/subject"/>
          <input visibleIf="EV(@messageType, 'mail')" xpath="mailParameters/senderAddress"/>
          <input visibleIf="EV(@messageType, 'mail')" xpath="mailParameters/senderName"/>
          <input visibleIf="EV(@messageType, 'mail')" xpath="mailParameters/replyAddress"/>
          <input visibleIf="EV(@messageType, 'mail')" xpath="mailParameters/replyName"/>
          <input visibleIf="EV(@messageType, 'mail') and [mailParameters/@useDefaultErrorAddress] == false"
                 xpath="mailParameters/errorAddress"/>
          <input visibleIf="EV(@messageType, 'sms')" xpath="smsParameters/@smsMode"/>
          <input visibleIf="([/ignored/@propertiesMode]=='wizard' or @state &lt;= EVal(@state, 'ready')) and [scenario/@setDirectDates]==false"
                 xpath="scenario/@validityDuration"/>
          <input visibleIf="EV(@deliveryMode, 'external')=false and ([/ignored/@propertiesMode]=='wizard' or @state &lt;= EVal(@state, 'ready')) and [scenario/@setDirectDates]==false"
                 xpath="scenario/@webValidityDuration"/>
          <input visibleIf="EV(@deliveryMode, 'external')=false and ([/ignored/@propertiesMode]!='wizard' and @state &gt; EVal(@state, 'ready')) or [scenario/@setDirectDates]"
                 xpath="scheduling/@validityDate"/>
          <input visibleIf="([/ignored/@propertiesMode]!='wizard' and @state &gt; EVal(@state, 'ready')) or [scenario/@setDirectDates]"
                 xpath="scheduling/@webValidityDate"/>
          <input dynamic="true" visibleIf="EV(@deliveryMode, 'external')" xpath="properties/@outputLine"/>
          <input visibleIf="EV(@deliveryMode, 'external') and [properties/@seedProcessed] &gt; 0"
                 xpath="properties/@seedProcessed"/>
          <input visibleIf="[properties/@importReject]  &gt; 0" xpath="properties/@importReject"/>
          <input visibleIf="[properties/@reject]     &gt; 0" xpath="properties/@reject"/>
          <input label="フォルダー" visibleIf="@midSourcing == false" xpath="folder"/>
        </container>
        <container label="ミッドソーシング" visibleIf="@midSourcing or EV(@deliveryMode, 'midSourcing')">
          <input label="使用されるミッドソーシングアカウント" visibleIf="[properties/@midAccountUsedName] != ''"
                 xpath="/ignored/@multiMidAccount"/>
          <input xpath="properties/@midRemoteId"/>
          <input label="送信日" visibleIf="@midSourcing" xpath="@midSubmitDate"/>
        </container>
        <container collapsed="true" label="コンテンツ" visibleIf="EV(@messageType, 'mail')">
          <input visibleIf="[properties/@html]     &gt; 0" xpath="properties/@html"/>
          <input visibleIf="[properties/@text]     &gt; 0" xpath="properties/@text"/>
          <input visibleIf="[properties/@multipart]&gt; 0" xpath="properties/@multipart"/>
          <input xpath="@hasAttachments"/>
          <input label="HTML コンテンツ" xpath="/ignored/@htmlContentSize"/>
          <input label="テキストコンテンツ" xpath="/ignored/@textContentSize"/>
          <input xpath="content/@formatSelection"/>
          <input xpath="content/@htmlCompression"/>
          <input xpath="content/@multipartRelated"/>
        </container>
        <container collapsed="true" label="詳細設定パラメーター">
          <input xpath="deliveryProvider"/>
          <input visibleIf="EV(@messageType, 'sms')" xpath="smsParameters/@mobileMsgType"/>
          <input xpath="@priority"/>
          <input label="ターゲット" visibleIf="EV([targets/@targetMode], 'address')" xpath="targets/@recipientList"/>

      <!-- ## should be visible only if there is a ranking rule -->
          <input label="配信の重み付け" visibleIf="@midSourcing == false and [forecast/weightFormula] == '$(deliveryWeight)'"
                 xpath="forecast/@weight"/>
          <input label="配信の数式の重み付け" visibleIf="@midSourcing == false and [forecast/weightFormula] &lt;&gt; '$(deliveryWeight)'"
                 xpath="forecast/weightFormula"/>
          <input visibleIf="EV(@messageType, 'mail')" xpath="execution/@maxRetry"/>
          <input visibleIf="EV(@messageType, 'mail')" xpath="execution/@retryPeriod"/>
          <input xpath="targets/@deduplicate"/>
          <input visibleIf="[targets/@noRcpIdDedup]" xpath="targets/@noRcpIdDedup"/>
          <input xpath="targets/@useBlackList"/>
          <input xpath="targets/@useQuarantine"/>
          <input visibleIf="[targets/@useDeliveryLimit]" xpath="targets/@deliveryLimit"/>
          <input visibleIf="@state &lt; EVal(@state, 'ready')" xpath="scheduling/@validationMode"/>
          <input xpath="scheduling/@delayed"/>
          <input xpath="targets/@targetMode"/>
          <input xpath="tracking/@enabled"/>
          <input visibleIf="[tracking/@enabled] and EV(@messageType, 'mail')" xpath="tracking/@openEnabled"/>
        </container>
      </input>
    </container>


<!--[cf]-->
<!--[of]:Content-->
    <container name="content">
  <!--[of]:  Preview-->
      <container label="プレビュー" name="Preview" xpath="..">
        <input name="previewToolbar" type="toolbarCtrl"/>
        <static type="separator"/>
        <container name="headers" xpath="/tmp/html/preview">
          <container colcount="2" name="mail" nolabel="true" vertSpacing="0">
            <container colcount="2">
              <container type="visibleGroup" visibleIf="[attachmentList/@active] and NodeExists([attachmentList/attachment])">
                <static img="nms:attachment.png" type="image"/>
            <!-- display attachment icon if the mail contains attachments -->
              </container>
              <container colcount="2">
                <value label="送信者" xpath="from"/>
                <value label="サイズ" xpath="@size"/>
                <value label="件名" xpath="subject"/>
                <input img="nms:email.png" label="詳細..." prebuildSubForm="false"
                       type="subFormLink" xpath=".">
                  <form label="結果をプレビュー" nothingToEdit="true" nothingToSave="true"
                        type="notebook">
                    <container label="一般">
                      <container label="ヘッダー" type="frame">
                        <value label="宛先" xpath="to"/>
                        <value label="送信者" xpath="from"/>
                        <value label="返信先" xpath="replyTo"/>
                        <value label="件名" xpath="subject"/>
                        <value label="エラーアドレス" xpath="returnPath"/>
                        <value label="MIME 識別子" xpath="mimeMsgId"/>
                        <value label="コンテンツタイプ" xpath="contentType"/>
                      </container>
                      <container type="visibleGroup" visibleIf="@wrongContent">
                        <static img="xtk:logwarn.png" nolabel="true">メインウィンドウに表示されるコンテンツが、受信者に送信されるフォーマットと一致しません。</static>
                      </container>
                      <value label="E メールのサイズ" xpath="@size"/>
                      <value label="コンテンツサイズ" xpath="@contentSize"/>
                      <container type="visibleGroup" visibleIf="@needMirrorPage==0">
                        <static label="ミラーページ" nolabel="false">使用不可</static>
                      </container>
                      <container type="visibleGroup" visibleIf="@needMirrorPage==1">
                        <static img="xtk:html.png" label="ミラーページ" nolabel="false">使用可能</static>
                      </container>
                      <container type="visibleGroup" visibleIf="@needMirrorPage==2">
                        <static img="xtk:html.png" label="ミラーページ" nolabel="false">メッセージ識別子からアクセス可能</static>
                      </container>
                    </container>
                    <container label="添付ファイル">
                      <container type="visibleGroup" visibleIf="[attachmentList/@active]==false or NodeExists([attachmentList/attachment])==false">
                        <static img="xtk:loginfo.png">E メールに添付ファイルが含まれていません</static>
                      </container>
                      <container type="visibleGroup" visibleIf="[attachmentList/@active] and NodeExists([attachmentList/attachment])">
                        <container label="添付ファイル" type="frame">
                          <input editable="false" img="nms:attachment.png" noToolbar="true"
                                 nolabel="true" type="list" xpath="attachmentList/attachment"
                                 xpathIndex="/tmp/preview/attachment/@current">
                            <input label="ラベル" width="25" xpath="@label"/>
                            <input label="ファイル" xpath="@fileName"/>
                            <input label="表示名" xpath="@display"/>
                            <input label="サイズ" xpath="@size"/>
                          </input>
                        </container>
                        <container nolabel="true" type="collectionItemGroup" xpath="attachmentList/attachment"
                                   xpathIndex="/tmp/preview/attachment/@current">
                          <container type="visibleGroup" visibleIf="@urlSrv != ''">
                            <input format="pdf" type="browser" xpath="@urlSrv"/>
                          </container>
                          <container type="visibleGroup" visibleIf="@notUploaded">
                            <static img="xtk:loginfo.png">このファイルはまだサーバーにアップロードされていません</static>
                          </container>
                        </container>
                      </container>
                    </container>
                    <container label="スパム対策チェック">
                      <input strings="nms:spamReport" type="docViewer" xpath="spamReport"
                             xslt="nms:spamReport.xsl"/>
                    </container>
                    <container label="データ読み込み">
                      <input nolabel="true" readOnly="true" type="SourceEdit" xpath="/tmp/rcpQryResult/queryResult"/>
                      <static type="help">この XML ドキュメントは、この受信者用のプレビューを作成するために読み込まれるすべての情報を表します。</static>
                    </container>
                  </form>
                </input>
            <!-- display a warning if spam detected -->
                <container colspan="2" type="visibleGroup" visibleIf="[spamReport/@spam] != '' and [spamReport/@spam]==0 and [spamReport/error]==''">
                  <static img="xtk:finished.png" label=" " nolabel="false">スパム対策チェックが成功しました (詳しくは、「詳細...」をクリックしてください)。</static>
                </container>
                <container colspan="2" type="visibleGroup" visibleIf="[spamReport/@spam]==1">
                  <static img="xtk:logwarn.png" label=" " nolabel="false">スパム対策チェックによってこの E メールが高リスクであることが検出されました (詳しくは、「詳細」をクリックしてください)。</static>
                </container>
                <container colspan="2" type="visibleGroup" visibleIf="[spamReport/error]!='' and [spamReport/@spam]==''">
                  <static img="xtk:logerr.png" label=" " nolabel="false">スパム対策チェックが失敗しました (詳しくは、「詳細...」をクリックしてください)。</static>
                </container>
              </container>
            </container>
          </container>
        </container>
        <container name="body">
      <!-- container just for includeView factorization -->
          <input name="ctPreview" nolabel="true" toolbarName="previewToolbar" type="contentPreview"
                 xpath="." xpathRcpQuery="/tmp/rcpQryResult/queryResult" xpathSelection="/ignored/selectPart/rcpList"
                 xpathTargetSchema="/delivery/mapping/@schema" xpathTargets="/delivery/targets">
            <form label="受信者を選択" name="selectTargetForPreview" nothingToSave="true">
              <input hideEditButtons="true" nolabel="true" showAll="true" type="targetPreviewList"
                     xpath="/ignored/previewList" xpathParams="/delivery/variables"
                     xpathSelection="/ignored/recipientBtn/subForm" xpathTargets="/delivery/targets"/>
            </form>
            <form label="プレビューするシードアドレスの選択" name="selectSeedForPreview" nothingToSave="true">
              <container defaultColumns="@label,[custom_nms_recipient/@email],[custom_nms_broadLog/postalAddress/address/serialized]"
                         multiSelection="false" newEntityFormChoice="false" nodeModel="nmsSeedList"
                         schema="nms:seedMember" sharedUserConfig="true" type="navTreeEntityList"
                         xpath="/ignored/seedMember">
                <sysFilter>
                  <condition expr="@isModel=0 and ([@proof-id]=$(/delivery/@id) or [@delivery-id]=$(/delivery/@id) or ([@delivery-id]=0 and [@proof-id]=0))"/>
                </sysFilter>
              </container>
            </form>
            <form label="プレビュー用のターゲットレコードの選択" name="selectTargetPartForPreview" nothingToSave="true">
              <input hideEditButtons="true" nolabel="true" type="targetPreviewList"
                     xpath="/ignored/previewList" xpathParams="/delivery/variables"
                     xpathSelection="/ignored/recipientBtn/subForm" xpathTargetPart="."
                     xpathTargets=".."/>
            </form>
          </input>
        </container>
      </container>
  <!--[cf]-->
  <!--[of]:  HTML-->
      <container name="HTML">
        <container type="visibleGroup" visibleIf="EV([../@formatSelection], 'text')">
          <static img="xtk:logwarn.png">この配信用に定義されている HTML フォーマットは送信されませんが、ミラーページでのみ使用されます。</static>
        </container>

        <container img="xtk:html.png" label="HTML" name="htmlContentEditor">

          <container name="notebook" style="flat" type="contentEditor" xpath="source">

            <container label="編集" visibleIf="[/delivery/@contentEditingMode]=1">
              <input mode="delivery" toolbar="true" type="digitalContentEditor" xpath="."
                     xpathSchema="/delivery/mapping/@schema" xpathUseAEM="/delivery/@useAEM">&gt;
              <form label="リソースのパブリッシュ" nothingToEdit="true" nothingToSave="true">
                  <container name="localResourcesUploader" type="localResourcesUploader"
                             xpathCurProgress="/tmp/@uploadCurrent" xpathFilesToDownload="/tmp/localResources"
                             xpathMaxProgress="/tmp/@uploadMax">
                    <input name="JobLogsList" type="JobLogList"/>
                    <container colcount="2">
                      <value name="JobProgressBar" type="ProgressBar" valign="center"
                             xpathCur="/tmp/@uploadCurrent" xpathMax="/tmp/@uploadMax"/>
                    </container>
                  </container>
                  <leave>
                    <set value="true" xpath="/tmp/@uploadImages"/>
                  </leave>
                </form>
              </input>
            </container>

            <container label="HTML" name="tabHtml" visibleIf="[/delivery/@contentEditingMode]=0 or [/delivery/@contentEditingMode]=2">
              <container type="visibleGroup" visibleIf="[/ignored/@isLinkedToContent]='true'">
                <container readOnly="true">
                  <value xpath="/delivery/mailParameters/subject"/>
                  <input bodyMode="false" fullToolbar="true" localImages="true" name="ctWysiwyg"
                         nolabel="true" type="dhtml" viewSourceBtn="false" xpath="."
                         xpathImageConfig="../imageConfig" xpathInsert="/ignored/customizeHTMLWysiwyg"
                         xpathUrl="/tmp/urlTree/@toSelect" xpathUseAEM="/delivery/@useAEM">
                    <form label="画像をアップロード" nothingToEdit="true" nothingToSave="true">
                      <container ref="nms:delivery:lib/imageUpload"/>
                      <leave>
                        <set value="true" xpath="../../@uploadImages"/>
                      </leave>
                    </form>
                    <container>
                      <input menuId="deliveryMenuBuilder" options="html" type="customizeBtn"
                             xpath="/ignored/customizeHTMLWysiwyg"/>
                    </container>
                  </input>
                </container>
              </container>
              <container type="visibleGroup" visibleIf="[/ignored/@isLinkedToContent]!='true'">
                <input bodyMode="false" fullToolbar="true" localImages="true" name="ctWysiwyg"
                       nolabel="true" type="dhtml" viewSourceBtn="false" xpath="."
                       xpathImageConfig="../imageConfig" xpathInsert="/ignored/customizeHTMLWysiwyg"
                       xpathUrl="/tmp/urlTree/@toSelect" xpathUseAEM="/delivery/@useAEM">
                  <form label="画像をアップロード" nothingToEdit="true" nothingToSave="true">
                    <container ref="nms:delivery:lib/imageUpload"/>
                    <leave>
                      <set value="true" xpath="../../@uploadImages"/>
                    </leave>
                  </form>
                  <container>
                    <input menuId="deliveryMenuBuilder" options="html" type="customizeBtn"
                           xpath="/ignored/customizeHTMLWysiwyg"/>
                  </container>
                </input>
              </container>
            </container>

            <container label="ソース" name="tabSource" readOnlyIf="[/ignored/@isLinkedToContent]='true'">
              <input fullToolbar="true" localImages="true" name="ctSource" nolabel="true"
                     type="htmlSource" xpath="." xpathImageConfig="../imageConfig"
                     xpathInsert="/ignored/customizeSrcHTMLWysiwyg" xpathSelectCode="/tmp/htmlDiagnostics/@toSelect"
                     xpathTidy="/tmp/tidy/@doTidy" xpathUrl="/tmp/urlTree/@toSelect">
                <form label="画像をアップロード" name="imageUpload" nothingToEdit="true" nothingToSave="true">
                  <container ref="nms:delivery:lib/imageUpload"/>
                  <leave>
                    <set value="true" xpath="../../@uploadImages"/>
                  </leave>
                </form>
                <container>
                  <input menuId="deliveryMenuBuilder" options="html" type="customizeBtn"
                         xpath="/ignored/customizeSrcHTMLWysiwyg"/>
                </container>
              </input>
            </container>
            <container label="プレビュー" name="tabPreview" xpath="..">
              <input name="previewToolbar" type="toolbarCtrl"/>
              <static type="separator"/>
              <container name="headers" xpath="/tmp/html/preview">
                <container colcount="2" name="mail" nolabel="true" vertSpacing="0">
                  <container colcount="2">
                    <container type="visibleGroup" visibleIf="[attachmentList/@active] and NodeExists([attachmentList/attachment])">
                      <static img="nms:attachment.png" type="image"/>
                  <!-- display attachment icon if the mail contains attachments -->
                    </container>
                    <container colcount="2">
                      <value label="送信者" xpath="from"/>
                      <value label="サイズ" xpath="@size"/>
                      <value label="件名" xpath="subject"/>
                      <input img="nms:email.png" label="詳細..." prebuildSubForm="false"
                             type="subFormLink" xpath=".">
                        <form label="結果をプレビュー" nothingToEdit="true" nothingToSave="true"
                              type="notebook">
                          <container label="一般">
                            <container label="ヘッダー" type="frame">
                              <value label="宛先" xpath="to"/>
                              <value label="送信者" xpath="from"/>
                              <value label="返信先" xpath="replyTo"/>
                              <value label="件名" xpath="subject"/>
                              <value label="エラーアドレス" xpath="returnPath"/>
                              <value label="MIME 識別子" xpath="mimeMsgId"/>
                              <value label="コンテンツタイプ" xpath="contentType"/>
                            </container>
                            <container type="visibleGroup" visibleIf="@wrongContent">
                              <static img="xtk:logwarn.png" nolabel="true">メインウィンドウに表示されるコンテンツが、受信者に送信されるフォーマットと一致しません。</static>
                            </container>
                            <value label="E メールのサイズ" xpath="@size"/>
                            <value label="コンテンツサイズ" xpath="@contentSize"/>
                            <container type="visibleGroup" visibleIf="@needMirrorPage==0">
                              <static label="ミラーページ" nolabel="false">使用不可</static>
                            </container>
                            <container type="visibleGroup" visibleIf="@needMirrorPage==1">
                              <static img="xtk:html.png" label="ミラーページ" nolabel="false">使用可能</static>
                            </container>
                            <container type="visibleGroup" visibleIf="@needMirrorPage==2">
                              <static img="xtk:html.png" label="ミラーページ" nolabel="false">メッセージ識別子からアクセス可能</static>
                            </container>
                          </container>
                          <container label="添付ファイル">
                            <container type="visibleGroup" visibleIf="[attachmentList/@active]==false or NodeExists([attachmentList/attachment])==false">
                              <static img="xtk:loginfo.png">E メールに添付ファイルが含まれていません</static>
                            </container>
                            <container type="visibleGroup" visibleIf="[attachmentList/@active] and NodeExists([attachmentList/attachment])">
                              <container label="添付ファイル" type="frame">
                                <input editable="false" img="nms:attachment.png"
                                       noToolbar="true" nolabel="true" type="list"
                                       xpath="attachmentList/attachment" xpathIndex="/tmp/preview/attachment/@current">
                                  <input label="ラベル" width="25" xpath="@label"/>
                                  <input label="ファイル" xpath="@fileName"/>
                                  <input label="表示名" xpath="@display"/>
                                  <input label="サイズ" xpath="@size"/>
                                </input>
                              </container>
                              <container nolabel="true" type="collectionItemGroup"
                                         xpath="attachmentList/attachment" xpathIndex="/tmp/preview/attachment/@current">
                                <container type="visibleGroup" visibleIf="@urlSrv != ''">
                                  <input format="pdf" type="browser" xpath="@urlSrv"/>
                                </container>
                                <container type="visibleGroup" visibleIf="@notUploaded">
                                  <static img="xtk:loginfo.png">このファイルはまだサーバーにアップロードされていません</static>
                                </container>
                              </container>
                            </container>
                          </container>
                          <container label="スパム対策チェック">
                            <input strings="nms:spamReport" type="docViewer" xpath="spamReport"
                                   xslt="nms:spamReport.xsl"/>
                          </container>
                          <container label="データ読み込み">
                            <input nolabel="true" readOnly="true" type="SourceEdit"
                                   xpath="/tmp/rcpQryResult/queryResult"/>
                            <static type="help">この XML ドキュメントは、この受信者用のプレビューを作成するために読み込まれるすべての情報を表します。</static>
                          </container>
                          <container label="デコメールの診断">
                            <container type="visibleGroup" visibleIf="[/tmp/html/preview/@rawSize]&gt;(100*1024)">
                              <static type="warning">メッセージサイズがデコレーションメールメッセージの最大サイズ (100 KB) を超えています。</static>
                            </container>
                            <input format="deco" type="htmlDiagnosticList" xpath="content"
                                   xpathRefresh="deco"/>
                          </container>
                        </form>
                      </input>
                  <!-- display a warning if spam detected -->
                      <container colspan="2" type="visibleGroup" visibleIf="[spamReport/@spam] != '' and [spamReport/@spam]==0 and [spamReport/error]==''">
                        <static img="xtk:finished.png" label=" " nolabel="false">スパム対策チェックが成功しました (詳しくは、「詳細...」をクリックしてください)。</static>
                      </container>
                      <container colspan="2" type="visibleGroup" visibleIf="[spamReport/@spam]==1">
                        <static img="xtk:logwarn.png" label=" " nolabel="false">スパム対策チェックによってこの E メールが高リスクであることが検出されました (詳しくは、「詳細」をクリックしてください)。</static>
                      </container>
                      <container colspan="2" type="visibleGroup" visibleIf="[spamReport/error]!='' and [spamReport/@spam]==''">
                        <static img="xtk:logerr.png" label=" " nolabel="false">スパム対策チェックが失敗しました (詳しくは、「詳細...」をクリックしてください)。</static>
                      </container>
                    </container>
                  </container>
                </container>
              </container>
              <container name="body">
            <!-- container just for includeView factorization -->
                <input name="ctPreview" nolabel="true" toolbarName="previewToolbar"
                       type="contentPreview" xpath="." xpathRcpQuery="/tmp/rcpQryResult/queryResult"
                       xpathSelection="/ignored/selectPart/rcpList" xpathTargetSchema="/delivery/mapping/@schema"
                       xpathTargets="/delivery/targets">
                  <form label="受信者を選択" name="selectTargetForPreview" nothingToSave="true">
                    <input hideEditButtons="true" nolabel="true" showAll="true" type="targetPreviewList"
                           xpath="/ignored/previewList" xpathParams="/delivery/variables"
                           xpathSelection="/ignored/recipientBtn/subForm" xpathTargets="/delivery/targets"/>
                  </form>
                  <form label="プレビュー用のターゲットレコードの選択" name="selectTargetPartForPreview"
                        nothingToSave="true">
                    <input hideEditButtons="true" nolabel="true" type="targetPreviewList"
                           xpath="/ignored/previewList" xpathParams="/delivery/variables"
                           xpathSelection="/ignored/recipientBtn/subForm" xpathTargetPart="."
                           xpathTargets=".."/>
                  </form>
                  <form label="プレビューするシードアドレスの選択" name="selectSeedForPreview" nothingToSave="true">
                    <container defaultColumns="@label,@internalName" multiSelection="false"
                               newEntityFormChoice="false" nodeModel="nmsSeedList"
                               schema="nms:seedMember" sharedUserConfig="true" type="navTreeEntityList"
                               xpath="/ignored/seedMember">
                      <sysFilter>
                        <condition expr="@isModel=0 and ([@proof-id]=$(/delivery/@id) or [@delivery-id]=$(/delivery/@id) or ([@delivery-id]=0 and [@proof-id]=0))"/>
                      </sysFilter>
                    </container>
                  </form>
                </input>
              </container>
            </container>
          </container>

          <container colcount="2" type="visibleGroup" visibleIf="![/tmp/@readOnly]">
            <container type="visibleGroup" visibleIf="[../../tracking/@enabled]">
              <input label="URL を表示" nolabel="true" type="checkBox" xpath="/tmp/urlTree/@display"/>
            </container>
            <input label="HTML 診断を表示" nolabel="true" type="checkBox" xpath="/tmp/htmlDiagnostics/@display"/>
          </container>

          <container colcount="2" name="contUrl">
            <container name="contUrlTree" type="visibleGroup" visibleIf="[../../tracking/@enabled]">
              <container type="visibleGroup" visibleIf="[/tmp/urlTree/@display] == 'true'">
                <input lineCount="7" type="urlTree" xpath="." xpathRefresh="/tmp/urlTree/@display"
                       xpathUrl="/tmp/urlTree/@toSelect"/>
              </container>
            </container>

            <container type="visibleGroup" visibleIf="[/tmp/htmlDiagnostics/@display] == 'true'">
              <input lineCount="7" type="htmlDiagnosticList" xpath="/delivery/content/html/source"
                     xpathRefresh="/tmp/htmlDiagnostics/@display" xpathSelectCode="/tmp/htmlDiagnostics/@toSelect"/>

              <input img="xtk:xtkcheck.png" label="HTML コードを修正..." prebuildSubForm="false"
                     type="subFormLink">
                <form label="HTML コード修正オプション" nothingToSave="true">
                  <container>
                    <static type="help">フォーマットが正しくない HTML コードを修正します。この処理によって、ドキュメントの最終的な見た目が変わることがあります。\n  通常、デフォルトの設定は大部分のドキュメントに適していますが、特定のオプションを指定することもできます。</static>
                    <input label="圧縮 : コメントと完全に不要なタグを削除" type="checkBox" xpath="/tmp/tidy/@hide-comments"/>
                    <input label="圧縮 : スタイルを再グループ化および再利用" type="checkBox" xpath="/tmp/tidy/@clean"/>
                    <input label="コードレイアウトを改善" type="checkBox" xpath="/tmp/tidy/@vertical-space"/>
                    <input label="コードを XHTML に変換" type="checkBox" xpath="/tmp/tidy/@output-xhtml"/>
                    <input label="Word で生成されたスタイル情報を削除 (最終的な見た目が変わることがあります)" type="checkBox"
                           xpath="/tmp/tidy/@word-2000"/>
                    <input expr="[/tmp/tidy/@hide-comments]" type="expr" xpath="/tmp/tidy/@hide-endtags"/>
                    <input expr="Iif([/tmp/tidy/@vertical-space], 'yes', 'no')" type="expr"
                           xpath="/tmp/tidy/@indent"/>
                    <input expr="Iif([/tmp/tidy/@hide-comments], 'omit', 'auto')"
                           type="expr" xpath="/tmp/tidy/@doctype"/>
                  </container>
                  <leave>
                    <set value="1" xpath="/tmp/tidy/@doTidy"/>
                    <set value="0" xpath="/tmp/htmlDiagnostics/@display"/>
                <!-- Hide the diagnostics list -->
                  </leave>
                </form>
              </input>
            </container>
          </container>
        </container>
      </container>
  <!--[cf]-->
  <!--[of]:  Text-->
      <container name="Text">
        <container img="xtk:text.png" label="テキスト" name="textContentEditor">
          <container name="notebook" style="flat" type="contentEditor" xpath="source">
            <container label="テキスト" name="tabText" readOnlyIf="[/ignored/@isLinkedToContent]='true'">
              <container type="visibleGroup" visibleIf="[/ignored/@isLinkedToContent]='true'">
                <value xpath="/delivery/mailParameters/subject"/>
              </container>
              <input fullToolbar="true" htmlMode="false" name="ctSource" nolabel="true"
                     type="htmlSource" xpath="." xpathInsert="/ignored/customizeTextContent"
                     xpathUrl="/tmp/urlTree/@toSelect">
                <container>
                  <input menuId="deliveryMenuBuilder" type="customizeBtn" xpath="/ignored/customizeTextContent"/>
                  <input ignoreXPath="true" img="nms:htmltotext.png" insertAfter="Open"
                         label="HTML をインポート" textAlign="toolTip" type="flatButton"
                         visibleIf="[../../../content/html/source]!=''">
                    <enter>
                      <set expr="iif([.]=='', 'yes', 'no')" xpath="/ignored/@overrideTextContent"/>
                      <if expr="[.]!=''">
                        <msgBox translatedExpr="'既存のコンテンツは置き換えられます。続行しますか？'" type="yesno"
                                xpathOut="/ignored/@overrideTextContent"/>
                      </if>
                      <if expr="[/ignored/@overrideTextContent]='yes'">
                        <soapCall name="HtmlToText" service="nms:delivery">
                          <param exprIn="[../../html/source]" type="string"/>
                          <param type="string" xpathOut="."/>
                        </soapCall>
                      </if>
                    </enter>
                  </input>
                </container>
              </input>
            </container>
            <container label="プレビュー" name="tabPreview">
              <input name="previewToolbar" type="toolbarCtrl"/>
              <static type="separator"/>
              <container ref="nms:delivery:lib/content/Preview/headers/mail" xpath="/tmp/text/preview"/>
              <container ref="nms:delivery:lib/content/Preview/body" xpath=".."/>
            </container>
          </container>
        </container>
        <container type="visibleGroup" visibleIf="[../../tracking/@enabled]">
          <input label="URL を表示" nolabel="true" type="checkBox" xpath="/tmp/urlTree/@display"/>
        </container>
        <container name="contUrlTree" ref="nms:delivery:lib/content/HTML/htmlContentEditor/contUrl/contUrlTree"
                   xpath="."/>
      </container>
  <!--[cf]-->
  <!--[of]:  Facebook-->
      <container name="Facebook">
        <container img="nms:facebook.png" label="Facebook" name="facebookContentEditor"
                   xpath="source">
          <container label="プレビュー" name="tabPreview">
            <input name="previewToolbar" type="toolbarCtrl"/>
            <static type="separator"/>
            <container ref="nms:delivery:lib/content/Preview/body" xpath=".."/>
          </container>
        </container>
      </container>
  <!--[cf]-->
  <!--[of]:  Tweet-->
      <container name="Tweet">
        <container img="nms:twitter.png" label="ツイート" name="tweetContentEditor" xpath="source">
          <container label="テキスト" name="tabText">
            <input fullToolbar="true" htmlMode="false" name="ctSource" nolabel="true"
                   type="htmlSource" xpath="." xpathInsert="/ignored/customizeTextContent"
                   xpathUrl="/tmp/urlTree/@toSelect">
              <container>
                <input menuId="deliveryMenuBuilder" type="customizeBtn" xpath="/ignored/customizeTextContent"/>
              </container>
            </input>
          </container>
          <container label="プレビュー" name="tabPreview">
            <input name="previewToolbar" type="toolbarCtrl"/>
            <static type="separator"/>
            <container ref="nms:delivery:lib/content/Preview/body" xpath=".."/>
          </container>
        </container>
      </container>
  <!--[cf]-->
  <!--[of]:  Line-->
      <container name="Line">
        <container img="nms:line.png" label="LINE メッセージ" name="lineContentEditor"
                   xpath="source">
          <container label="プレビュー" name="tabPreview">
            <input name="previewToolbar" type="toolbarCtrl"/>
            <static type="separator"/>
            <container ref="nms:delivery:lib/content/Preview/body" xpath=".."/>
          </container>
        </container>
      </container>
  <!--[cf]-->
  <!--[of]:  iOS-->
      <container name="iOS">
        <container img="nms:ios.png" label="iOS" name="iOSContentEditor">
          <container colcount="2" label="コンテンツ" maxLabelWidth="80" name="tabContent">
            <container colcount="5" colspan="2" label="アラートのスタイル" name="notificationType"
                       type="frame">
              <input checkedValue="2" label="アラートおよびバッジ" nolabel="false" type="radiobutton"
                     xpath="iosNotifType/source"/>
              <input checkedValue="0" label="アラート" nolabel="false" type="radiobutton"
                     xpath="iosNotifType/source"/>
              <input checkedValue="1" label="バッジ" nolabel="false" type="radiobutton"
                     xpath="iosNotifType/source"/>
              <input checkedValue="3" label="サイレントプッシュ" nolabel="false" type="radiobutton"
                     xpath="iosNotifType/source"/>
              <static label="通知の裁量レベルを定義できます." type="help"/>
            </container>
            <!-- Title selection -->
            <container colspan="2" type="visibleGroup" visibleIf="[iosNotifType/source]!=1 and [iosNotifType/source]!=3">
              <input label="タイトル" menuId="deliveryMenuBuilder" type="scriptEdit"
                     xpath="iosTitle/source"/>
            </container>
            <!-- SubTitle selection -->
            <container colspan="2" type="visibleGroup" visibleIf="[iosNotifType/source]!=1 and [iosNotifType/source]!=3 and [/ignored/@isIOSHTTP2]">
              <input label="サブタイトル" menuId="deliveryMenuBuilder" type="scriptEdit"
                     xpath="iosSubTitle/source"/>
            </container>
            <!-- Alert selection -->
            <container colspan="2" type="visibleGroup" visibleIf="[iosNotifType/source]!=1 and [iosNotifType/source]!=3">
              <input fullToolbar="true" htmlMode="false" label="メッセージ" name="ctSource"
                     nolabel="false" type="htmlSource" xpath="iosMessage/source"
                     xpathInsert="/ignored/customizeTextContent" xpathUrl="/tmp/urlTree/@toSelect">
                <container>
                  <input menuId="deliveryMenuBuilder" type="customizeBtn" xpath="/ignored/customizeTextContent"/>
                </container>
              </input>
            </container>
            <!-- Badge selection -->
            <container colspan="2" type="visibleGroup" visibleIf="[iosNotifType/source]!=0 and [iosNotifType/source]!=3">
              <input editable="true" label="バッジの値" menuId="deliveryMenuBuilder" type="scriptEdit"
                     xpath="iosBadge/source"/>
            </container>
            <!-- Sound selection -->
            <container colspan="2" type="visibleGroup" visibleIf="[/ignored/@triggerMessage]!=1 and [iosNotifType/source]!=3">
              <input colspan="2" enumXPath="/tmp/notificationSounds" label="サウンドを再生"
                     type="DynEnumCombo" xpath="iosSound/source"/>
            </container>
            <container colspan="2" type="visibleGroup" visibleIf="[/ignored/@triggerMessage]=1 and [iosNotifType/source]!=3">
              <input label="サウンドを再生" menuId="deliveryMenuBuilder" type="scriptEdit"
                     xpath="iosSound/source"/>
            </container>
            <!-- Loc. Action button selection -->
            <container colspan="2" type="visibleGroup" visibleIf="[iosNotifType/source]!=1 and [iosNotifType/source]!=3">
              <input label="アクションボタン" menuId="deliveryMenuBuilder" type="scriptEdit"
                     xpath="iosActionLocKey/source"/>
            </container>
            <!-- Thread-id selection -->
            <container colspan="2" type="visibleGroup" visibleIf="[/ignored/@isIOSHTTP2]">
              <input label="スレッド ID" menuId="deliveryMenuBuilder" type="scriptEdit"
                     xpath="iosThreadId/source"/>
            </container>
            <!-- Other options -->
            <container colcount="2" colspan="2" type="visibleGroup" visibleIf="[iosNotifType/source]!=3 and [/ignored/@isIOSHTTP2]">
              <input label="可変コンテンツ" menuId="deliveryMenuBuilder" type="checkBox"
                     xpath="iosMutable/source"/>
              <input label="カテゴリ" menuId="deliveryMenuBuilder" type="scriptEdit"
                     xpath="iosCategory/source"/>
            </container>
            <!-- List with additional notification parameters -->
            <static colspan="2" label="アプリケーション変数" type="separator"/>
            <container colspan="2" type="visibleGroup" visibleIf="[/ignored/@triggerMessage]!=1">
              <input editable="false" hideEditButtons="true" label=" " nolabel="false"
                     type="list" xpath="/tmp/notificationCustomFields/customFieldsItem">
                <input label="キー" readOnly="true" type="edit" xpath="@key"/>
                <input editable="true" label="値" menuId="deliveryMenuBuilder" type="scriptEdit"
                       xpath="@value"/>
              </input>
            </container>
            <container colspan="2" type="visibleGroup" visibleIf="[/ignored/@triggerMessage]=1">
              <input editable="true" label=" " nolabel="false" type="list" xpath="/tmp/notificationCustomFields/customFieldsItem"
                     zoomOnAdd="false">
                <input label="キー" type="edit" xpath="@key"/>
                <input label="値" menuId="deliveryMenuBuilder" type="scriptEdit" xpath="@value"/>
              </input>
            </container>
          </container>
          <container colcount="2" label="プレビュー" name="tabPreview">
            <input colspan="2" name="previewToolbar" type="toolbarCtrl"/>
            <value label="長さ" xpath="/tmp/sms/preview/@length"/>
            <input label="データ読み込み..." nolabel="true" prebuildSubForm="false" type="subFormLink"
                   xpath="/tmp/rcpQryResult">
              <form label="プレビュー用に読み込まれた受信者のデータ">
                <input nolabel="true" readOnly="true" type="SourceEdit" xpath="queryResult"/>
              </form>
            </input>
            <static colspan="2" type="separator"/>
            <container ref="nms:delivery:lib/content/Preview/body" xpath="iosMessage"/>
            <input sessionToken="true" type="urlViewer" urlExpr="$(serverUrl) + '/nms/deliveryPreview.jssp?alert='+urlUtf8Encode([/tmp/iosMessage/preview/content/iosMessage])+'&amp;messageType=' + [/delivery/@messageType] + '&amp;image='+[/tmp/rcpQryResult/queryResult/message/custom/appSubscription/mobileApp/@img] + '&amp;notifTitle='+ Iif([/tmp/iosMessage/preview/content/iosTitle]=='',urlUtf8Encode([/tmp/rcpQryResult/queryResult/message/custom/appSubscription/mobileApp/@label]),urlUtf8Encode([/tmp/iosMessage/preview/content/iosTitle])) + '&amp;alertTitle=' + urlUtf8Encode([/tmp/rcpQryResult/queryResult/message/custom/appSubscription/mobileApp/@label]) + '&amp;actionLocKey=' + urlUtf8Encode([/tmp/iosMessage/preview/content/iosActionLocKey]) + '&amp;subTitle=' + urlUtf8Encode([/tmp/iosMessage/preview/content/iosSubTitle])"/>
          </container>
        </container>
      </container>
      <!--[cf]-->
<!--[of]:Android-->
      <container name="android">
        <container img="nms:android.png" label="Android" name="androidContentEditor">
          <container colcount="2" label="コンテンツ" maxLabelWidth="80" name="tabContent">

            <container colspan="2">
              <input fullToolbar="true" htmlMode="false" label="メッセージ" name="ctSource"
                     nolabel="false" type="htmlSource" xpath="androidMessage/source"
                     xpathInsert="/ignored/customizeTextContent" xpathUrl="/tmp/urlTree/@toSelect">
                <container>
                  <input menuId="deliveryMenuBuilder" type="customizeBtn" xpath="/ignored/customizeTextContent"/>
                </container>
              </input>
            </container>
      <!-- List with additional notification parameters -->
            <static colspan="2" label="アプリケーション変数" type="separator"/>
            <container type="visibleGroup" visibleIf="[/ignored/@triggerMessage]!=1">
              <input colspan="2" editable="false" hideEditButtons="true" label=" "
                     nolabel="false" type="list" xpath="/tmp/notificationCustomFields/customFieldsItem">
                <input label="キー" readOnly="true" type="edit" xpath="@key"/>
                <input editable="true" label="値" menuId="deliveryMenuBuilder" type="scriptEdit"
                       xpath="@value"/>
              </input>
            </container>
            <container type="visibleGroup" visibleIf="[/ignored/@triggerMessage]=1">
              <input colspan="2" editable="true" label=" " nolabel="false" type="list"
                     xpath="/tmp/notificationCustomFields/customFieldsItem" zoomOnAdd="false">
                <input label="キー" type="edit" xpath="@key"/>
                <input label="値" menuId="deliveryMenuBuilder" type="scriptEdit" xpath="@value"/>
              </input>
            </container>
          </container>
          <container colcount="2" label="プレビュー" name="tabPreview">
            <input colspan="2" name="previewToolbar" type="toolbarCtrl"/>

            <static/>
            <input label="データ読み込み..." nolabel="true" prebuildSubForm="false" type="subFormLink"
                   xpath="/tmp/rcpQryResult">
              <form label="プレビュー用に読み込まれた受信者のデータ">
                <input nolabel="true" readOnly="true" type="SourceEdit" xpath="queryResult"/>
              </form>
            </input>
            <static colspan="2" type="separator"/>
            <container ref="nms:delivery:lib/content/Preview/body" xpath="androidMessage"/>
            <input sessionToken="true" type="urlViewer" urlExpr="$(serverUrl) + '/nms/deliveryPreview.jssp?messageType='+[/delivery/@messageType]+'&amp;alert=' + urlUtf8Encode([/tmp/androidMessage/preview/content/]) +  '&amp;image='+[/tmp/rcpQryResult/queryResult/message/custom/appSubscription/mobileApp/@img] + '&amp;title='+[/tmp/rcpQryResult/queryResult/message/custom/appSubscription/mobileApp/@label]"/>
          </container>
        </container>
      </container>
<!--[cf]-->
  <!--[of]:Replication from ACS-->
      <container colcount="2" label="レプリケートされた配信の共通プロパティ" name="commonReplicatedProperties">
        <input xpath="@label"/>
        <input label="名前" xpath="@internalName"/>
        <container colcount="2" colspan="2" label="指標" type="frame">
          <input label="送信するメッセージ" xpath="properties/@toDeliver"/>
          <input label="送信済み" xpath="indicators/@sent"/>
          <input label="処理済み" xpath="indicators/@processed"/>
          <input label="成功" xpath="indicators/@success"/>
        </container>
        <container colspan="2" img="nms:calendar-large.png" label="スケジュール設定" type="frame">
          <input fontBold="true" label="コンタクト日" xpath="scheduling/@contactDate"/>
        </container>
        <static colspan="2" label="説明" type="separator"/>
        <input colspan="2" nolabel="true" xpath="desc"/>
      </container>
  <!--[cf]-->

    </container>
<!--[cf]-->
<!--[of]:Budget-->
    <container applicableIf="HasPackage('nms:campaign')" colcount="2" label="費用と売上高"
               name="budget" visibleIf="[/ignored/@useBudget]">
      <container colcount="2" colspan="2" img="nms:budget-max.png" label="費用" type="frame">
        <container colcount="4" colspan="2" type="visibleGroup" visibleIf="@isModel=false">
          <container colcount="4" ref="nms:plan:lib/budgetParam"/>
        </container>
        <container colspan="2" type="visibleGroup" visibleIf="@isModel">
          <input createMode="none" noZoom="true" xpath="budget"/>
          <static label=" "/>
        </container>
      </container>
      <container colspan="2" ref="nms:plan:lib/objective" xpath="."/>
    </container>
<!--[cf]-->
<!--[of]:Target-->
    <container name="targetFrame" xpath="mailParameters">
      <input alwaysActive="true" colspan="2" expr="Iif([../targets/@targetMode]&gt;=3, [/ignored/@strPopFromWkf], Iif([../targets/@targetMode]=0, Coalesce([../targets/deliveryTarget/@serialization], [/ignored/@strPopEmpty]), [/ignored/@strPopFromFile]))"
             type="expr" xpath="/tmp/target"/>
      <input discardReadOnly="true" label="宛先" margin-right="5" prebuildSubForm="false"
             type="subFormLink" xpath="..">
        <form label="ターゲットを選択" readOnlyExpr="[/tmp/@readOnly] AND ([/delivery/@FCP]!=1 OR [/delivery/@state]&gt;EVal([/delivery/@state], 'ready'))">
          <container type="notebook">
            <container label="メインターゲット" readOnlyExpr="[/tmp/@readOnly]" xpath="targets">
              <enter>
                <set expr="iif ([/ignored/@socialMessage]!=1 or [../@isModel] or [/ignored/@pushMessage]!=1, 1, 0)"
                     xpath="/ignored/@showMappingChoice"/>
            <!-- Does not allow to import recipient when using Neolane Leads -->
                <if expr="HasPackage('crm:lead')">
                  <set value="true" xpath="@noReconciliation"/>
                </if>
                <if expr="HasPackage('nms:mobileApp')">
                  <copyElement xpathDst="/tmp/mobileAppOld" xpathSrc="/delivery/targets/deliveryTarget/targetPart/where/ctx/tmp/list/mobileApp"/>
                </if>
              </enter>
              <container ref="nms:delivery:lib/mainTarget"/>
            </container>
            <container applicableIf="HasPackage('nms:social')" colcount="2" label="オーディエンス"
                       visibleIf="EV(@messageType,'facebook') and [mapping/@name]=='mapService'">
              <static colspan="2" type="help">オーディエンスを絞り込むには Facebook フィルターを使用します。複数の値を入力するにはコンマを使用します。</static>
              <input label="国 / 地域" lineCount="2" xpath="content/facebookCountries/source"/>
              <static label="例 : US、GB、FR"/>
              <input label="地域" lineCount="2" xpath="content/facebookRegions/source"/>
              <static label="例 : ウィスコンシン州が 55、ロードアイランド州が 44 など"/>
              <input label="市区町村" lineCount="2" xpath="content/facebookCities/source"/>
              <static label="例 : ロンドン (イングランド) の場合 812057、パリ (フランス) の場合 777934"/>
              <input label="言語" lineCount="2" xpath="content/facebookLocales/source"/>
              <static label="例 : フランス語 (フランス) の場合は 9、英語 (米国) の場合は 6、英語 (英国) の場合は 24"/>
            </container>
            <container applicableIf="HasPackage('nms:social')" label="オーディエンス" visibleIf="EV(@messageType,'facebook') and ([mapping/@name]=='mapVisitor' or [mapping/@name]=='mapVisitorSub')">
              <input label="メッセージの表示条件" type="separator"/>
              <input checkedValue="EVERYONE" label="すべてのユーザー" nolabel="true" type="RadioButton"
                     xpath="content/facebookPrivacy/source"/>
              <input checkedValue="ALL_FRIENDS" label="ファンの友達のみ" nolabel="true" type="RadioButton"
                     xpath="content/facebookPrivacy/source"/>
              <input checkedValue="CUSTOM_SELF" label="ファンのみ" nolabel="true" type="RadioButton"
                     xpath="content/facebookPrivacy/source"/>
              <static type="warning">ファンのタイムラインでのメッセージのパブリッシュに関する Facebook 利用条件に同意してください。Adobe ではこの機能の誤用による責任は一切負いかねます。</static>
            </container>
            <container label="配達確認のターゲット">
              <container ref="nms:delivery:lib/proofTarget"/>
            </container>
<!--[of]:Target options-->
            <container label="除外" name="targetOptions" propagateConstraints="false"
                       xpath="targets">
              <enter ref="nms:delivery:lib/overFiltering"/>

              <container label="除外設定" type="frame">
                <input label="編集..." type="subFormLink" xpath=".">
                  <form label="除外設定">
                    <container type="visibleGroup" visibleIf="[../@messageType]!=5">
                      <input nolabel="true" useDesc="true" xpath="@deduplicate"/>
                    </container>
                    <input nolabel="true" useDesc="true" xpath="@useBlackList"/>
                    <container type="visibleGroup" visibleIf="EV([../@messageType],'paper')==false and [../@messageType]!=5">
                      <input nolabel="true" xpath="@useQuarantine"/>
                    </container>
                    <container type="visibleGroup" visibleIf="EV([../@messageType],'paper')">
                      <container colcount="3" enabledIf="[/ignored/postalAddress/@noErrorCount]==false"
                                 type="enabledGroup">
                        <input label="次の回数以上の連続エラーが発生したアドレスを除外" nolabel="true" xpath="@useQuarantine"/>
                        <input nolabel="true" xpath="@maxErrorCount"/>
                      </container>
                      <container type="visibleGroup" visibleIf="[/ignored/postalAddress/@noLastCheck]==false">
                        <input nolabel="true" xpath="@allowUnchecked"/>
                      </container>
                      <container colcount="3" type="visibleGroup" visibleIf="[/ignored/postalAddress/@noQuality]==false">
                        <input label="品質評価が次の値未満のアドレスを除外" nolabel="true" xpath="@useQuality"/>
                        <input nolabel="true" xpath="@qualityRequired"/>
                      </container>
                    </container>

                    <container ref="nms:delivery:lib/deliveryLimitDef" xpath=".."/>

                    <static type="help">送信メッセージ数を制限するために使用されます。送信メッセージ数が多すぎる場合は、いくつかのメッセージが無作為に削除されます。メッセージ数がゼロに等しい場合は、フルターゲティングが使用されます。</static>
                    <container type="visibleGroup" visibleIf="@deduplicate == false and ( EV(@targetMode, 'file')==false or @noReconciliation==false )">
                      <input nolabel="true" xpath="@noRcpIdDedup"/>
                      <static type="help">ターゲットの複数の要素 (リストと購読など) に属する受信者に同じメッセージを複数回送信するために使用されます。</static>
                    </container>
                    <leave ref="nms:delivery:lib/overFiltering"/>
                  </form>
                </input>
                <input fontBold="true" lineCount="3" noBorder="true" nolabel="true"
                       readOnly="true" type="memo" xpath="/ignored/humanFilter"/>
              </container>
              <container ref="nms:delivery:lib/typology" xpath=".."/>
            </container>

<!--[cf]-->
<!--[of]:ControlGroup-->
            <container applicableIf="HasPackage('nms:campaign')" label="コントロール母集団"
                       visibleIf="(@isModel or [@operation-id]!=0) and @FCP=0" xpath="execution/controlGroup">
              <container ref="nms:operation:lib/controlGroup" xpath=".."/>
            </container>
<!--[cf]-->
<!--[of]:SeedMembers-->
            <container label="シードアドレス" visibleIf="@FCP=0 AND [/ignored/@pushMessage]!=1">
              <input img="nms:unknownad.png" label="シードテンプレートをインポート..." prebuildSubForm="false"
                     type="subFormLink" xpath=".">
                <form forceToSaveEntity="true" label="シードアドレスを選択">
                  <container defaultColumns="@label,[custom_nms_recipient/@email],[custom_nms_broadLog/postalAddress/address/serialized]"
                             multiSelection="true" newEntityFormChoice="true" nodeModel="nmsSeedList"
                             schema="nms:seedMember" sharedUserConfig="true" type="navTreeEntityList"
                             xpath="/ignored/seedMember">
                    <sysFilter>
                      <condition expr="@isModel=1"/>
                    </sysFilter>
                  </container>
                  <leave>
                    <soapCall name="getAsModel" noRefresh="true" service="nms:seedMember">
                      <param exprIn="'delivery-id'" type="string"/>
                      <param exprIn="@id" type="int"/>
                      <param exprIn="/tmp/navTreeEntityList/output/nmsSeedList" type="DOMElement"/>
                      <param exprIn="." type="DOMElement"/>
                      <param type="DOMElement" xpathOut="."/>
                    </soapCall>

                    <set value="*" xpath="/tmp/seedMember"/>
                  </leave>
                </form>
              </input>

              <input editable="false" form="nms:seedMember" nolabel="true" prebuildSubForm="false"
                     toolbarAlign="vertical" toolbarCaption="シードアドレスのリスト" type="list"
                     xpath="seedMember" xpathRefresh="/tmp/seedMember" zoom="true"
                     zoomOnAdd="true">
                <input editable="true" xpath="@label"/>
                <input editable="true" xpath="@internalName"/>
              </input>
              <container label="シードアドレステンプレートにおける動的条件" type="frame">
                <input img="nms:miniatures/mini-incremental.png" label="動的条件を編集..."
                       type="subFormLink" xpath="output/seedList">
                  <form label="動的条件">
                    <input nolabel="true" schema="nms:seedMember" toolbarAlign="horizontal"
                           toolbarCaption="フィルター条件" type="conditionList" xpath="where"
                           xpathCurrentLookupPath="/lookupPath/where" xpathHelp="/@helpCond">
                      <input colSize="15" label=" " xpath="/@bool-operator"/>
                      <input colSize="30" label="式" xpath="/@leftExpr"/>
                      <input colSize="15" label="演算子" xpath="/@operator"/>
                      <input colSize="30" label="値" xpath="/@rightExpr"/>
                    </input>
                    <input expr="[/@helpCond]" type="expr" xpath="@humanCond"/>
                  </form>
                </input>
                <container type="visibleGroup" visibleIf="NodeCount([output/seedList/where/condition])&gt;0">
                  <input fontBold="true" noBorder="true" nolabel="true" readOnly="true"
                         type="memo" xpath="output/seedList/@humanCond"/>
                </container>
              </container>

              <container type="visibleGroup" visibleIf="EV(@deliveryMode, 'external')">
                <input xpath="output/seedList/@insertMode"/>
              </container>
            </container>
<!--[cf]-->
          </container>
          <leave>
            <if expr="HasPackage('nms:mobileApp')">
          <!-- Reset additional parameters when the target (application) changes -->
              <copyElement xpathDst="/tmp/mobileAppNew" xpathSrc="/delivery/targets/deliveryTarget/targetPart/where/ctx/tmp/list/mobileApp"/>
              <if expr="NodeExists([/tmp/mobileAppOld])=false OR [/tmp/mobileAppNew/@id]!=[/tmp/mobileAppOld/@id]">
                <reset xpath="/tmp/notificationCustomFields"/>
                <reset xpath="/tmp/notificationSounds"/>
            <!-- ## Proof Vs. target? -->
                <copyElement xpathDst="/tmp/notificationCustomFields" xpathSrc="/delivery/targets/deliveryTarget/targetPart/where/ctx/tmp/list/mobileApp/notificationCustomFields"/>
                <copyElement xpathDst="/tmp/notificationSounds" xpathSrc="/delivery/targets/deliveryTarget/targetPart/where/ctx/tmp/list/mobileApp/notificationSounds"/>
              </if>
              <if expr="NodeExists([/tmp/mobileAppOld])=true">
                <reset xpath="/tmp/mobileAppOld"/>
              </if>
              <reset xpath="/tmp/mobileAppNew"/>
            </if>
          </leave>
        </form>
      </input>
    </container>
<!--[cf]-->
<!--[of]:Segment-->
    <container name="segment">
      <input colspan="2" nolabel="true" useDesc="true" xpath="@exclusion"/>
      <container colcount="2" colspan="2" type="visibleGroup" visibleIf="FieldExists([../../../mapping/storage/@broadLogSchema], '@segmentCode') and @exclusion == false">
        <container colcount="2" colspan="2" label="セグメントコード" type="frame">
          <input label="タイプ" xpath="@segmentCodeType"/>
          <container type="visibleGroup" visibleIf="EV(@segmentCodeType, 'calculated')==false">
            <container enabledIf="EV(@segmentCodeType, 'constant')" type="enabledGroup">
              <input nolabel="true" xpath="@segmentCodeVal"/>
            </container>
          </container>
          <container type="visibleGroup" visibleIf="EV(@segmentCodeType, 'calculated')">
            <input nolabel="true" type="pathEdit" xpath="segmentCodeExpr" xpathSchema="../../../mapping/@schema"/>
          </container>
        </container>
      </container>
    </container>
<!--[cf]-->
<!--[of]:typology-->
    <container name="typology">
      <static label="フィルタールール" type="separator"/>
      <container type="visibleGroup" visibleIf="NodeCount(typologyFilter)=0 and NodeCount(ruleFilter)=0 and [/ignored/@addFilterRule]!=1">
        <input img="xtk:filter.png" label="フィルタールールを追加" type="urlButton">
          <enter>
            <set value="1" xpath="/ignored/@addFilterRule"/>
          </enter>
        </input>
      </container>
      <container type="visibleGroup" visibleIf="NodeCount(typologyFilter)&gt;0 or NodeCount(ruleFilter)&gt;0 or [/ignored/@addFilterRule]=1">
        <input colspan="2" img="nms:typofolder.png" nolabel="true" toolbarCaption="フィルタータイポロジ"
               type="list" xpath="typologyFilter" xpathChoiceTarget="typology">
          <input createMode="none" fullLoad="true" xpath="typology">
            <sysFilter>
              <condition expr="@type=1"/>
            </sysFilter>
          </input>
        </input>

        <input colspan="2" img="nms:typorule.png" nolabel="true" toolbarCaption="フィルタールール"
               type="list" xpath="ruleFilter" xpathChoiceTarget="rule">
          <input createMode="none" fullLoad="true" xpath="rule">
            <sysFilter>
              <condition expr="@active=1"/>
              <condition expr="@ruleType='sql'"/>
              <condition>
                <condition boolOperator="OR" enabledIf="$(../@messageType)!=''" expr="@messageType=$(../@messageType)"/>
                <condition expr="@messageType=127"/>
              </condition>
            </sysFilter>
          </input>
        </input>
      </container>
    </container>

<!--[cf]-->
<!--[of]:deliveryLimitDef-->
    <container name="deliveryLimitDef">
      <container colcount="2" type="visibleGroup" visibleIf="EV(@deliveryMode, 'external')=false or [/ignored/@limitEdition]!=false">
        <container type="visibleGroup" visibleIf="[/tmp/@hasDeliveryLimitExpr] = false">
          <input label="配信数上限" xpath="targets/@deliveryLimit"/>
        </container>

        <container applicableIf="HasPackage('nms:campaign')" type="visibleGroup"
                   visibleIf="[/tmp/@hasDeliveryLimitExpr] = true">
          <container readOnlyIf="@state &gt;= Eval(@state, 'targetReady')" type="readOnlyGroup">
            <input label="配信数上限" nolabel="false" schema="nms:delivery" type="pathEdit"
                   xpath="targets/@deliveryLimitExpr"/>
          </container>
        </container>
        <static>メッセージ</static>
      </container>

      <container type="visibleGroup" visibleIf="EV(@deliveryMode, 'external') and [/ignored/@limitEdition]=false">
        <container type="visibleGroup" visibleIf="[/tmp/@hasDeliveryLimitExpr] = false">
          <input label="希望数量" xpath="targets/@deliveryLimit"/>
        </container>

        <container applicableIf="HasPackage('nms:campaign')" type="visibleGroup"
                   visibleIf="[/tmp/@hasDeliveryLimitExpr] = true">
          <container readOnlyIf="@state &gt;= Eval(@state, 'targetReady')" type="readOnlyGroup">
            <input label="希望数量" nolabel="false" schema="nms:delivery" type="pathEdit"
                   xpath="targets/@deliveryLimitExpr"/>
          </container>
        </container>
      </container>

      <container applicableIf="HasPackage('nms:campaign')" type="visibleGroup" visibleIf="[@operation-id]!=0 and [/ignored/tmp/@workflowId]!=0 and [/ignored/tmp/@workflowId]!=''">
        <container readOnlyIf="@state &gt;= Eval(@state, 'targetReady')" type="readOnlyGroup">
          <input label="計算式を使用" type="checkBox" xpath="/tmp/@hasDeliveryLimitExpr"/>
        </container>
      </container>
    </container>
<!--[cf]-->
<!--[of]:contactDateDef-->
    <container name="contactDateDef">
      <container type="visibleGroup" visibleIf="@isModel=false and EV(@deliveryMode, 'external')=false or [/ignored/@limitEdition]!=false">
        <input xpath="scheduling/@contactDate" xpathTimeZone="scheduling/@contactDateTimeZone"/>
      </container>
      <container type="visibleGroup" visibleIf="@isModel=false and EV(@deliveryMode, 'external') and [/ignored/@limitEdition]=false">
        <input discardReadOnly="true" xpath="scheduling/@contactDate"/>
      </container>
    </container>
<!--[cf]-->
<!--[of]:extractionDateDef-->
    <container name="extractionDateDef">
      <container type="visibleGroup" visibleIf="@isModel=false and [@operation-id]!=0 and (EV(@deliveryMode, 'external')=false or [/ignored/@limitEdition]!=false)">
        <input xpath="scheduling/@extraction"/>
      </container>
      <container type="visibleGroup" visibleIf="@isModel=false and [@operation-id]!=0 and (EV(@deliveryMode, 'external') and [/ignored/@limitEdition]=false)">
        <container type="visibleGroup" visibleIf="@state &lt;= EVal(@state, 'ready') or EV([validation/@sandboxMode], 'complete')=false">
          <input xpath="scheduling/@extraction"/>
        </container>

        <container type="visibleGroup" visibleIf="@state &gt; EVal(@state, 'ready') and EV([validation/@sandboxMode], 'complete')">
          <input readOnly="true" xpath="scheduling/@extracted"/>
        </container>
      </container>
    </container>
<!--[cf]-->
<!--[of]:dateSchedulingDef-->
    <container name="dateSchedulingDef">

      <container type="visibleGroup" visibleIf="[/tmp/@hasDateExpr] = false">
        <container applicableIf="HasPackage('nms:campaign')" ref="nms:delivery:lib/extractionDateDef"/>
        <container ref="nms:delivery:lib/contactDateDef"/>
      </container>
      <container colcount="2" colspan="2" type="visibleGroup" visibleIf="[/tmp/@hasDateExpr] = true">
    <!-- Extraction date and extraction date expression -->
        <container applicableIf="HasPackage('nms:campaign')" colcount="2" colspan="2"
                   type="visibleGroup" visibleIf="[@operation-id]!=0">

          <container ref="nms:delivery:lib/extractionDateDef"/>

          <container type="visibleGroup" visibleIf="[/tmp/@hasDateExpr] = true">
            <container readOnlyIf="@state &gt;= Eval(@state, 'targetReady')" type="readOnlyGroup">
              <input label="抽出の計算" nolabel="false" schema="nms:delivery" type="pathEdit"
                     xpath="scheduling/@extractionExpr"/>
            </container>
          </container>
        </container>

    <!-- Contact date and contact date expression -->
        <container colcount="2" colspan="2">

          <container ref="nms:delivery:lib/contactDateDef"/>

          <container applicableIf="HasPackage('nms:campaign')" type="visibleGroup"
                     visibleIf="[/tmp/@hasDateExpr] = true">
            <container readOnlyIf="@state &gt;= Eval(@state, 'targetReady')" type="readOnlyGroup">
              <input label="コンタクト日の計算" nolabel="false" schema="nms:delivery" type="pathEdit"
                     xpath="scheduling/@contactDateExpr"/>
            </container>
          </container>
        </container>
      </container>

      <container applicableIf="HasPackage('nms:campaign')" type="visibleGroup" visibleIf="[@operation-id]!=0 and [/ignored/tmp/@workflowId]!=0 and [/ignored/tmp/@workflowId]!=''">
        <container readOnlyIf="@state &gt;= Eval(@state, 'targetReady')" type="readOnlyGroup">
          <input label="計算式を使用" type="checkBox" xpath="/tmp/@hasDateExpr"/>
        </container>
      </container>

      <container applicableIf="HasPackage('nms:campaign')" type="visibleGroup" visibleIf="[@operation-id]!=0 and (@state &lt;= EVal(@state, 'ready') or EV([validation/@sandboxMode], 'complete')=false)">
    <!-- extraction date helper -->
        <static label="抽出日に、ターゲットおよびパーソナライゼーションデータが設定されます。\nデフォルトで、抽出は配信の承認後に実行されます。"
                type="help"/>
        <container type="visibleGroup" visibleIf="hasPackage('nms:campaignOptimization')">
          <static label="営業頻度はターゲットの作成時から抽出時まで影響します。営業頻度ではコンタクト日が考慮されます。" type="help"/>
        </container>
      </container>

  <!-- delay extraction -->
      <container applicableIf="HasPackage('nms:centralLocal')" type="visibleGroup"
                 visibleIf="EV([operation/centralLocal/@centralLocalType], 'mutualized') and EV([operation/centralLocal/@sharedMode], 'localizedWeb', 'localizedOperation')">
        <input xpath="scheduling/@delayExtraction"/>
        <static type="help">抽出を強制的に実行するまでの最大待機期間。考慮されるのは、ターゲットが計算された子キャンペーンのみです。期限が 0 に等しい場合は、子キャンペーンの準備が整った場合にのみ抽出が実行されます。</static>
      </container>

      <input xpath="scheduling/@contactDateTimeZone"/>
    </container>
<!--[cf]-->
<!--[of]:overFiltering-->
    <enter name="overFiltering">
      <set value="" xpath="/ignored/humanFilter"/>

      <if expr="@deduplicate and [../@messageType] != 5">
        <set translatedExpr="'重複したアドレスを除外します。'" xpath="/ignored/humanFilter"/>
      </if>

      <if expr="@useBlackList">
        <set translatedExpr="[/ignored/humanFilter]+'連絡を希望しない受信者を除外します。 '" xpath="/ignored/humanFilter"/>
      </if>

      <if expr="@useQuarantine and EV([../@messageType],'paper')==false and [../@messageType]!=5">
        <set translatedExpr="[/ignored/humanFilter]+'強制隔離された受信者を除外します。 '" xpath="/ignored/humanFilter"/>
      </if>

      <if expr="@useQuarantine and EV([../@messageType],'paper')==true and [/ignored/postalAddress/@noErrorCount]==false">
        <set translatedExpr="[/ignored/humanFilter]+'' + @maxErrorCount + ' 回以上の連続エラーが発生したアドレスを除外します。'"
             xpath="/ignored/humanFilter"/>
      </if>

      <if expr="@allowUnchecked and EV([../@messageType],'paper')==true and [/ignored/postalAddress/@noLastCheck]==false">
        <set translatedExpr="[/ignored/humanFilter]+'承認済みの不適格なアドレスです。'" xpath="/ignored/humanFilter"/>
      </if>

      <if expr="@useQuality and EV([../@messageType],'paper')==true and [/ignored/postalAddress/@noQuality]==false">
        <set translatedExpr="[/ignored/humanFilter]+'品質指標が ' + @qualityRequired + ' 未満のアドレスを除外します。'"
             xpath="/ignored/humanFilter"/>
      </if>
      <if expr="@useDeliveryLimit">
        <set translatedExpr="[/ignored/humanFilter]+'配信を '+@deliveryLimit + ' に制限します。'"
             xpath="/ignored/humanFilter"/>
      </if>
      <if expr="@deduplicate == false and ( EV(@targetMode, 'file')==false or @noReconciliation==false ) and @noRcpIdDedup">
        <set translatedExpr="[/ignored/humanFilter]+'2 回ターゲティングされたレコード (同じ識別子) を保存します。'"
             xpath="/ignored/humanFilter"/>
      </if>
    </enter>
<!--[cf]-->
<!--[of]:prepareDelivery-->
    <container name="prepareDelivery">
      <container name="submit" prepareRights="deliveryPrepare" type="deliverySubmitContainer"
                 validateRights="deliveryValidate" xpathCurProgress="properties/progress/@current"
                 xpathMaxProgress="properties/progress/@max" xpathMethodName="/ignored/@methodeName"
                 xpathStatus="@status">
        <container type="visibleGroup" visibleIf="[/ignored/@start] and [/ignored/@showTarget]=false">
          <input name="JobLogsList" type="JobLogList"/>
        </container>
        <container colcount="2" type="visibleGroup" visibleIf="[/ignored/@start] and EV([properties/@deliveryState], 'startPending', 'started', 'finished')=false">
          <value dataType="timespan" label="所要時間" xpath="/tmp/execution/@elapsed"/>
          <value dataType="timespan" label="推定残り時間" xpath="/tmp/execution/@remaining"/>
        </container>

        <container colcount="4" type="visibleGroup" visibleIf="EV([properties/@deliveryState], 'startPending', 'started', 'finished')=false">
          <value name="JobProgressBar" type="ProgressBar" valign="center" xpathCur="properties/progress/@current"
                 xpathElapsed="/tmp/execution/@elapsed" xpathMax="properties/progress/@max"
                 xpathRemaining="/tmp/execution/@remaining"/>
          <input img="xtk:runtask.png" label="分析(&amp;A)" name="JobSubmitButton"
                 type="flatbutton">
            <enter>
              <if expr="[/ignored/@actionMode]=1">
                <check expr="[scheduling/@contactDate]!='' and [scheduling/@contactDate]&gt;GetDate()">
                  <error>有効なコンタクト日を入力してください。</error>
                </check>
                <set value="1" xpath="scheduling/@delayed"/>
              </if>
              <set value="nms:delivery" xpath="/ignored/ServerSideState/@schema"/>
              <set value="getIfExists" xpath="/ignored/ServerSideState/@operation"/>
              <set value="@state" xpath="/ignored/ServerSideState/select/node[1]/@expr"/>
              <set expr="'@id=' + @id" xpath="/ignored/ServerSideState/where/condition/@expr"/>
              <soapCall name="ExecuteQuery" service="xtk:queryDef">
                <param exprIn="[/ignored/ServerSideState]" type="DOMDocument"/>
                <param type="DOMDocument" xpathOut="/tmp/ServerSideState"/>
              </soapCall>
              <check expr="[/tmp/ServerSideState/@state]='' OR [/tmp/ServerSideState/@state]=@state">
                <error>分析済みまたは開始中の配信 : この画面を一度閉じてから再度開いて、データを更新してください。</error>
              </check>
              <if expr="@deliveryMode &gt; 0 and [scheduling/@contactDate]&lt;GetDate() and @launchFCP==0">
                <set expr="GetDate()" xpath="scheduling/@contactDate"/>
              </if>
              <if expr="[scenario/@setDirectDates]=0 and [scheduling/@contactDate]!=''">
                <set expr="DateAdd([scheduling/@contactDate], [scenario/@validityDuration])"
                     xpath="scheduling/@validityDate"/>
              </if>

              <set value="true" xpath="/ignored/@start"/>
              <set value="true" xpath="/ignored/@analyzed"/>
              <set value="false" xpath="/ignored/@showTarget"/>
              <set value="nl:arrow_ntf_orange.png" xpath="/ignored/@img"/>

              <if expr="@launchFCP=1 and [/ignored/@deliveryState]!='' and [/ignored/@deliveryState]!=@state">
                <set expr="[/ignored/@deliveryState]" xpath="@state"/>
                <set expr="[/ignored/@deliveryState]" xpath="properties/@deliveryState"/>
              </if>

              <if expr="[/ignored/@_isNewEntity]">
                <set value="insertOrUpdate" xpath="@_operation"/>
              </if>

              <if expr="HasPackage('nms:campaign') and [/ignored/@operationId] and [/ignored/tmp/@workflowId]=0 and @launchFCP=0">
                <set expr="Eval(@targetStatus, 'edition')" xpath="@targetStatus"/>
                <set expr="Eval(@budgetStatus, 'edition')" xpath="@budgetStatus"/>
                <set expr="Eval(@extractionStatus, 'edition')" xpath="@extractionStatus"/>
                <set expr="Eval(@sandboxStatus, 'edition')" xpath="@sandboxStatus"/>
              </if>

            <!-- Apply type of preparation from selected action -->
              <if expr="(@launchFCP=1 or @launchFCP=3) or ([/ignored/@actionMode]!=2 and [/ignored/@useTargetValidation]=false)">
                <set value="Prepare" xpath="/ignored/@methodeName"/>
              </if>
              <if expr="@launchFCP=0 and ([/ignored/@actionMode]=2 or [/ignored/@useTargetValidation])">
                <set value="PrepareTarget" xpath="/ignored/@methodeName"/>
              </if>

              <set expr="[targets/deliveryTarget/@serialization]" xpath="/ignored/deliveryTargetSerialization"/>
              <set expr="[targets/proofTarget/@serialization]" xpath="/ignored/proofTargetSerialization"/>

            <!-- Save content of notificationCustomFields in the delivery before analyzing -->
              <if expr="HasPackage('nms:mobileApp')">
                <copyElement exprDst="'/delivery/content/' + Iif(@messageType=41, 'ios', 'android') + 'CustomFields/source'"
                             xpathSrc="/tmp/notificationCustomFields"/>
                <copyElement exprDst="'/delivery/content/' + Iif(@messageType=41, 'ios', 'android') + 'AvailableSounds/source'"
                             xpathSrc="/tmp/notificationSounds"/>
              </if>
              <reset xpath="/delivery/offerSpace"/>
              <if expr="[/ignored/offerSpace/@id] != '' and [/ignored/offerSpace/@id] != 0">
                <set expr="[/ignored/offerSpace/@id]" xpath="/delivery/offerSpace/@id"/>
                <set expr="[/ignored/offerSpace/@_cs]" xpath="/delivery/offerSpace/@_cs"/>
                <set expr="[/ignored/offerSpace/env/@id]" xpath="/delivery/offerSpace/env/@id"/>
                <set expr="[/ignored/offerSpace/env/@propositionSchema]" xpath="/delivery/offerSpace/env/@propositionSchema"/>
              </if>
            <!--modified for Line multi-message-->
              <if expr="HasPackage('nms:lineV2')">
                <copyElement exprDst="'/delivery/content/lineCustomFields/source'"
                             xpathSrc="/tmp/lineCustomFields"/>
              </if>

            </enter>
          </input>

        <!-- Used to check if target has changed since last analysis -->
          <input expr="(@launchFCP=0 and [/ignored/deliveryTargetSerialization]!='' and [/ignored/deliveryTargetSerialization]!=[targets/deliveryTarget/@serialization]) or                                  (@launchFCP=1 and [/ignored/proofTargetSerialization]!='' and [/ignored/proofTargetSerialization]!=[targets/proofTarget/@serialization])"
                 type="expr" xpath="/ignored/@isTargetModified"/>

          <container type="visibleGroup" visibleIf="![/ignored/@isTargetModified] and (([/ignored/@actionMode]!=2 and [/ignored/@useTargetValidation]=false and EV(@state, 'edition', 'targetPrepPending', 'targetReady', 'ready', 'preparationError') and [/ignored/@hasDeliveryContent]) or @launchFCP=1) and @launchFCP!=3">
            <input img="xtk:play.png" label="配信を確定(&amp;C)" name="DeliveryPlayButton"
                   type="flatbutton">
              <enter>
                <if expr="[/ignored/@actionMode]=0 and @launchFCP=0">
                  <set expr="GetDate()" xpath="scheduling/@contactDate"/>
                  <set value="0" xpath="scheduling/@delayed"/>
                </if>
                <if expr="[/ignored/@actionMode]=1">
                  <check expr="[scheduling/@contactDate]!='' and [scheduling/@contactDate]&gt;GetDate()">
                    <error>有効なコンタクト日を入力してください。</error>
                  </check>
                  <set value="1" xpath="scheduling/@delayed"/>
                </if>

                <set value="true" xpath="/ignored/@start"/>
                <set value="false" xpath="/ignored/@showTarget"/>
                <set value="nl:arrow_ntf_orange.png" xpath="/ignored/@img"/>
                <if expr="[/ignored/@_isNewEntity]">
                  <set value="insertOrUpdate" xpath="@_operation"/>
                </if>
              </enter>
            </input>
          </container>
          <container type="visibleGroup" visibleIf="![/ignored/@isTargetModified] and [/ignored/@targetStatus]=0 AND [properties/@deliveryState] &gt;= EVal([properties/@deliveryState], 'targetReady') and EV([properties/@deliveryState], 'preparationError')=false and HasPackage('nms:campaign') and @launchFCP=0 and [/ignored/@useTargetValidation]">
            <input img="nms:validation.png" label="ターゲットを承認用に送信(&amp;S)" promptLabel="ターゲットの承認の送信を確認してください"
                   type="flatbutton">
              <enter>
                <set value="false" xpath="/ignored/@showTarget"/>
                <set value="nl:arrow_ntf_orange.png" xpath="/ignored/@img"/>

              <!-- just here to change the enabling of submit target button -->
                <set expr="Eval(@targetStatus, 'inWaiting')" xpath="@targetStatus"/>

                <set value="nms:delivery" xpath="/ignored/writer/delivery/@xtkschema"/>
                <set value="update" xpath="/ignored/writer/delivery/@_operation"/>
                <set expr="@id" xpath="/ignored/writer/delivery/@id"/>
                <set expr="Eval(@targetStatus, 'edition')" xpath="/ignored/writer/delivery/@targetStatus"/>

                <set expr="Eval(@budgetStatus, 'edition')" xpath="/ignored/writer/delivery/@budgetStatus"/>
                <if expr="[validation/@useBudgetValidation] and [@budget-id]!=0">
                  <set expr="Eval(@budgetStatus, 'inWaiting')" xpath="/ignored/writer/delivery/@budgetStatus"/>
                </if>
                <set expr="Eval(@extractionStatus, 'edition')" xpath="/ignored/writer/delivery/@extractionStatus"/>
                <set expr="Eval(@sandboxStatus, 'edition')" xpath="/ignored/writer/delivery/@sandboxStatus"/>
                <if expr="[validation/@sandboxMode]=1">
                  <set expr="Eval(@sandboxStatus, 'inWaiting')" xpath="/ignored/writer/delivery/@sandboxStatus"/>
                </if>

                <soapCall name="Write" service="xtk:persist">
                  <param exprIn="[/ignored/writer/delivery]" type="DOMDocument"/>
                </soapCall>

                <soapCall name="DeliveryValidation" service="nms:operation">
                  <param exprIn="@id" type="int"/>
                  <param exprIn="10" type="byte"/>
                  <param exprIn="0" type="boolean"/>
                  <param exprIn="[/tmp/comment]" type="string"/>
                </soapCall>
              </enter>
            </input>
          </container>
        </container>
      </container>
    </container>
<!--[cf]-->

  </container>
<!--[cf]-->
<!--[of]:Iconbox-->
  <container ref="xtk:import:general/warningBuiltIn"/>

  <container applicableIf="HasPackage('nms:messageCenter')" colcount="2" type="visibleGroup"
             visibleIf="@isModel=false and [/ignored/@triggerMessage]=1">
    <input xpath="@label"/>
    <input xpath="@internalName"/>
  </container>

  <container colcount="2" type="visibleGroup" visibleIf="@isModel">
    <input xpath="@label"/>
    <input xpath="@internalName"/>

  <!-- Copy deliveryMode and message type of the selected delivery provider
       (Note: if the @type of the provider is 0, it means nothing has been
        selected in the linkedit (the deliveryProvider is the default one).
        We must let default messageType and deliveryMode values)
    -->
    <input alwaysActive="1" expr="Iif(@isModel and NodeExists([deliveryProvider/@messageType]), [deliveryProvider/@messageType], @messageType)"
           type="expr" xpath="@messageType"/>
    <input alwaysActive="1" expr="Iif(@isModel and NodeExists([deliveryProvider/@deliveryMode]), [deliveryProvider/@deliveryMode], @deliveryMode)"
           type="expr" xpath="@deliveryMode"/>
  </container>

  <container name="edit" showIconsIf="EV(@deliveryMode, 'descriptive') or (EV(@state, 'edition')=false and [/ignored/@limitEdition]=false)"
             type="iconbox">
<!--[of]:Summary-->
    <container img="xtk:form.png" label="概要" name="summary" visibleIf="@state &gt; 0 and [/ignored/@limitEdition]=false and [/ignored/@isACSConnector]==false">
      <container ref="nms:delivery:lib/summary"/>
    </container>
<!--[cf]-->
<!--[of]:Generic (file generation)-->
    <container img="nms:miniatures/mini-delivery.png" label="ファイル" name="fileDefinition"
               visibleIf="EV(@deliveryMode, 'external')" xpathEnum="@messageType">
      <container label="レプリケートされたファイル定義プロパティ" name="replicatedFileProperties" readOnly="true"
                 type="visibleGroup" visibleIf="[/ignored/@isACSConnector]">
        <container ref="nms:delivery:lib/content/commonReplicatedProperties"/>
      </container>
      <container label="ファイル定義プロパティ" name="fileProperties" type="visibleGroup" visibleIf="[/ignored/@isACSConnector]==false">
        <container type="visibleGroup" visibleIf="[/ignored/@limitEdition]=false and [/ignored/@triggerMessage]!='1'">
          <container colcount="2" label="配信ターゲット母集団" name="headers" type="frame">
            <container ref="nms:delivery:lib/targetFrame"/>
            <input alwaysActive="true" lineCount="2" noBorder="true" nolabel="true"
                   readOnly="true" type="memo" xpath="/tmp/target"/>
          </container>
        </container>

  <!--[of]:Delivery not in operation-->
        <container type="visibleGroup" visibleIf="![/ignored/@operationId]">
          <container type="notebook">
            <container colcount="2" label="抽出" xpath="output">
              <input colspan="2" useDesc="true" xpath="@downloadDestFile"/>
              <container colspan="2" type="visibleGroup" visibleIf="@downloadDestFile">
                <input defExt="txt" filters="テキストファイル (*.txt;*.tab)|*.txt;*.tab|CSV ファイル (*.csv)|*.csv|XML ファイル (*.xml)|*.xml|すべて (*.*)|*.*|"
                       label="ローカルファイル" required="true" type="saveFileEdit" xpath="@fileName"/>
              </container>
              <container colcount="2" colspan="2" type="visibleGroup" visibleIf="@downloadDestFile = 'false'">
                <input label="ファイル" menuId="deliveryMenuBuilder" type="scriptEdit"
                       xpath="outputScript"/>
                <static label="抽出するファイル名の計算スクリプト。" type="help"/>
              </container>
              <container colspan="2" ref="nms:delivery:lib/extractionDef" xpath="."/>
              <container colspan="2" type="visibleGroup" visibleIf="EV([../@deliveryMode], 'external')">
                <input xpath="../scheduling/@contactDate"/>
              </container>
              <input colspan="2" label="希望数量" xpath="../targets/@deliveryLimit"/>
            </container>

            <container label="プレビュー">
              <input name="outputPreviewToolbar" type="toolbarCtrl"/>
              <static type="separator"/>
              <input nolabel="true" refForForms="nms:delivery:lib/content/HTML/htmlContentEditor/notebook/tabPreview/body/ctPreview"
                     toolbarName="outputPreviewToolbar" type="outputPreview" xpath="output"
                     xpathRcpQuery="/tmp/rcpQryResult/queryResult" xpathSelection="/ignored/selectPart/rcpList"
                     xpathTargets="/delivery/targets"/>
            </container>
          </container>

        </container>
  <!--[cf]-->

  <!--[of]:Delivery inside an operation-->
        <container applicableIf="HasPackage('nms:campaign')" type="visibleGroup"
                   visibleIf="[@operation-id]!=0">
          <container type="visibleGroup" visibleIf="[@linkedDelivery-id]!=0">
            <container colspan="2" label="メインの配信" type="frame">
              <input colspan="2" label="配信" readOnly="true" xpath="linkedDelivery"/>
              <static label="ファイルの抽出はメインの配信から実行されます。" type="help"/>
            </container>
            <container colcount="2" label="抽出" type="frame">
              <container colcount="2" colspan="2" ref="nms:delivery:lib/extraction"/>
            </container>
          </container>

          <container colcount="2" type="visibleGroup" visibleIf="[@linkedDelivery-id]=0">
            <container colspan="2" type="visibleGroup" visibleIf="EV(@deliveryMode, 'external') and [/ignored/@limitEdition]=false">
              <static img="xtk:scheduledtasks.png" label="スケジュール" type="separator"/>
              <container ref="nms:delivery:lib/dateSchedulingDef"/>
            </container>

            <container colspan="2" ref="nms:delivery:lib/supplier"/>
            <container colspan="2" type="notebook">
              <container colcount="2" colspan="2" label="抽出">
                <container colcount="2" colspan="2" type="visibleGroup" visibleIf="@state &gt;= 25">
                  <input label="出力ファイル" readOnly="true" xpath="/ignored/@outputFile"/>
                  <static label="サーバー上のファイルの場所。" type="help"/>
                </container>
                <container colcount="2" colspan="2" type="visibleGroup" visibleIf="@state &lt; 25 or EV(@state, 'preparationError')">
                  <input label="ファイル" menuId="deliveryMenuBuilder" type="scriptEdit"
                         xpath="output/outputScript"/>
                  <static label="抽出するファイル名の計算スクリプト。" type="help"/>
                </container>
                <container ref="nms:delivery:lib/extractionDef" xpath="output"/>
                <container applicableIf="HasPackage('nms:centralLocal')" type="visibleGroup"
                           visibleIf="EV([operation/centralLocal/@sharedMode], 'localizedOperation') and [@linkedDelivery-id]=0 and [operation/@linkedOperation-id]=0">
                  <input nolabel="true" xpath="output/@enableLinkDelivery"/>
                </container>
                <container applicableIf="HasPackage('nms:centralLocal')" type="visibleGroup"
                           visibleIf="EV([operation/centralLocal/@sharedMode], 'localizedOperation')=false or [@linkedDelivery-id]!=0 or [operation/@linkedOperation-id]!=0">
                  <static/>
                </container>
                <container type="visibleGroup" visibleIf="HasPackage('nms:centralLocal')=false">
                  <static/>
                </container>
                <container colcount="2" colspan="2" ref="nms:delivery:lib/extraction"/>
              </container>
              <container label="プレビュー">
                <input name="outputPreviewToolbar" type="toolbarCtrl"/>
                <static type="separator"/>
                <input nolabel="true" refForForms="nms:delivery:lib/content/HTML/htmlContentEditor/notebook/tabPreview/body/ctPreview"
                       toolbarName="outputPreviewToolbar" type="outputPreview" xpath="output"
                       xpathRcpQuery="/tmp/rcpQryResult/queryResult" xpathSelection="/ignored/selectPart/rcpList"
                       xpathTargets="/delivery/targets"/>
              </container>
            </container>
          </container>
        </container>
  <!--[cf]-->
      </container>
    </container>
<!--[cf]-->
<!--[of]:Email-->
    <container img="nms:campaign.png" label="E メール" name="emailDefinition" visibleIf="EV(@messageType, 'mail') and @deliveryMode!=0">
      <container label="レプリケートされた E メール配信プロパティ" name="replicatedEmailProperties"
                 readOnly="true" type="visibleGroup" visibleIf="[/ignored/@isACSConnector]">
        <container ref="nms:delivery:lib/content/commonReplicatedProperties"/>
      </container>
      <container label="E メールのプロパティ" name="emailProperties" type="visibleGroup" visibleIf="[/ignored/@isACSConnector]==false">
        <container collection="/delivery/attachment" form="nms:uploadAttachment"
                   label="E メールにファイル {1} を添付しますか？" type="fileDropZone">
          <enter name="onClick">
            <set expr="[/tmp/@uploadFile]" xpath="name"/>
            <set value="normal" xpath="@type"/>
          </enter>

          <input alwaysActive="true" expr="iif([mailParameters/senderName]!='', [mailParameters/senderName]+' &lt;'+[mailParameters/senderAddress]+'&gt;', '&lt;'+[mailParameters/senderAddress]+'&gt;')"
                 type="expr" xpath="/tmp/@sender"/>

          <container applicableIf="HasPackage('nms:campaign')" type="visibleGroup"
                     visibleIf="[@linkedDelivery-id]!=0 and [@workflow-id]!=0">
            <container colcount="2" label="配信ターゲット母集団" name="headers" type="frame">
              <container ref="nms:delivery:lib/targetFrame"/>
              <input alwaysActive="true" lineCount="2" noBorder="true" nolabel="true"
                     readOnly="true" type="memo" xpath="/tmp/target"/>
            </container>
            <container label="メインの配信" type="frame">
              <input label="配信" readOnly="true" xpath="linkedDelivery"/>
              <static label="E メールのコンテンツはメイン配信から作成されます。" type="help"/>
              <static label="プレビュー" type="separator"/>
              <container type="visibleGroup" visibleIf="EV(@deliveryMode, 'external')==false"
                         xpath="linkedDelivery">
                <container type="notebook">
                  <container img="xtk:html.png" label="HTML コンテンツ" name="htmlContent"
                             visibleIf="EV(@messageType, 'mail')" xpath="content/html/source">
                    <container ref="nms:delivery:lib/content/HTML/htmlContentEditor/notebook/tabPreview"/>
                  </container>
                  <container img="xtk:textfile.png" label="テキストコンテンツ" name="textContent"
                             visibleIf="EV(@messageType, 'mail')" xpath="content/text/source">
                    <container ref="nms:delivery:lib/content/Text/textContentEditor/notebook/tabPreview"/>
                  </container>
                </container>
              </container>
            </container>
          </container>

          <container type="visibleGroup" visibleIf="[/ignored/@hasParentDelivery]!=1">
            <container colcount="2" label="E メールパラメーター" name="headers" type="frame"
                       xpath="mailParameters">
              <container colcount="2" colspan="2" type="visibleGroup" visibleIf="[/tmp/urlTree/@display]!=true and [/tmp/htmlDiagnostics/@display]!=true and [/ignored/@limitEdition]=false">
                <input label="送信者" margin-right="5" prebuildSubForm="false" type="subFormLink"
                       xpath=".">
                  <form label="E メールヘッダーのパラメーター" maxLabelWidth="200">
                    <static type="help">空の値は、デプロイメントウィザードで設定したデフォルト\n
              プラットフォームのパラメーターに置き換えられます。</static>
                    <input img="nms:sendemail.png" menuId="deliveryMenuBuilder" type="scriptEdit"
                           xpath="senderAddress"/>
                    <input menuId="deliveryMenuBuilder" type="scriptEdit" xpath="senderName"/>
                    <input img="nms:sendemail.png" menuId="deliveryMenuBuilder" type="scriptEdit"
                           xpath="replyAddress"/>
                    <input menuId="deliveryMenuBuilder" type="scriptEdit" xpath="replyName"/>
                    <input expr="IIf(replyAddress=='' and senderAddress!='', senderAddress, replyAddress)"
                           type="expr" xpath="replyAddress"/>
                  </form>
                </input>
                <input nolabel="true" readOnly="true" xpath="/tmp/@sender"/>

                <container colcount="2" colspan="2" type="visibleGroup" visibleIf="[/ignored/@triggerMessage]!=1">
                  <container ref="nms:delivery:lib/targetFrame" xpath=".."/>
                  <input alwaysActive="true" lineCount="2" noBorder="true" nolabel="true"
                         readOnly="true" type="memo" xpath="/tmp/target"/>
                </container>

                <input alwaysActive="true" expr="GroupConcat([/delivery/attachment], &quot; '[' + [@label] + ']' &quot; )"
                       type="expr" xpath="/tmp/attachment"/>
                <input expr="NodeCount([/delivery/attachment])&gt;0" type="expr"
                       xpath="../@hasAttachments"/>
                <input label="添付ファイル" margin-right="5" prebuildSubForm="false" type="subFormLink"
                       xpath="..">
                  <form desc="E メールに含める添付ファイルを指定してください。" label="添付ファイルを編集" title="添付ファイル"
                        xpath=".">
                    <container collection="/delivery/attachment" form="nms:uploadAttachment"
                               label="E メールにファイル {1} を添付しますか？" type="fileDropZone">
                      <enter name="onClick">
                        <set expr="[/tmp/@uploadFile]" xpath="name"/>
                        <set value="normal" xpath="@type"/>
                      </enter>
                      <input delButton="true" editable="false" form="nms:attachment"
                             hideEditButtons="true" img="nms:attachment.png" nolabel="true"
                             prebuildSubForm="false" toolbarCaption="添付ファイルのリスト"
                             type="list" xpath="attachment" zoom="true" zoomOnAdd="true">
                        <container name="addToolbar">
                          <input collection="." img="xtk:xawadd.png" insertAfter="Add"
                                 label="追加" type="fileResAddMenuButton">
                            <command form="nms:uploadAttachment" label="ファイル..."
                                     name="file">
                              <enter>
                                <set expr="[/tmp/@uploadFile]" xpath="name"/>
                                <set value="normal" xpath="@type"/>
                              </enter>
                            </command>
                            <command form="nms:attachment" label="計算済み添付ファイル..."
                                     name="attachement">
                              <enter>
                                <set value="1" xpath="@resourceType"/>
                          <!-- Force id attribution to newly created attach files -->
                                <setModified/>
                              </enter>
                            </command>
                          </input>
                        </container>
                        <input editable="true" xpath="@label"/>
                        <input width="25" xpath="@type"/>
                        <input xpath="@size"/>
                  <!-- ### should display size, filename, filter active,... using expressions in xawlist -->
                      </input>
                    </container>
                  </form>
                </input>
                <input nolabel="true" readOnly="true" xpath="/tmp/attachment"/>
              </container>
              <container colcount="2" colspan="2" type="visibleGroup" visibleIf="[/ignored/@isLinkedToContent]='false'">
                <container colcount="2" colspan="2" readOnlyIf="[/ignored/@limitEdition] and [/ignored/@contentStatus]!=10"
                           type="readOnlyGroup">
                  <input label="件名" margin-right="5" prebuildSubForm="false" type="subFormLink"
                         xpath="subject">
                    <form label="メッセージの件名を編集" name="editForm" nothingToSave="true">
                      <static label="件名" type="separator"/>
                      <input nolabel="true" toolbarAlign="horizontal" type="jstEdit"
                             xpath="." xpathInsert="/ignored/customizeSubject">
                        <container>
                          <input menuId="deliveryMenuBuilder" type="customizeBtn"
                                 xpath="/ignored/customizeSubject"/>
                        </container>
                      </input>
                    </form>
                  </input>
                  <input nolabel="true" type="edit" xpath="subject"/>
                </container>
              </container>
            </container>

      <!-- Remote content link summary -->
            <container applicableIf="HasPackage('nms:aemIntegration')" type="visibleGroup"
                       visibleIf="[/delivery/@contentEditingMode]=2 and [remoteContent/@remotePath] != ''">
              <container backcolor="tooltip" colcount="3" nolabel="true">
                <static colspan="3" type="separator"/>
                <static colspan="2" fontBold="true" label="AEM コンテンツと同期された配信。コンテンツは分析時に自動的に取得されます。"/>
                <container backcolor="tooltip" type="visibleGroup" visibleIf="[/delivery/@contentModTime]=''">
                  <input label="コンテンツを更新" type="button">
                    <enter>
                      <soapCall name="aemGetContent" service="nms:delivery">
                        <param exprIn="/delivery" type="DOMElement"/>
                        <param type="DOMElement" xpathOut="/ignored/aemContent"/>
                      </soapCall>
                      <setModified/>
                      <set expr="[/ignored/aemContent/@approved]" xpath="remoteContent/@remoteValidation"/>
                      <set expr="GetDate()" xpath="remoteContent/@lastSync"/>
                      <set expr="[/ignored/aemContent/subject]" xpath="mailParameters/subject"/>
                      <set expr="[/ignored/aemContent/html]" xpath="content/html/source"/>
                      <set expr="[/ignored/aemContent/text]" xpath="content/text/source"/>
                    </enter>
                  </input>
                </container>
                <container backcolor="tooltip" type="visibleGroup" visibleIf="[/delivery/@contentModTime]!=''">
                  <static/>
                </container>
                <value label="AEM コンテンツラベル" xpath="remoteContent/@remoteLabel"/>
                <container backcolor="tooltip" type="visibleGroup" visibleIf="[remoteContent/@remoteValidation]=true">
                  <static img="xtk:xtkcheck.png" label="AEM コンテンツが承認されました"/>
                </container>
                <container backcolor="tooltip" type="visibleGroup" visibleIf="[remoteContent/@remoteValidation]=false">
                  <static img="xtk:xtkcancel.png" label="承認されていない AEM コンテンツ"/>
                </container>
                <value label="最終同期日" xpath="remoteContent/@lastSync"/>
                <static colspan="3" type="separator"/>
              </container>
            </container>

    <!-- Does the delivery use a content? -->
            <input applicableIf="HasPackage('ncm:content')" expr="[@publishing-name]!='' and [@publishing-namespace]!=''"
                   type="expr" xpath="/ignored/@hasContent"/>
            <container checkModify="true" type="notebook">
              <container activatedIf="true" applicableIf="HasPackage('ncm:content')"
                         img="xtk:form.png" label="編集" readOnlyIf="[/tmp/@readOnly] or ([/ignored/@limitEdition] and [/ignored/@contentStatus]!=10)"
                         visibleIf="[/ignored/@hasContent]">
                <input type="deliveryContent" xpath="content/content"/>
              </container>
              <container applicableIf="HasPackage('ncm:content')" img="xtk:html.png"
                         label="HTML プレビュー" visibleIf="[/ignored/@hasContent]" xpath="content/html">
                <input name="previewToolbar" type="toolbarCtrl"/>
                <static type="separator"/>
                <container ref="nms:delivery:lib/content/Preview/headers/mail" xpath="/tmp/html/preview"/>
                <container ref="nms:delivery:lib/content/Preview/body"/>
              </container>
              <container applicableIf="HasPackage('ncm:content')" img="xtk:text.png"
                         label="テキストプレビュー" visibleIf="[/ignored/@hasContent]" xpath="content/text">
                <input name="previewToolbar" type="toolbarCtrl"/>
                <static type="separator"/>
                <container ref="nms:delivery:lib/content/Preview/headers/mail" xpath="/tmp/text/preview"/>
                <container ref="nms:delivery:lib/content/Preview/body"/>
              </container>
              <container img="xtk:html.png" label="HTML コンテンツ" readOnlyIf="[/tmp/@readOnly] or ([/ignored/@limitEdition] and [/ignored/@contentStatus]!=10)"
                         visibleIf="![/ignored/@hasContent]" xpath="content/html">
                <container ref="nms:delivery:lib/content/HTML"/>
              </container>
              <container img="xtk:text.png" label="テキストコンテンツ" readOnlyIf="[/tmp/@readOnly] or ([/ignored/@limitEdition] and [/ignored/@contentStatus]!=10)"
                         visibleIf="![/ignored/@hasContent]" xpath="content/text">
                <container ref="nms:delivery:lib/content/Text"/>
              </container>

              <container applicableIf="HasPackage('nms:messageCenter')" img="nms:unknownad.png"
                         label="シードアドレス" visibleIf="[/ignored/@triggerMessage]=1">
                <container ref="nms:delivery:lib/proofTarget"/>
              </container>
            </container>
          </container>
        </container>
      </container>
    </container>
<!--[cf]-->
<!--[of]:Paper-->
    <container applicableIf="HasPackage('nms:paper')" img="nms:paper.png" label="ダイレクトメール"
               name="paperDefinition" visibleIf="EV(@messageType, 'paper') and @deliveryMode!=0">
      <container colcount="2" label="ターゲット" name="headers" type="frame">
        <container ref="nms:delivery:lib/targetFrame"/>
        <input alwaysActive="true" lineCount="2" noBorder="true" nolabel="true" readOnly="true"
               type="memo" xpath="/tmp/target"/>
      </container>

      <container label="配信コンテンツのパラメーター" type="frame" xpath="content">
        <input xpath="../scheduling/@contactDate"/>
        <input xpath="@hasPdf"/>
        <container enabledIf="@hasPdf" type="enabledGroup">
          <input label="タイプ" xpath="@pdfType"/>
          <input label="圧縮を有効にする" xpath="@pdfCompression"/>
        </container>
      </container>

      <container name="paperContent" type="notebook">

<!--[of]:Simple PDF-->
        <container label="コンテンツ" name="PDFSimple" visibleIf="EV([content/@pdfType], 'simple') AND [content/@hasPdf]"
                   xpath="content/pdf[1]">
          <container colcount="2" name="editPDFFile">
            <container colspan="2" type="visibleGroup" visibleIf="@upload">
              <input filters="OpenOffice または Word ドキュメント (*.odt;*.doc)|*.odt;*.doc|すべてのファイル (*.*)|*.*|"
                     label="ローカルファイル" type="fileEdit" xpath="name" xpathCopyName="@label"
                     xpathCopySize="@size"/>
            </container>
            <container colspan="2" type="visibleGroup" visibleIf="@upload == false">
              <input label="サーバーファイル" xpath="name"/>
            </container>
            <input xpath="@label"/>
            <input xpath="@compressMode"/>
            <container ref="xtk:importSource:sourceInfos/autoDetect/file/upload"
                       xpath="."/>
            <container colcount="2" colspan="2" type="visibleGroup" visibleIf="EV([../@pdfType], 'multiple')">
              <input label="詳細設定パラメーター..." nolabel="true" prebuildSubForm="false"
                     type="subFormLink" xpath=".">
                <form label="PDF コンテンツの詳細設定パラメーター">
                  <input useDesc="true" xpath="@filterActive"/>
                  <container enabledIf="@filterActive" type="enabledGroup">
                    <input jst="false" nolabel="true" type="jstEdit" xpath="filterScript"
                           xpathInsert="/ignored/customizePdfFilter">
                      <container>
                        <input menuId="deliveryMenuBuilder" options="notJst" type="customizeBtn"
                               xpath="/ignored/customizePdfFilter"/>
                      </container>
                    </input>
                    <static type="help">このスクリプトは、各受信者が PDF ファイルを受信するかどうかを判別します (スクリプトが「true」を返した場合は受信します)。</static>
                  </container>
                </form>
              </input>
              <container type="visibleGroup" visibleIf="@filterActive">
                <static fontBold="true" label="(アクティブなフィルター)"/>
              </container>
            </container>
            <container colspan="2" enabledIf="@md5 != '' or ( @upload == false and name != '' )"
                       type="enabledGroup">
              <container label="プレビュー" name="tabPreview">
                <input name="previewToolbar" type="toolbarCtrl"/>
                <static type="separator"/>
                <container ref="nms:delivery:lib/content/HTML/htmlContentEditor/notebook/tabPreview/body"
                           xpath="."/>
              </container>
            </container>
          </container>
        </container>
<!--[cf]-->
<!--[of]:Multiple PDFs-->
        <container name="PDFMultiple" visibleIf="EV([content/@pdfType], 'multiple') AND [content/@hasPdf]"
                   xpath="content">
          <input editable="false" nolabel="true" prebuildSubForm="false" toolbarAlign="vertical"
                 type="list" xpath="pdf" zoom="true" zoomOnAdd="true">
            <input editable="true" xpath="@active"/>
            <input editable="true" xpath="@label"/>
            <input xpath="@compressMode"/>
            <input xpath="@size"/>
            <form colcount="2" label="コンテンツファイルの定義" xpathsToLoad="*">
              <container ref="nms:delivery:edit/paperDefinition/paperContent/PDFSimple/editPDFFile"
                         xpath="."/>
            </form>
          </input>
        </container>
<!--[cf]-->

<!--[of]:Address-->
        <container label="アドレス">
          <container label="送信者のアドレス" maxLabelWidth="200" type="frame" xpath="paperParameters/senderAddress">
            <static type="help">電子登録済みのレターを使用する場合はこれらのパラメーターが必要です。</static>
            <input label="会社名" xpath="@line1"/>
            <input label="受信者またはサービス ID" xpath="@line2"/>
            <input label="地理的住所詳細" xpath="@line3"/>
            <input label="番地" xpath="@line4"/>
            <input label="特別 (郡...)" xpath="@line5"/>
            <input label="郵便番号と市区町村" xpath="@line6"/>
            <input label="国 / 地域" xpath="@line7"/>
          </container>

          <container label="アドレス" type="frame" xpath="paperParameters">
            <container enabledIf="@envelope=='C6SW' or @envelope=='C6DW'" type="enabledGroup">
              <input checkedValue="ownPage" label="専用ページでアドレスを追加" margin-left="20"
                     type="RadioButton" xpath="@addressPos"/>
              <input checkedValue="firstPage" label="ドキュメントの最初のページでアドレスを追加" margin-left="20"
                     type="RadioButton" xpath="@addressPos"/>
            </container>
          </container>

        </container>
<!--[cf]-->
<!--[of]:Envelop-->
        <container label="封筒">

          <container label="封筒" type="frame" xpath="paperParameters">
            <input checkedValue="AUTO" label="フォーマットを自動検出 *" type="RadioButton" xpath="@envelope"/>
            <input checkedValue="C6SW" label="小封筒、C6 フォーマット (229 x 114 mm) シンプルな窓付き"
                   type="RadioButton" xpath="@envelope"/>
            <container enabledIf="@priceCategory!='recom_R1'" type="enabledGroup">
              <input checkedValue="C6DW" label="封筒 (小) : C6 サイズ (229 x 114 mm) 二つ窓"
                     type="RadioButton" xpath="@envelope"/>
            </container>
            <input checkedValue="C4" label="封筒 (大)、C4 サイズ (332 x 230 mm)" type="RadioButton"
                   xpath="@envelope"/>
            <static type="help">* 4 枚未満のシートを含むレターは C6 (229 x 114 mm) 単一窓付きの封筒で送信されます。4 枚以上のシートを含むレターは C4 (332 x 230 mm) 封筒で送信されます。\nいずれの場合でも、アドレスを含む最初のページが追加されます。</static>
          </container>

          <container colcount="2" label="レターのコンテンツ" type="frame" xpath="paperParameters">
            <container>
              <input checkedValue="bw" label="モノクロ印刷" margin-left="20" type="RadioButton"
                     xpath="@colorSupport"/>
              <input checkedValue="color" label="カラー印刷" type="RadioButton" xpath="@colorSupport"/>
            </container>
            <container>
              <input checkedValue="recto" label="片面印刷" margin-left="20" type="RadioButton"
                     xpath="@rectoVerso"/>
              <input checkedValue="rectoverso" label="両面印刷" type="RadioButton" xpath="@rectoVerso"/>
            </container>
          </container>

        </container>
<!--[cf]-->
<!--[of]:Affranchissement-->
        <container label="郵送の計測" xpath="paperParameters">
          <container colcount="2" label="スタンピングカテゴリ" type="frame">
            <container>
              <input checkedValue="letterPrio" label="郵便料金 - ファーストクラス" type="RadioButton"
                     xpath="@priceCategory"/>
              <input checkedValue="ecoPli" label="大量割引 (経済的)" type="RadioButton"
                     xpath="@priceCategory"/>
      <!--input checkedValue="ecoPliBulk"     label="Tarif Ecopli en nombre" type="RadioButton" xpath="@priceCategory"/>
      <input checkedValue="postImpact1_C6" label="Tarif PostImpact mécanisable seuil 1 (enveloppe C6)" type="RadioButton" xpath="@priceCategory"/>
      <input checkedValue="postImpact2_C6" label="Tarif PostImpact mécanisable seuil 2 (enveloppe C6)" type="RadioButton" xpath="@priceCategory"/>
      <input checkedValue="postImpact1_C4" label="Tarif PostImpact Standard Distri seuil 1 (enveloppe C4)" type="RadioButton" xpath="@priceCategory"/>
      <input checkedValue="postImpact2_C4" label="Tarif PostImpact Standard Distri seuil 2 (enveloppe C4)" type="RadioButton" xpath="@priceCategory"/-->
              <input checkedValue="recom_R1" label="La Poste (R1) からの電子登録済みのレター***"
                     type="RadioButton" xpath="@priceCategory"/>
            </container>
            <container enabledIf="@priceCategory='recom_R1'" type="enabledGroup">
              <input checkedValue="false" label="受信確認なし" margin-left="20" type="RadioButton"
                     xpath="@AR"/>
              <input checkedValue="true" label="受信確認を使用" margin-left="20" type="RadioButton"
                     xpath="@AR"/>
              <container enabledIf="@AR" type="enabledGroup">
                <input label="返信先 E メールアドレス" margin-left="20" xpath="@emailAR"/>
              </container>
            </container>

            <static colspan="2" type="help">*** La Poste からの電子登録レターに対する郵便料金計数機 / 別納証印刷機による料金付けは、次の宛先に対して可能です。\n
  Metropolitan France, Overseas Departments, Andorra and Monaco</static>
          </container>

          <container label="オプション" type="frame">
            <container enabledIf="@priceCategory!='recom_R1'" type="enabledGroup">
              <input label="配信不能の電子管理 (有料オプション)" xpath="@handleNPAI"/>
            </container>
            <input useDesc="true" xpath="@printInternalRef"/>
          </container>

        </container>
<!--[cf]-->

      </container>
    </container>
<!--[cf]-->
<!--[of]:Mobile-->
    <container img="nms:mobile.png" label="SMS" name="mobileDefinition" visibleIf="EV(@messageType, 'sms') and @deliveryMode!=0">
      <container label="レプリケートされた SMS 配信プロパティ" name="replicatedSMSProperties" readOnly="true"
                 type="visibleGroup" visibleIf="[/ignored/@isACSConnector]">
        <container ref="nms:delivery:lib/content/commonReplicatedProperties"/>
      </container>
      <container label="SMS 配信プロパティ" name="SMSProperties" type="visibleGroup" visibleIf="[/ignored/@isACSConnector]==false">
        <container applicableIf="HasPackage('nms:campaign')" type="visibleGroup"
                   visibleIf="[@linkedDelivery-id]!=0 and [@workflow-id]!=0">
          <container colcount="2" label="配信ターゲット母集団" name="headers" type="frame">
            <container ref="nms:delivery:lib/targetFrame"/>
            <input alwaysActive="true" lineCount="2" noBorder="true" nolabel="true"
                   readOnly="true" type="memo" xpath="/tmp/target"/>
          </container>
          <container label="メインの配信" type="frame">
            <input label="配信" readOnly="true" xpath="linkedDelivery"/>
            <static label="SMS のコンテンツはメインの配信から作成されます。" type="help"/>
            <container type="visibleGroup" visibleIf="EV(@deliveryMode, 'external')==false"
                       xpath="linkedDelivery">
              <container style="flat" type="notebook">
                <container img="nms:mobile.png" label="SMS" name="smsContent" visibleIf="EV(@messageType, 'sms') and EV([smsParameters/@mobileMsgType], 'sms', 'wapPush')"
                           xpath="smsParameters">
                  <container ref="nms:delivery:edit/mobileDefinition/SMSProperties/parameters/smsContentEditor/notebook/tabPreview"/>
                </container>
              </container>
            </container>
          </container>
        </container>
        <container name="parameters" type="visibleGroup" visibleIf="[/ignored/@hasParentDelivery]!=1">
          <container type="visibleGroup" visibleIf="[/ignored/@limitEdition]=false">
            <container type="visibleGroup" visibleIf="[/ignored/@triggerMessage]!='1'">
              <container label="配信ターゲット母集団" type="frame">
                <container colcount="2">
                  <container ref="nms:delivery:lib/targetFrame"/>
                  <input alwaysActive="true" lineCount="2" noBorder="true" nolabel="true"
                         readOnly="true" type="memo" xpath="/tmp/target"/>
                </container>
              </container>
            </container>
          </container>
          <container name="smsContentEditor" propagateConstraints="false" type="visibleGroup"
                     visibleIf="EV(@messageType, 'sms') and EV([smsParameters/@mobileMsgType], 'mms')=false">
            <container name="notebook" type="contentEditor" xpath="smsParameters">
              <container img="xtk:text.png" label="テキストコンテンツ" name="tabSMS" readOnlyIf="[/tmp/@readOnly] or ([/ignored/@limitEdition] and [/ignored/@contentStatus]!=10)">
                <input fullToolbar="true" htmlMode="false" name="ctSource" nolabel="true"
                       type="htmlSource" xpath="../content/sms/source" xpathInsert="/ignored/customizeSMSContent">
                  <container>
                    <input menuId="deliveryMenuBuilder" type="customizeBtn" xpath="/ignored/customizeSMSContent"/>
                  </container>
                </input>
              </container>
              <container colcount="2" img="xtk:html.png" label="プレビュー" name="tabPreview">
                <input colspan="2" name="previewToolbar" type="toolbarCtrl"/>
                <static colspan="2" type="separator"/>
                <value label="長さ" xpath="/tmp/sms/preview/@length"/>
                <input label="データ読み込み..." nolabel="true" prebuildSubForm="false"
                       type="subFormLink" xpath="/tmp/rcpQryResult">
                  <form label="プレビュー用に読み込まれた受信者のデータ">
                    <input nolabel="true" readOnly="true" type="SourceEdit" xpath="queryResult"/>
                  </form>
                </input>
                <container colcount="2" colspan="2" type="visibleGroup" visibleIf="[/tmp/sms/preview/@length] &gt; 160">
                  <static/>
                  <static img="xtk:logwarn.png" label=" " nolabel="true">この受信者のコンテンツは SMS の最大サイズである 160 文字を超過しています。</static>
                </container>
                <static colspan="2" type="separator"/>
                <container ref="nms:delivery:lib/content/Preview/body" xpath="../content/sms"/>
                <input postXPath="/tmp/sms/preview/content" sessionToken="true" type="urlViewer"
                       urlExpr="$(serverUrl) + '/nms/deliveryPreview.jssp?messageType=43'"
                       utf8EncodePostXPath="true"/>
              </container>
              <container applicableIf="HasPackage('nms:messageCenter')" img="nms:unknownad.png"
                         label="シードアドレス" visibleIf="[/ignored/@triggerMessage]=1">
                <container ref="nms:delivery:lib/proofTarget" xpath="/delivery"/>
              </container>
            </container>
          </container>
        </container>
      </container>
    </container>
<!--[cf]-->
<!--[of]:Facebook-->
    <container applicableIf="HasPackage('nms:social')" img="nms:facebook.png" label="Facebook"
               name="facebookDefinition" visibleIf="EV(@messageType, 'facebook') and @deliveryMode!=0">
      <container colcount="3" label="Facebook ページ" type="frame">
        <container colcount="2">
          <container ref="nms:delivery:lib/targetFrame"/>
          <input alwaysActive="true" lineCount="1" noBorder="true" nolabel="true"
                 readOnly="true" type="memo" xpath="/tmp/target"/>
        </container>
      </container>
      <input label="コンテンツタイプ" xpath="content/@fcbContentType">
        <enter name="onChange">
          <set expr="[content/@fcbContentType]" xpath="content/facebookContentType/source"/>
        </enter>
      </input>
      <container type="visibleGroup" visibleIf="EV([content/@fcbContentType], 'status', 'statusWithLink', 'statusWithYoutubeLink')">
        <container readOnlyIf="[/tmp/@readOnly]" type="notebook">
          <container img="nms:facebook.png" label="コンテンツ">

            <container type="visibleGroup" visibleIf="EV([content/@fcbContentType], 'status', 'statusWithLink', 'statusWithYoutubeLink')">
              <input fullToolbar="true" htmlMode="false" label="ステータス" name="ctSource"
                     type="htmlSource" xpath="content/facebookMessage/source" xpathInsert="/ignored/customizeTextContent"
                     xpathUrl="/tmp/urlTree/@toSelect">
                <container>
                  <input menuId="deliveryMenuBuilder" type="customizeBtn" xpath="/ignored/customizeTextContent"/>
                </container>
              </input>
            </container>
            <container type="visibleGroup" visibleIf="EV([content/@fcbContentType], 'statusWithLink')">
              <input label="リンク" type="separator"/>
              <input label="名前" menuId="deliveryMenuBuilder" type="scriptEdit" xpath="content/facebookName/source"/>
              <input label="リンク" menuId="deliveryMenuBuilder" type="scriptEdit" xpath="content/facebookLink/source"/>
              <input label="画像" menuId="deliveryMenuBuilder" type="scriptEdit" xpath="content/facebookPicture/source"/>
              <input label="キャプション" menuId="deliveryMenuBuilder" type="scriptEdit"
                     xpath="content/facebookCaption/source"/>
              <input label="説明" toolbar="false" type="CodeEdit" xpath="content/facebookDescription/source"
                     xpathInsert="/ignored/customizeTextContent" xpathUrl="/tmp/urlTree/@toSelect">
                <container>
                  <input menuId="deliveryMenuBuilder" type="customizeBtn" xpath="/ignored/customizeTextContent"/>
                </container>
              </input>
            </container>
            <container colcount="2" type="visibleGroup" visibleIf="EV([content/@fcbContentType], 'statusWithYoutubeLink')">
              <input colspan="2" label="ビデオリンク" type="separator"/>
              <input colspan="2" label="名前" menuId="deliveryMenuBuilder" type="scriptEdit"
                     xpath="content/facebookName/source"/>
              <input label="ビデオコード" menuId="deliveryMenuBuilder" type="scriptEdit"
                     xpath="content/facebookVideoCode/source"/>
              <static nolabel="true" type="help">例えば「http://www.youtube.com/watch?v=abc123456」というリンクの場合、ビデオコードは「abc123456」です。</static>
              <input colspan="2" label="キャプション" menuId="deliveryMenuBuilder" type="scriptEdit"
                     xpath="content/facebookCaption/source"/>
              <input colspan="2" label="説明" toolbar="false" type="CodeEdit" xpath="content/facebookDescription/source"
                     xpathInsert="/ignored/customizeTextContent" xpathUrl="/tmp/urlTree/@toSelect">
                <container>
                  <input menuId="deliveryMenuBuilder" type="customizeBtn" xpath="/ignored/customizeTextContent"/>
                </container>
              </input>
            </container>
          </container>
        <!-- To improve preview
        <container label="Src" name="tabHtmlSrc">
          <input label="Src" xpath="content/html/source"/>
        </container>
         -->
          <container img="xtk:preview.png" label="プレビュー" name="tabPreview" xpath="content/html/source">
            <container ref="nms:delivery:lib/content/Facebook/facebookContentEditor/tabPreview"/>
          </container>
        </container>
      </container>
      <container type="visibleGroup" visibleIf="EV([content/@fcbContentType], 'photo')">
        <container readOnlyIf="[/tmp/@readOnly]" type="notebook">
          <container colcount="2" img="nms:facebook.png" label="コンテンツ">
            <container type="visibleGroup" visibleIf="EV([content/@fcbContentType], 'photo')">
              <input label="アルバム名" menuId="deliveryMenuBuilder" type="scriptEdit"
                     xpath="content/facebookAlbumName/source"/>

              <input fullToolbar="true" htmlMode="false" label="説明" name="ctSource"
                     nolabel="false" type="htmlSource" xpath="content/facebookAlbumDesc/source"
                     xpathInsert="/ignored/customizeTextContent" xpathUrl="/tmp/urlTree/@toSelect">
                <container>
                  <input menuId="deliveryMenuBuilder" type="customizeBtn" xpath="/ignored/customizeTextContent"/>
                </container>
              </input>
              <container collection="/delivery/attachment" form="nms:uploadAttachment"
                         label="{1} ファイルをアップロードしますか？" type="fileDropZone">
                <enter name="onClick">
                  <set expr="[/tmp/@uploadFile]" xpath="name"/>
                  <set value="normal" xpath="@type"/>
                </enter>
                <input delButton="true" editable="false" form="nms:attachment" hideEditButtons="true"
                       nolabel="true" prebuildSubForm="false" toolbarCaption="写真"
                       type="list" xpath="attachment" zoom="false" zoomOnAdd="true">
                  <container name="addToolbar">
                    <input collection="." img="xtk:xawadd.png" insertAfter="Add"
                           label="追加" type="fileResAddMenuButton">
                      <command form="nms:uploadAttachment" label="ファイル..." name="file">
                        <enter>
                          <set expr="[/tmp/@uploadFile]" xpath="name"/>
                          <set value="normal" xpath="@type"/>
                        </enter>
                      </command>
                    </input>
                  </container>
                  <input editable="true" label="名前" xpath="@label"/>
                  <input editable="true" label="キャプション" xpath="source"/>
                </input>
              </container>
            </container>
          </container>
        </container>
      </container>
    </container>
<!--[cf]-->

<!--[of]:Tweet-->
    <container applicableIf="HasPackage('nms:social')" img="nms:twitter.png" label="ツイート"
               name="twitterDefinition" visibleIf="EV(@messageType, 'twitter') and @deliveryMode!=0">
      <container label="Twitter アカウント" type="frame">
        <container colcount="2">
          <container ref="nms:delivery:lib/targetFrame"/>
          <input alwaysActive="true" lineCount="2" noBorder="true" nolabel="true"
                 readOnly="true" type="memo" xpath="/tmp/target"/>
        </container>
      </container>
      <container name="notebook" type="contentEditor" xpath="content/twitterMsg/source">
        <container img="nms:twitter.png" label="コンテンツ" name="tabText" readOnlyIf="[/tmp/@readOnly]">
          <container ref="nms:delivery:lib/content/Tweet/tweetContentEditor/tabText"/>
        </container>
        <container img="xtk:preview.png" label="プレビュー" name="tabPreview">
          <container ref="nms:delivery:lib/content/Tweet/tweetContentEditor/tabPreview"/>
        </container>
      </container>
    </container>
<!--[cf]-->
<!--[of]:LINE -->
    <container applicableIf="HasPackage('nms:line')" img="nms:line.png" label="LINE"
               name="lineDefinition" visibleIf="EV(@messageType, 'line') and @deliveryMode!=0 and [content/lineVersion/source]= 'line'">
      <container type="visibleGroup" visibleIf="[/ignored/@triggerMessage]!=1">
        <container colcount="3" label="LINE メッセージ" type="frame">
          <container colcount="2">
            <container ref="nms:delivery:lib/targetFrame"/>
            <input alwaysActive="true" lineCount="2" noBorder="true" nolabel="true"
                   readOnly="true" type="memo" xpath="/tmp/target"/>
          </container>
        </container>
      </container>
      <input enum="nms:delivery:lineContentType" label="コンテンツタイプ" type="sysEnum"
             xpath="content/lineContentType/source"/>
      <container readOnlyIf="[/tmp/@readOnly]" type="notebook">
        <container img="nms:line.png" label="コンテンツ">
          <container type="visibleGroup" visibleIf="[content/lineContentType/source] = 'text'">
            <input fullToolbar="true" htmlMode="false" name="ctSource" nolabel="true"
                   type="htmlSource" xpath="content/lineMessage/source" xpathInsert="/ignored/customizeTextContent"
                   xpathUrl="/tmp/urlTree/@toSelect">
              <container>
                <input menuId="deliveryMenuBuilder" type="customizeBtn" xpath="/ignored/customizeTextContent"/>
              </container>
            </input>
          </container>
          <container type="visibleGroup" visibleIf="[content/lineContentType/source] = 'image'">
            <input label="画像" type="separator"/>
            <input checkedValue="personalized" label="パーソナライズされた画像" nolabel="true"
                   type="checkbox" unCheckedValue="manual" xpath="content/lineImageType/source"/>
            <container colcount="1" type="visibleGroup" visibleIf="[content/lineImageType/source] = 'manual'">
              <input label="画像 URL (1040 px)" type="string" xpath="content/lineImageUrl5/source"/>
              <input label="画像 URL (700 px)" type="string" xpath="content/lineImageUrl4/source"/>
              <input label="画像 URL (460 px)" type="string" xpath="content/lineImageUrl3/source"/>
              <input label="画像 URL (300 px)" type="string" xpath="content/lineImageUrl2/source"/>
              <input label="画像 URL (240 px)" type="string" xpath="content/lineImageUrl1/source"/>
              <static nolabel="true" type="help">すべての画像 URL の入力は必須ではありません。特定の解像度の画像が入力されていない場合、最も高い解像度の画像が使用されます。</static>
            </container>
            <container type="visibleGroup" visibleIf="[content/lineImageType/source] = 'personalized'">
              <input label="画像 URL" menuId="deliveryMenuBuilder" type="scriptEdit"
                     xpath="content/lineImage/source"/>
              <static nolabel="true" type="help">%SIZE% 変数は、LINE によってリクエストされたサイズに使用できます。</static>
            </container>
            <input label="代替テキスト" menuId="deliveryMenuBuilder" type="scriptEdit"
                   xpath="content/lineImageText/source"/>
            <static nolabel="true" type="help">画像が利用できない場合の代替テキスト。</static>
            <static label=" " noLabel="true"/>
            <input label="リンク" type="separator"/>
            <input label="アクション (URL)" menuId="deliveryMenuBuilder" type="scriptEdit"
                   xpath="content/lineWebLink/source"/>
            <input label="幅 (ピクセル)" type="string" xpath="content/lineImageLength/source"/>
            <input label="高さ (ピクセル)" type="string" xpath="content/lineImageHeight/source"/>
          </container>
        </container>
        <container img="xtk:preview.png" label="プレビュー" name="tabPreview" visibleIf="[content/lineContentType/source] = 'text'"
                   xpath="content/lineMessage/source">
          <container ref="nms:delivery:lib/content/Line/lineContentEditor/tabPreview"/>
        </container>
        <container applicableIf="HasPackage('nms:messageCenter')" img="nms:unknownad.png"
                   label="シードアドレス" visibleIf="[/ignored/@triggerMessage]=1">
          <container ref="nms:delivery:lib/proofTarget" xpath="/delivery"/>
        </container>
      </container>
    </container>
<!--[cf]-->

<!--[of]:LINE V2 -->
    <container applicableIf="HasPackage('nms:lineV2')" img="nms:line.png" label="LINE"
               name="lineDefinitionV2" visibleIf="EV(@messageType, 'line') and @deliveryMode!=0 and [content/lineVersion/source]= 'lineV2'">
      <container type="visibleGroup" visibleIf="[/ignored/@triggerMessage]!=1">
        <container colcount="3" label="ターゲット" type="frame">
          <container colcount="2">
            <container ref="nms:delivery:lib/targetFrame"/>
            <input alwaysActive="true" lineCount="2" noBorder="true" nolabel="true"
                   readOnly="true" type="memo" xpath="/tmp/target"/>
          </container>
        </container>
      </container>
      <container colcount="3" label="LINE メッセージ" type="frame">
        <input editable="false" hideEditButtons="false" img="nms:line.png" nolabel="true"
               ordered="false" prebuildSubForm="true" promptDeleteLabel="選択したメッセージを削除しますか？"
               toolbarCaption="1 件以上のメッセージ (最大 5 件) を追加します。" type="list" xpath="/tmp/lineCustomFields/multicontent/content"
               zoom="true" zoomOnAdd="true">

          <input label="メッセージタイプ" xpath="content/lineContentType/source"/>
          <form name="selectLineMessages">
            <enter>
              <set expr="1" xpath="/ignored/@autoRefresh"/>
              <set value="never" xpath="content/lineImageUrl5/@_type"/>
              <set value="never" xpath="content/lineImageUrl4/@_type"/>
              <set value="never" xpath="content/lineImageUrl3/@_type"/>
              <set value="never" xpath="content/lineImageUrl2/@_type"/>
              <set value="never" xpath="content/lineImageUrl1/@_type"/>
              <set value="never" xpath="content/lineImage/@_type"/>

              <set value="lineImageUrl" xpath="content/lineImageUrl5/@_category"/>
              <set value="lineImageUrl" xpath="content/lineImageUrl4/@_category"/>
              <set value="lineImageUrl" xpath="content/lineImageUrl3/@_category"/>
              <set value="lineImageUrl" xpath="content/lineImageUrl2/@_category"/>
              <set value="lineImageUrl" xpath="content/lineImageUrl1/@_category"/>
              <set value="lineImageUrl" xpath="content/lineImage/@_category"/>

              <if expr="[content/lineContentType/source]=''">
                <set value="text" xpath="content/lineContentType/source"/>
              </if>
              <if expr="[content/lineImageType/source]=''">
                <set value="manual" xpath="content/lineImageType/source"/>
              </if>
              <if expr="[content/lineMultiRegionLayoutType/source]=''">
                <set value="1" xpath="content/lineMultiRegionLayoutType/source"/>
              </if>
              <if expr="[content/lineImageUrl4/source]!=''or [content/lineImageUrl3/source]!='' or [content/lineImageUrl2/source]!='' or [content/lineImageUrl1/source]!=''">
                <set value="true" xpath="content/@showAdvancedImageSourceUrl"/>
              </if>
            </enter>
            <input alwaysActive="true" expr="[content/lineMessage/source]" type="expr"
                   xpath="/tmp/dummy">
              <enter>
                <copyElement exprDst="'/delivery/content/linePreview'" xpathSrc="content/lineMessage"/>
              </enter>
            </input>
            <input default="text" enum="nms:delivery:lineContentType" label="コンテンツタイプ"
                   type="sysEnum" xpath="content/lineContentType/source"/>
            <container readOnlyIf="[/tmp/@readOnly]" type="notebook">
              <container img="nms:line.png" label="コンテンツ">
                <container type="visibleGroup" visibleIf="[content/lineContentType/source] = 'text'">
                  <input fullToolbar="true" htmlMode="false" name="ctSource" nolabel="true"
                         type="htmlSource" xpath="content/lineMessage/source" xpathInsert="/ignored/customizeTextContent"
                         xpathUrl="/tmp/urlTree/@toSelect">
                    <container>
                      <input menuId="deliveryMenuBuilder" type="customizeBtn" xpath="/ignored/customizeTextContent"/>
                    </container>
                  </input>
                </container>
                <container maxLabelWidth="200" type="visibleGroup" visibleIf="[content/lineContentType/source] = 'image'">
                  <input label="画像" type="separator"/>
                  <input checkedValue="personalized" label="パーソナライズされた画像" nolabel="true"
                         type="checkbox" unCheckedValue="manual" xpath="content/lineImageType/source"/>
                  <container colcount="1" type="visibleGroup" visibleIf="[content/lineImageType/source] = 'manual'">
                    <input label="画像 URL (1040 x 1040 px)" type="string" xpath="content/lineImageUrl5/source"/>
                    <input checkedValue="true" label="デバイスの画面サイズごとに画像を定義" nolabel="true"
                           type="checkbox" unCheckedValue="false" xpath="content/@showAdvancedImageSourceUrl"/>
                    <container type="visibleGroup" visibleIf="[content/@showAdvancedImageSourceUrl] = 'true'">
                      <input label="画像 URL (700 x 700 px)" type="string" xpath="content/lineImageUrl4/source"/>
                      <input label="画像 URL (460 x 460 px)" type="string" xpath="content/lineImageUrl3/source"/>
                      <input label="画像 URL (300 x 300 px)" type="string" xpath="content/lineImageUrl2/source"/>
                      <input label="画像 URL (240 x 240 px)" type="string" xpath="content/lineImageUrl1/source"/>
                      <static nolabel="true" type="help">画面に合った画像を設定することで、小さい画面でも最適に表示できます。特定の解像度の画像が設定されていない場合は、最も高い解像度の画像が使用されます。</static>
                    </container>
                  </container>
                  <container type="visibleGroup" visibleIf="[content/lineImageType/source] = 'personalized'">
                    <input label="画像 URL" menuId="deliveryMenuBuilder" type="scriptEdit"
                           xpath="content/lineImage/source"/>
                    <static nolabel="true" type="help">%SIZE% 変数は、LINE によってリクエストされたサイズに使用できます。</static>
                  </container>
                  <input label="代替テキスト" menuId="deliveryMenuBuilder" type="scriptEdit"
                         xpath="content/lineImageText/source"/>
                  <static nolabel="true" type="help">画像を表示できない場合の画像の代替テキスト。これは必須の情報です。</static>
                  <static label=" " noLabel="true"/>
                  <input label="リンク" type="separator"/>
                  <container align="left" colcount="2">
                    <container colcount="1">
                      <container type="visibleGroup" visibleIf="[content/lineMultiRegionLayoutType/source] = '1'">
                        <static align="left" img="nms:line-region-type-1_guide.png"
                                label=" "/>
                      </container>
                      <container type="visibleGroup" visibleIf="[content/lineMultiRegionLayoutType/source] = '2'">
                        <static align="left" img="nms:line-region-type-2_guide.png"
                                label=" "/>
                      </container>
                      <container type="visibleGroup" visibleIf="[content/lineMultiRegionLayoutType/source] = '3'">
                        <static align="left" img="nms:line-region-type-3_guide.png"
                                label=" "/>
                      </container>
                      <container type="visibleGroup" visibleIf="[content/lineMultiRegionLayoutType/source] = '4'">
                        <static align="left" img="nms:line-region-type-4_guide.png"
                                label=" "/>
                      </container>
                      <container type="visibleGroup" visibleIf="[content/lineMultiRegionLayoutType/source] = '5'">
                        <static align="left" img="nms:line-region-type-5_guide.png"
                                label=" "/>
                      </container>
                      <container type="visibleGroup" visibleIf="[content/lineMultiRegionLayoutType/source] = '6'">
                        <static align="left" img="nms:line-region-type-6_guide.png"
                                label=" "/>
                      </container>
                      <container type="visibleGroup" visibleIf="[content/lineMultiRegionLayoutType/source] = '7'">
                        <static align="left" img="nms:line-region-type-7_guide.png"
                                label=" "/>
                      </container>
                      <container type="visibleGroup" visibleIf="[content/lineMultiRegionLayoutType/source] = '8'">
                        <static align="left" img="nms:line-region-type-8_guide.png"
                                label=" "/>
                      </container>
                    </container>
                    <container colcount="6">
                      <input align="left" checkedValue="1" label=" " type="radioButton"
                             xpath="content/lineMultiRegionLayoutType/source"/>
                      <static align="left" img="nms:line-region-type_1_thumb.png"
                              label=" "/>
                      <input align="left" checkedValue="2" label=" " type="radioButton"
                             xpath="content/lineMultiRegionLayoutType/source"/>
                      <static align="left" img="nms:line-region-type_2_thumb.png"
                              label=" "/>
                      <input align="left" checkedValue="3" label=" " type="radioButton"
                             xpath="content/lineMultiRegionLayoutType/source"/>
                      <static align="left" img="nms:line-region-type_3_thumb.png"
                              label=" "/>
                      <input align="left" checkedValue="4" label=" " type="radioButton"
                             xpath="content/lineMultiRegionLayoutType/source"/>
                      <static align="left" img="nms:line-region-type_4_thumb.png"
                              label=" "/>
                      <input align="left" checkedValue="5" label=" " type="radioButton"
                             xpath="content/lineMultiRegionLayoutType/source"/>
                      <static align="left" img="nms:line-region-type_5_thumb.png"
                              label=" "/>
                      <input align="left" checkedValue="6" label=" " type="radioButton"
                             xpath="content/lineMultiRegionLayoutType/source"/>
                      <static align="left" img="nms:line-region-type_6_thumb.png"
                              label=" "/>
                      <input align="left" checkedValue="7" label=" " type="radioButton"
                             xpath="content/lineMultiRegionLayoutType/source"/>
                      <static align="left" img="nms:line-region-type_7_thumb.png"
                              label=" "/>
                      <input align="left" checkedValue="8" label=" " type="radioButton"
                             xpath="content/lineMultiRegionLayoutType/source"/>
                      <static align="left" img="nms:line-region-type_8_thumb.png"
                              label=" "/>
                    </container>
                  </container>
                  <container colcount="1" type="visibleGroup" visibleIf="[content/lineMultiRegionLayoutType/source] = '1'">
                    <input label="地域 A のリンク URL" menuId="deliveryMenuBuilder" type="scriptEdit"
                           xpath="content/lineWebLinkA/source"/>
                  </container>
                  <container colcount="1" type="visibleGroup" visibleIf="[content/lineMultiRegionLayoutType/source] = '2'">
                    <input label="地域 A のリンク URL" menuId="deliveryMenuBuilder" type="scriptEdit"
                           xpath="content/lineWebLinkA/source"/>
                    <input label="地域 B のリンク URL" menuId="deliveryMenuBuilder" type="scriptEdit"
                           xpath="content/lineWebLinkB/source"/>
                  </container>
                  <container colcount="1" type="visibleGroup" visibleIf="[content/lineMultiRegionLayoutType/source] = '3'">
                    <input label="地域 A のリンク URL" menuId="deliveryMenuBuilder" type="scriptEdit"
                           xpath="content/lineWebLinkA/source"/>
                    <input label="地域 B のリンク URL" menuId="deliveryMenuBuilder" type="scriptEdit"
                           xpath="content/lineWebLinkB/source"/>
                  </container>
                  <container colcount="1" type="visibleGroup" visibleIf="[content/lineMultiRegionLayoutType/source] = '4'">
                    <input label="地域 A のリンク URL" menuId="deliveryMenuBuilder" type="scriptEdit"
                           xpath="content/lineWebLinkA/source"/>
                    <input label="地域 B のリンク URL" menuId="deliveryMenuBuilder" type="scriptEdit"
                           xpath="content/lineWebLinkB/source"/>
                    <input label="地域 C のリンク URL" menuId="deliveryMenuBuilder" type="scriptEdit"
                           xpath="content/lineWebLinkC/source"/>
                  </container>
                  <container colcount="1" type="visibleGroup" visibleIf="[content/lineMultiRegionLayoutType/source] = '5'">
                    <input label="地域 A のリンク URL" menuId="deliveryMenuBuilder" type="scriptEdit"
                           xpath="content/lineWebLinkA/source"/>
                    <input label="地域 B のリンク URL" menuId="deliveryMenuBuilder" type="scriptEdit"
                           xpath="content/lineWebLinkB/source"/>
                    <input label="地域 C のリンク URL" menuId="deliveryMenuBuilder" type="scriptEdit"
                           xpath="content/lineWebLinkC/source"/>
                    <input label="地域 D のリンク URL" menuId="deliveryMenuBuilder" type="scriptEdit"
                           xpath="content/lineWebLinkD/source"/>
                  </container>
                  <container colcount="1" type="visibleGroup" visibleIf="[content/lineMultiRegionLayoutType/source] = '6'">
                    <input label="地域 A のリンク URL" menuId="deliveryMenuBuilder" type="scriptEdit"
                           xpath="content/lineWebLinkA/source"/>
                    <input label="地域 B のリンク URL" menuId="deliveryMenuBuilder" type="scriptEdit"
                           xpath="content/lineWebLinkB/source"/>
                    <input label="地域 C のリンク URL" menuId="deliveryMenuBuilder" type="scriptEdit"
                           xpath="content/lineWebLinkC/source"/>
                  </container>
                  <container colcount="1" type="visibleGroup" visibleIf="[content/lineMultiRegionLayoutType/source] = '7'">
                    <input label="地域 A のリンク URL" menuId="deliveryMenuBuilder" type="scriptEdit"
                           xpath="content/lineWebLinkA/source"/>
                    <input label="地域 B のリンク URL" menuId="deliveryMenuBuilder" type="scriptEdit"
                           xpath="content/lineWebLinkB/source"/>
                    <input label="地域 C のリンク URL" menuId="deliveryMenuBuilder" type="scriptEdit"
                           xpath="content/lineWebLinkC/source"/>
                  </container>
                  <container colcount="1" type="visibleGroup" visibleIf="[content/lineMultiRegionLayoutType/source] = '8'">
                    <input label="地域 A のリンク URL" menuId="deliveryMenuBuilder" type="scriptEdit"
                           xpath="content/lineWebLinkA/source"/>
                    <input label="地域 B のリンク URL" menuId="deliveryMenuBuilder" type="scriptEdit"
                           xpath="content/lineWebLinkB/source"/>
                    <input label="地域 C のリンク URL" menuId="deliveryMenuBuilder" type="scriptEdit"
                           xpath="content/lineWebLinkC/source"/>
                    <input label="地域 D のリンク URL" menuId="deliveryMenuBuilder" type="scriptEdit"
                           xpath="content/lineWebLinkD/source"/>
                    <input label="地域 E のリンク URL" menuId="deliveryMenuBuilder" type="scriptEdit"
                           xpath="content/lineWebLinkE/source"/>
                    <input label="地域 F のリンク URL" menuId="deliveryMenuBuilder" type="scriptEdit"
                           xpath="content/lineWebLinkF/source"/>
                  </container>
                </container>
              </container>
              <container img="xtk:preview.png" label="プレビュー" name="Preview" notifyPathList="content/lineMessage/source"
                         visibleIf="[content/lineContentType/source] = 'text'" xpath="/delivery/content/linePreview/source">
                <container ref="nms:delivery:lib/content/Line/lineContentEditor/tabPreview"/>
              </container>
              <container applicableIf="HasPackage('nms:messageCenter')" img="nms:unknownad.png"
                         label="シードアドレス" visibleIf="[/ignored/@triggerMessage]=1">
                <container ref="nms:delivery:lib/proofTarget" xpath="/delivery"/>
              </container>
            </container>
            <leave>

              <if expr="HasPackage('nms:lineV2')">
                <copyElement exprDst="'/delivery/content/lineCustomFields/source'"
                             xpathSrc="/tmp/lineCustomFields"/>
              </if>
              <check expr="NodeCount([.])&lt;6">
                <error>1 つの配信で送信できるメッセージは最大 5 件です。</error>
              </check>
            </leave>
          </form>
        </input>
      </container>
    </container>
<!--[cf]-->

<!--[of]:iOS-->
    <container applicableIf="HasPackage('nms:mobileApp')" img="nms:ios.png" label="iOS のプッシュ"
               name="iOSDefinition" visibleIf="EV(@messageType, 'ios') and @deliveryMode!=0">
      <container label="レプリケートされた iOS 配信プロパティ" name="replicatediOSProperties" readOnly="true"
                 type="visibleGroup" visibleIf="[/ignored/@isACSConnector]">
        <container ref="nms:delivery:lib/content/commonReplicatedProperties"/>
      </container>
      <container label="iOS 配信プロパティ" name="iOSProperties" type="visibleGroup" visibleIf="[/ignored/@isACSConnector]==false">
        <container type="visibleGroup" visibleIf="[/ignored/@triggerMessage]!=1">
          <container label="iOS モバイルプッシュ" type="frame">
            <container colcount="2">
              <container ref="nms:delivery:lib/targetFrame"/>
              <input alwaysActive="true" lineCount="2" noBorder="true" nolabel="true"
                     readOnly="true" type="memo" xpath="/tmp/target"/>
            </container>
          </container>
        </container>

        <container name="notebook" type="contentEditor" xpath="content">
          <container img="nms:ios.png" label="コンテンツ" name="tabContent" readOnlyIf="[/tmp/@readOnly]">
            <container ref="nms:delivery:lib/content/iOS/iOSContentEditor/tabContent"/>
          </container>
          <container img="xtk:preview.png" label="プレビュー" name="tabPreview">
            <container ref="nms:delivery:lib/content/iOS/iOSContentEditor/tabPreview"/>
          </container>
          <container applicableIf="HasPackage('nms:messageCenter')" img="nms:unknownad.png"
                     label="シードアドレス" visibleIf="[/ignored/@triggerMessage]=1">
            <container ref="nms:delivery:lib/proofTarget" xpath="/delivery"/>
          </container>
        </container>
      </container>
    </container>
<!--[cf]-->
<!--[of]:Android-->
    <container applicableIf="HasPackage('nms:mobileApp')" img="nms:android.png" label="Android"
               name="androidDefinition" visibleIf="EV(@messageType, 'android') and @deliveryMode!=0">
      <container label="レプリケートされた Android 配信プロパティ" name="replicatedAndroidProperties"
                 readOnly="true" type="visibleGroup" visibleIf="[/ignored/@isACSConnector]">
        <container ref="nms:delivery:lib/content/commonReplicatedProperties"/>
      </container>
      <container label="Android 配信プロパティ" name="androidProperties" type="visibleGroup"
                 visibleIf="[/ignored/@isACSConnector]==false">
        <container type="visibleGroup" visibleIf="[/ignored/@triggerMessage]!=1">
          <container label="Android" type="frame">
            <container colcount="2">
              <container ref="nms:delivery:lib/targetFrame"/>
              <input alwaysActive="true" lineCount="2" noBorder="true" nolabel="true"
                     readOnly="true" type="memo" xpath="/tmp/target"/>
            </container>
          </container>
        </container>

        <container name="notebook" type="contentEditor" xpath="content">
          <container img="nms:android.png" label="コンテンツ" name="tabContent" readOnlyIf="[/tmp/@readOnly]">
            <container ref="nms:delivery:lib/content/android/androidContentEditor/tabContent"/>
          </container>
          <container img="xtk:preview.png" label="プレビュー" name="tabPreview">
            <container ref="nms:delivery:lib/content/android/androidContentEditor/tabPreview"/>
          </container>
          <container applicableIf="HasPackage('nms:messageCenter')" img="nms:unknownad.png"
                     label="シードアドレス" visibleIf="[/ignored/@triggerMessage]=1">
            <container ref="nms:delivery:lib/proofTarget" xpath="/delivery"/>
          </container>
        </container>
      </container>
    </container>
<!--[cf]-->

<!--[of]:Fax-->
    <container img="nms:fax.png" label="FAX" name="faxDefinition" visibleIf="EV(@messageType, 'fax') and @deliveryMode!=0">
      <container colcount="2" type="visibleGroup" visibleIf="[/ignored/@limitEdition]=false">
        <container ref="nms:delivery:lib/targetFrame"/>
        <input alwaysActive="true" lineCount="2" noBorder="true" nolabel="true" readOnly="true"
               type="memo" xpath="/tmp/target"/>
      </container>

      <container type="visibleGroup" visibleIf="[/ignored/@limitEdition]=false">
        <container label="コンテンツ" type="frame" xpath="content">
          <input xpath="@hasPdf"/>
          <container type="visibleGroup" visibleIf="@hasPdf">
            <input label="タイプ" xpath="@pdfType"/>
            <input label="圧縮を有効にする" xpath="@pdfCompression"/>
          </container>
        </container>
      </container>

      <container name="notebook" propagateConstraints="false" type="contentEditor"
                 xpath="content/text/source">
        <container label="テキストコンテンツ" name="tabText" readOnlyIf="[/tmp/@readOnly] or ([/ignored/@limitEdition] and [/ignored/@contentStatus]!=10)">
          <input fullToolbar="true" htmlMode="false" name="ctSource" nolabel="true"
                 type="htmlSource" xpath="." xpathInsert="/ignored/customizeFaxContent">
            <container>
              <input menuId="deliveryMenuBuilder" type="customizeBtn" xpath="/ignored/customizeFaxContent"/>
            </container>
          </input>
        </container>
        <container label="テキストプレビュー" name="tabPreview">
          <input name="previewToolbar" type="toolbarCtrl"/>
          <static type="separator"/>
          <input label="データ読み込み..." nolabel="true" prebuildSubForm="false" type="subFormLink"
                 xpath="/tmp/rcpQryResult">
            <form label="プレビュー用に読み込まれた受信者のデータ">
              <input nolabel="true" readOnly="true" type="SourceEdit" xpath="queryResult"/>
            </form>
          </input>
          <container ref="nms:delivery:lib/content/Preview/body" xpath=".."/>
        </container>

        <container label="PDF コンテンツ" ref="nms:delivery:edit/paperDefinition/paperContent/PDFSimple/editPDFFile"
                   visibleIf="EV([../@pdfType], 'simple') AND [../@hasPdf]" xpath="../../pdf[1]"/>

        <container label="PDF コンテンツ" ref="nms:delivery:edit/paperDefinition/paperContent/PDFMultiple"
                   xpath="../../.."/>

      </container>

    </container>
<!--[cf]-->
<!--[of]:Other (no execution)-->
    <container img="nms:miniatures/other.png" label="その他" name="otherDefinition"
               visibleIf="EV(@deliveryMode, 'descriptive')" xpathEnum="@messageType">
      <container label="配信ターゲット母集団" type="frame">
        <container ref="nms:delivery:lib/deliveryMapping" xpath="mapping"/>
      </container>
      <container label="説明" type="frame">
        <input xpath="@nature"/>
        <input xpath="desc"/>
      </container>
    </container>
<!--[cf]-->
<!--[of]:Leads-->
    <container applicableIf="HasPackage('crm:lead')" img="crm:lead.png" label="リード"
               name="leads" ref="crm:common:leads" visibleIf="@FCP=0"/>
<!--[cf]-->
<!--[of]:Broadlogs-->
    <container img="nms:broadLog.png" label="配信" name="broadLog" visibleIf="@state &gt;= EVal(@state, 'ready') and EV(@deliveryMode, 'descriptive')=false and [validation/@sandboxMode]!=2">
      <container type="visibleGroup" visibleIf="EV([mapping/storage/@exclusionType], 'other')">
        <container type="notebook">
          <container label="ログ">
            <input enumImage="@status" hideEditButtons="true" img="nms:broadLog.png"
                   nolabel="true" refresh="true" toolbarCaption="配信ログ" type="dynamicLinkList"
                   xpath="." xpathId="/ignored/@selectedMessage" xpathObjectSchema="mapping/@targetSchema"
                   xpathSchema="mapping/storage/@broadLogSchema">
              <input xpath="@lastModified"/>
              <input xpath="@status"/>
              <input xpath="msg/@failureReason"/>
              <input xpath="@address"/>
              <input xpath="msg/@text"/>
              <orderBy>
                <node expr="@lastModified" sortDesc="true"/>
              </orderBy>
            </input>
          </container>
          <container label="除外">
            <input enumImage="@status" hideEditButtons="true" img="nms:excludeLog.png"
                   nolabel="true" refresh="true" toolbarCaption="除外ログ" type="dynamicLinkList"
                   xpath="." xpathId="/ignored/@selectedMessage" xpathObjectSchema="mapping/@targetSchema"
                   xpathSchema="mapping/storage/@broadLogExclSchema">
              <input xpath="@lastModified"/>
              <input xpath="@status"/>
              <input xpath="msg/@failureReason"/>
              <input xpath="@address"/>
              <input xpath="msg/@text"/>
              <orderBy>
                <node expr="@lastModified" sortDesc="true"/>
              </orderBy>
            </input>
          </container>
        </container>
      </container>
      <container type="visibleGroup" visibleIf="EV([mapping/storage/@exclusionType], 'other')==false">
        <input enumImage="@status" hideEditButtons="true" img="nms:broadLog.png"
               nolabel="true" refresh="true" toolbarCaption="配信ログ" type="dynamicLinkList"
               xpath="." xpathId="/ignored/@selectedMessage" xpathObjectForm="/ignored/@dynamicLinkListObjectForm"
               xpathObjectSchema="/ignored/@dynamicLinkListObjectSchema" xpathSchema="/ignored/@dynamicLinkListSchema">
          <input xpath="@lastModified"/>
          <input xpath="@status"/>
          <input xpath="msg/@failureReason"/>
          <input xpath="@address"/>
          <input xpath="msg/@text"/>
          <orderBy>
            <node expr="@lastModified" sortDesc="true"/>
          </orderBy>
        </input>
      </container>
      <container type="visibleGroup" visibleIf="(@messageType=0 OR @messageType=1 OR @messageType=41 OR @messageType=42) and EV(@deliveryMode, 'external') == false">
        <container type="visibleGroup" visibleIf="EV([mailParameters/@needMirrorPage], 'fromMsgId', 'yes')">
          <container colcount="2" enabledIf="[/ignored/@selectedMessage] != ''" type="enabledGroup">
            <input discardReadOnly="true" img="xtk:html.png" label="このメッセージのミラーページを表示..."
                   prebuildSubForm="false" type="subFormLink" xpath=".">
              <form img="xtk:html.png" label="選択したメッセージのミラーページコンテンツ">
                <enter>
                  <soapCall name="GetMirrorURL" service="nms:delivery">
                    <param exprIn="@id" type="int"/>
                    <param exprIn="[/ignored/@selectedMessage]" type="string"/>
                    <param type="string" xpathOut="/ignored/@mirrorPageUrl"/>
                  </soapCall>
                </enter>
                <input type="browser" urlMode="true" xpath="/ignored/@mirrorPageUrl"/>
              </form>
            </input>
            <container type="visibleGroup" visibleIf="EV([mailParameters/@needMirrorPage], 'yes')">
              <static type="warning">ミラーページの読み込みには時間がかかる場合があります。</static>
            </container>
          </container>
        </container>
      </container>
    </container>
<!--[cf]-->
<!--[of]:Forecastlogs-->
    <container img="nms:broadLog.png" label="ターゲット" name="forecastLog" visibleIf="EV(@state, 'targetReady', 'messagePrepPending') OR (EV(@state, 'preparationError') AND @analysisStep&gt;4)">
      <input alwaysActive="true" expr="'temp:broadCast:' + @id" type="expr" xpath="/ignored/@querySchemaExec"/>
      <input propagateXPathToCtx="/ignored/@querySchemaExec|/@querySchemaExec" type="forecastLogList"
             xpath="@id">
        <input xpath="@failureReason"/>
        <input xpath="@address"/>
        <input xpath="typologyRule"/>
        <input xpath="@line1"/>
        <input xpath="@line2"/>
        <input xpath="@line3"/>
      </input>
    </container>
<!--[cf]-->
<!--[of]:Tracking-->
    <container img="nms:tracking.png" label="トラッキング" name="trackingLog" visibleIf="(([tracking/@enabled] AND (@state &gt; EVal(@state, 'messageReady')) OR EV(@messageType, 'other')) and [validation/@sandboxMode]!=2) OR [/ignored/@isACSConnector]">
      <container type="notebook">
        <container label="ログ">
          <input hideEditButtons="true" img="nms:tracking.png" nolabel="true" refresh="true"
                 toolbarCaption="配信のトラッキングログ" type="dynamicLinkList" xpath="." xpathObjectForm="/ignored/@dynamicLinkListObjectForm"
                 xpathObjectSchema="/ignored/@dynamicLinkListObjectSchema" xpathSchema="mapping/storage/@trackingLogSchema"
                 zoom="true">
            <input xpath="@logDate"/>
            <input xpath="url/@label"/>
            <input xpath="url/@type"/>
            <input xpathObjectSchema="/ignored/@dynamicLinkListObjectSchema"/>
            <orderBy>
              <node expr="@logDate" sortDesc="true"/>
            </orderBy>
          </input>
        </container>

    <!-- URLs -->
        <container label="URL" name="url" visibleIf="[tracking/@enabled]">
          <input hideEditButtons="true" nolabel="true" toolbarCaption="トラッキングされる URL"
                 type="linklist" xpath="trackingUrl" zoom="true">
            <input xpath="@label"/>
            <input xpath="@type"/>
            <input xpath="@source"/>
          </input>
        </container>
      </container>
    </container>
<!--[cf]-->
<!--[of]:Propositions-->
    <container applicableIf="HasPackage('nms:coreInteraction')" img="nms:proposition.png"
               label="オファー" name="proposition" visibleIf="@state &gt;= EVal(@state, 'ready') and [@offerSpace-id]!=0 and [validation/@sandboxMode]!=2">
      <input hideEditButtons="true" img="nms:proposition.png" nolabel="true" refresh="true"
             toolbarCaption="配信によって生まれた提案" type="dynamicLinkList" xpath="." xpathSchema="offerSpace/env/@propositionSchema">
        <input xpath="@eventDate"/>
        <input xpath="offerSpace"/>
        <input xpath="offer"/>
        <input xpath="@rank"/>
        <input xpath="@status"/>
        <orderBy>
          <node expr="@eventDate" sortDesc="true"/>
        </orderBy>
        <sysFilter>
          <condition expr="[broadLog/@delivery-id]=$(@id)"/>
        </sysFilter>
      </input>
    </container>
<!--[cf]-->

<!--[of]:Rendering-->
    <container applicableIf="HasPackage('nms:deliverability')" img="nms:world.png"
               label="受信ボックスレンダリング" name="rendering" visibleIf="EV(@messageType, 'mail') and EV(@deliveryMode, 'external') == false">
      <input sessionToken="true" type="urlViewer" urlExpr="$(serverUrl)+'/nms/inboxRendering.jssp?did='+ @id + '&amp;cuid='+ getOption('DmRendering_cuid')"/>
    </container>
<!--[cf]-->
<!--[of]:Journal-->
    <container img="xtk:logs.png" label="監査" name="jobLog" visibleIf="EV(@deliveryMode, 'descriptive')=false and [/ignored/@isACSConnector]==false">
      <container type="notebook">
        <container label="ログ">
          <input enumImage="@logType" hideEditButtons="true" img="xtk:logs.png" nolabel="true"
                 refresh="true" toolbarCaption="配信のログ内のメッセージ" type="linkList" xpath="log">
            <input xpath="@logDate"/>
            <input xpath="@message"/>
            <orderBy>
              <node expr="@id" sortDesc="true"/>
            </orderBy>
          </input>
        </container>
        <container label="除外の原因" visibleIf="[/ignored/@triggerMessage]!=1">
          <input hideEditButtons="true" img="xtk:reject.png" nolabel="true" refresh="true"
                 toolbarCaption="除外されたメッセージのボリュームと原因" type="linkList" xpath="dlvExclusion"
                 zoom="false">
            <input xpath="@count"/>
            <input xpath="typologyRule"/>
          </input>
        </container>
        <container label="配達確認" name="fcpList" visibleIf="@FCP=0">
          <input disableDefaultFilter="true" enumImage="@state" hideEditButtons="true"
                 img="nms:bat.png" nolabel="true" refresh="true" toolbarCaption="配信の配達確認のコピー"
                 type="linkList" xpath="proof" zoom="true">
            <input xpath="@label"/>
            <input xpath="properties/@toDeliver"/>
            <input xpath="indicators/@processed"/>
            <input xpath="indicators/@success"/>
          </input>
        </container>
        <container applicableIf="hasPackage('nms:campaign')" label="承認" visibleIf="@FCP=0 and hasPackage('nms:campaign') and [/ignored/@useValidation] and @isModel=false">
          <container colspan="2" readOnlyIf="HasNamedRight('approvalAdministration')=false or @state &gt; Eval(@state, 'ready')"
                     type="readOnlyGroup">
            <container type="visibleGroup" visibleIf="EV(@targetStatus, 'inWaiting') or EV(@contentStatus, 'inWaiting', 'available', 'fcpInWaiting', 'inProgress', 'externalInWaiting') or                               EV(@budgetStatus, 'inWaiting') or EV(@extractionStatus, 'inWaiting') or EV(@sandboxStatus, 'inWaiting')">
              <static img="nl:smallcalendar.png" label="処理スケジュール" type="separator"/>
              <input lineCount="6" nolabel="true" notitle="true" type="treeEdit">
                <container label="スケジュール">
                  <input img="nl:smallcalendar.png" visibleIf="[scheduling/@expectedTarget]!='' and (EV(@targetStatus, 'inWaiting'))"
                         xpath="scheduling/@expectedTarget"/>
                  <input img="nms:alarmon.png" visibleIf="[scheduling/@reminderTarget]!='' and (EV(@targetStatus, 'inWaiting'))"
                         xpath="scheduling/@reminderTarget"/>
                  <input img="nl:smallcalendar.png" visibleIf="[scheduling/@expectedContent]!='' and (EV(@contentStatus, 'inWaiting', 'available', 'externalRefused')) or ((EV(@contentStatus, 'refused') and [validation/@assignEdition]=false))"
                         xpath="scheduling/@expectedContent"/>
                  <input img="nms:alarmon.png" visibleIf="[scheduling/@reminderContent]!='' and (EV(@contentStatus, 'inWaiting', 'available', 'externalRefused')) or ((EV(@contentStatus, 'refused') and [validation/@assignEdition]=false))"
                         xpath="scheduling/@reminderContent"/>
                  <input img="nl:smallcalendar.png" visibleIf="[scheduling/@expectedBudget]!='' and (EV(@budgetStatus, 'inWaiting'))"
                         xpath="scheduling/@expectedBudget"/>
                  <input img="nms:alarmon.png" visibleIf="[scheduling/@reminderBudget]!='' and (EV(@budgetStatus, 'inWaiting'))"
                         xpath="scheduling/@reminderBudget"/>
                  <input img="nl:smallcalendar.png" visibleIf="[scheduling/@expectedExtraction]!='' and (EV(@extractionStatus, 'inWaiting'))"
                         xpath="scheduling/@expectedExtraction"/>
                  <input img="nms:alarmon.png" visibleIf="[scheduling/@reminderExtraction]!='' and (EV(@extractionStatus, 'inWaiting'))"
                         xpath="scheduling/@reminderExtraction"/>
                  <input img="nl:smallcalendar.png" visibleIf="[scheduling/@expectedFCP]!='' and (EV(@contentStatus, 'fcpInWaiting'))"
                         xpath="scheduling/@expectedFCP"/>
                  <input img="nms:alarmon.png" visibleIf="[scheduling/@reminderFCP]!='' and (EV(@contentStatus, 'fcpInWaiting'))"
                         xpath="scheduling/@reminderFCP"/>
                  <input img="nl:smallcalendar.png" visibleIf="[scheduling/@expectedForecast]!='' and (EV(@sandboxStatus, 'inWaiting'))"
                         xpath="scheduling/@expectedForecast"/>
                  <input img="nms:alarmon.png" visibleIf="[scheduling/@reminderForecast]!='' and (EV(@sandboxStatus, 'inWaiting'))"
                         xpath="scheduling/@reminderForecast"/>
                  <input img="nl:smallcalendar.png" visibleIf="[scheduling/@expectedEdition]!='' and (EV(@contentStatus, 'inProgress')) and [validation/@assignEdition]"
                         xpath="scheduling/@expectedEdition"/>
                  <input img="nms:alarmon.png" visibleIf="[scheduling/@reminderEdition]!='' and (EV(@contentStatus, 'inProgress')) and [validation/@assignEdition]"
                         xpath="scheduling/@reminderEdition"/>
                  <input img="nl:smallcalendar.png" visibleIf="[scheduling/@expectedExternal]!='' and (EV(@contentStatus, 'externalInWaiting')) and [validation/@externalValidation]"
                         xpath="scheduling/@expectedExternal"/>
                  <input img="nms:alarmon.png" visibleIf="[scheduling/@reminderExternal]!='' and (EV(@contentStatus, 'externalInWaiting')) and [validation/@externalValidation]"
                         xpath="scheduling/@reminderExternal"/>
                </container>
              </input>
            </container>
          </container>
          <input colspan="2" disableDefaultFilter="true" enumImage="@action" hideEditButtons="true"
                 img="nms:validation.png" nolabel="true" refresh="true" toolbarCaption="承認ログ"
                 type="linklist" xpath="validationLog" zoom="true">
            <input xpath="@date"/>
            <input xpath="@action"/>
            <input xpath="@type"/>
            <input xpath="validatedBy"/>
            <input xpath="comment"/>
            <orderBy>
              <node expr="@date" sortDesc="true"/>
            </orderBy>
          </input>
        </container>
        <container label="SQL ログ" name="sql" visibleIf="[advancedParameters/@showSQL]">
          <input nolabel="true" readOnly="true" type="jobLogSQLEdit" xpath="@id"/>
        </container>
      </container>
    </container>
<!--[cf]-->

  </container>
<!--[cf]-->
<!--[of]:Leave-->
  <leave name="leave">

    <if expr="[targets/@deliveryLimit]&gt;0 and [targets/@useDeliveryLimit]=false">
      <set value="true" xpath="targets/@useDeliveryLimit"/>
    </if>
    <if expr="[targets/@deliveryLimit]=0 and [targets/@useDeliveryLimit]=true">
      <set value="false" xpath="targets/@useDeliveryLimit"/>
    </if>

    <if expr="[targets/proofTarget/@nonEmpty]=false">
    <!-- Check with other fcp parameters to define if fcp target is empty -->
      <set expr="iif (NodeCount([fcpParameters/substitution]) &gt; 0 or NodeCount([fcpParameters/seedList/where/condition]) &gt; 0 or NodeCount(FCPSeed) &gt; 0, true, false)"
           xpath="targets/proofTarget/@nonEmpty"/>
    </if>

  <!-- Create job from process folder, need to apply the same folder key -->
    <if expr="[/tmp/processId]!=0 AND [/tmp/processId]!=''">
      <set expr="[/tmp/processId]" xpath="@folder-id"/>
    </if>

    <if expr="@isModel and [tracking/@enabled] and (EV(@deliveryMode, 'external') or EV(@deliveryMode, 'descriptive'))">
    <!-- Make sure tracking is disabled for external/descriptive delivery mode (due to change of default value which is now true) -->
      <set value="false" xpath="tracking/@enabled"/>
    </if>

    <check expr="[@folder-id]!=0">
      <error>配信フォルダーを指定する必要があります。</error>
    </check>

    <if expr="HasPackage('nms:campaign')">
      <set expr="[@linkedDelivery-id]" xpath="/ignored/@_LinkDeliveryId"/>

      <if expr="@isModel=false and [@budget-id]!=0 and [/ignored/@useBudget]">
        <set value="0" xpath="/ignored/@_propagateBudget"/>
        <if expr="HasPackage('nms:response')">
          <set expr="[/ignored/@totalRealized]!=[budgetParameters/@totalRealized] or [/ignored/@totalMargin]!=[budgetParameters/@totalMargin]"
               xpath="/ignored/@_propagateBudget"/>
        </if>
        <if expr="[/ignored/@_propagateBudget] or                 [/ignored/@realCost]!=[budgetParameters/@realCost] or                 [/ignored/@estimatedCost]!=[budgetParameters/@estimatedCost] or                 [/ignored/@budgetId]!=[@budget-id] or                 [/ignored/@commitmentLevel]!=[budgetParameters/@commitmentLevel]">
          <set value="1" xpath="budgetParameters/@computationState"/>
          <set value="true" xpath="/ignored/@calculateBudget"/>
          <set expr="[@budget-id]" xpath="/ignored/@budgetId"/>
          <set expr="[budgetParameters/@estimatedCost]" xpath="/ignored/@estimatedCost"/>
          <set expr="[budgetParameters/@realCost]" xpath="/ignored/@realCost"/>
          <set expr="[budgetParameters/@commitmentLevel]" xpath="/ignored/@commitmentLevel"/>
          <if expr="HasPackage('nms:response')">
            <set expr="[budgetParameters/@totalMargin]" xpath="/ignored/@totalMargin"/>
            <set expr="[budgetParameters/@totalRealized]" xpath="/ignored/@totalRealized"/>
          </if>
        </if>
      </if>
      <if expr="[/tmp/@hasDateExpr]=false">
        <set value="" xpath="scheduling/@extractionExpr"/>
        <set value="" xpath="scheduling/@contactDateExpr"/>
      </if>
      <if expr="[/tmp/@hasDeliveryLimitExpr]=false">
        <set value="" xpath="targets/@deliveryLimitExpr"/>
      </if>

    </if>

    <if expr="@isModel=false and [/ignored/@_LinkDeliveryId]=0 and HasPackage('nms:campaign')">
      <check expr="[scheduling/@extraction]='' or [scheduling/@contactDate]='' or [scheduling/@contactDate]&gt;[scheduling/@extraction] or ([/tmp/@hasDateExpr] and ([/ignored/@extractionExpr]!='' or [/ignored/@contactDateExpr]!=''))">
        <error>抽出日はコンタクト日より後にしてください。</error>
      </check>
      <check expr="[scheduling/@extraction] != '' or ([/tmp/@hasDateExpr] and [/ignored/@extractionExpr] != '') or [scheduling/@delayExtraction]=0">
        <error>抽出待機期間を適用するには抽出日が必要です。</error>
      </check>
    </if>

  <!-- Reset publication status so that the delivery appears "in edition" -->
    <if expr="[/ignored/@triggerMessage]">
      <set value="1" xpath="/delivery/triggerMessage/@publicationStatus"/>
    </if>
  <!-- Save content of notificationCustomFields in the delivery -->
    <if expr="HasPackage('nms:mobileApp')">
      <copyElement exprDst="'/delivery/content/' + Iif(@messageType=41, 'ios', 'android') + 'CustomFields/source'"
                   xpathSrc="/tmp/notificationCustomFields"/>
      <copyElement exprDst="'/delivery/content/' + Iif(@messageType=41, 'ios', 'android') + 'AvailableSounds/source'"
                   xpathSrc="/tmp/notificationSounds"/>
    </if>
  <!--modified for Line-->
    <if expr="HasPackage('nms:lineV2')">
      <copyElement exprDst="'/delivery/content/lineCustomFields/source'" xpathSrc="/tmp/lineCustomFields"/>
    </if>

  <!-- Save content of offerSpace in the delivery -->
    <if expr="HasPackage('nms:coreInteraction')">
      <copyElement xpathDst="/delivery/offerSpace" xpathSrc="/ignored/offerSpace"/>
    </if>

  </leave>
<!--[cf]-->
<!--[of]:PostSave-->
  <postSave>
    <if expr="HasPackage('nms:campaign')">
      <if expr="[/ignored/@calculateBudget]">
      <!-- change computation state to calculate -->
      <!-- need to write it immediatly because it is modified from external budget workflow -->
        <set value="nms:delivery" xpath="/ignored/writer/delivery/@xtkschema"/>
        <set value="update" xpath="/ignored/writer/delivery/@_operation"/>
        <set expr="@id" xpath="/ignored/writer/delivery/@id"/>
        <set value="1" xpath="/ignored/writer/delivery/budgetParameters/@computationState"/>
        <soapCall name="Write" service="xtk:persist">
          <param exprIn="[/ignored/writer/delivery]" type="DOMDocument"/>
        </soapCall>

      <!-- Budget parameters has been modified, launch the cost computation -->
        <soapCall name="WakeupTask" service="xtk:workflow">
          <param exprIn="'budgetMgt'" type="string"/>
          <param exprIn="''" type="string"/>
          <param exprIn="'scheduler'" type="string"/>
        </soapCall>

        <set value="false" xpath="/ignored/@calculateBudget"/>
      </if>
    </if>

    <if expr="EV(@deliveryMode, 'external') and [/ignored/@extraction]!=[scheduling/@extraction]">
    <!-- Push event to start preparation of messages -->
      <soapCall name="WakeupTask" service="xtk:workflow">
        <param exprIn="'operationMgt'" type="string"/>
        <param exprIn="''" type="string"/>
        <param exprIn="'scheduler'" type="string"/>
      </soapCall>
      <set expr="[scheduling/@extraction]" xpath="/ignored/@extraction"/>
    </if>
  </postSave>
<!--[cf]-->

</form>
